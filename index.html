<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/auto.xml" title="Linux知识库" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="Linux知识库">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Linux知识库">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux知识库">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Linux知识库</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
	
	<a href="https://github.com/xiejia1215225"><img style="position: absolute; top: 0; right: 0; border: 0
	;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Linux知识库</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/linux kernel/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/linux kernel/" itemprop="url">linux kernel</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:48:49+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="kernel-introduce"><a href="#kernel-introduce" class="headerlink" title="kernel introduce"></a>kernel introduce</h1><p>    内核是操作系统的核心，掌控着所有硬件设备的控制权。也就是说，你所希望计算机帮你完成的各项工作，都需要通过内核的帮助才能完成。内核可以分为以下几种设计流派：</p>
<blockquote>
<p>单内核(monolithic kernel)： Linux<br>把所有功能集成于同一个程序<br>微内核(micro kernel)：Windows, Solaris<br>每种功能使用一个单独子系统实现内核</p>
</blockquote>
<ul>
<li><p>Linux内核特点：</p>
<blockquote>
<p>支持模块化：.ko（内核对象）<br>如：文件系统，硬件驱动，网络协议等<br>支持内核模块的动态装载和卸载</p>
</blockquote>
</li>
<li><p>组成部分：</p>
<blockquote>
<p>核心文件：/boot/vmlinuz-VERSION-release<br>ramdisk：辅助的伪根系统</p>
<blockquote>
<p>CentOS 5: /boot/initrd-VERSION-release.img<br>CentOS 6,7: /boot/initramfs-VERSION-release.img</p>
</blockquote>
</blockquote>
</li>
</ul>
<blockquote>
<p>模块文件：/lib/modules/VERSION-release</p>
</blockquote>
<ul>
<li>kernel</li>
</ul>
<blockquote>
<p>自身初始化<br>检测可识别到的所有硬件设备<br>加载硬件驱动程序（借助于ramdisk加载驱动）<br>以只读方式挂载根文件系统<br>运行用户空间的第一个应用程序：/sbin/init启动流程</p>
</blockquote>
<h1 id="ramdisk："><a href="#ramdisk：" class="headerlink" title="ramdisk："></a>ramdisk：</h1><p>内核中的特性之一：使用缓冲和缓存来加速对磁盘上的文件访问，并加载相应的硬件驱动</p>
<p>CentOS 5: initrd</p>
<blockquote>
<p>工具程序：mkinitrd<br>CentOS 6，7: initramfs<br>工具程序：mkinitrd, dracut</p>
</blockquote>
<p>ramdisk文件的制作</p>
<ol>
<li><p>mkinitrd命令<br> 为当前正在使用的内核重新制作ramdisk文件</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)</span><br></pre></td></tr></table></figure>
</li>
<li><p>dracut命令<br> 为当前正在使用的内核重新制作ramdisk文件</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dracut /boot/initramfs-$(uname -r).img $(uname -r)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="内核版本"><a href="#内核版本" class="headerlink" title="内核版本"></a>内核版本</h1><h2 id="uname命令"><a href="#uname命令" class="headerlink" title="uname命令"></a>uname命令</h2><p>uname - print system information<br>uname [OPTION]…<br>-r: 显示VERSION-RELEASE<br>-n: 显示主机名<br>-a:显示所有信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#uname -r</span></span><br><span class="line">2.6.32-754.el6.x86_64</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#uname -n</span></span><br><span class="line">CentOS6.localdomain</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#uname -a</span></span><br><span class="line">Linux CentOS6.localdomain 2.6.32-754.el6.x86_64 <span class="comment">#1 SMP Tue Jun 19 21:26:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>
<p>uname -a 现实的内容依次为：</p>
<ul>
<li>Linux 操作系统类型</li>
<li>CentOS6.localdomain 操作系统的主机名</li>
<li>2.6.32-754.el6.x86_64 内核版本信息</li>
<li>#1 SMP Tue Jun 19 21:26:04 UTC 2018 内核的编译日期</li>
<li>x86_64 x86_64 x86_64 这三组分别是：操作系统版本、处理器类型、硬件平台</li>
<li>GNU/Linux 操作系统名称</li>
</ul>
<h1 id="proc目录"><a href="#proc目录" class="headerlink" title="/proc目录"></a>/proc目录</h1><p>该目录是系统与内核交互的一个伪文件系统接口，内核把自己内部状态信息及统计信息，以及可配置参数通过proc伪文件系统加以输出。</p>
<p>参数</p>
<blockquote>
<p>只读：输出信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@CentOS6 ~]<span class="comment">#cat /proc/sys/net/ipv4/icmp_echo_ignore_all </span></span><br><span class="line">&gt; 0</span><br><span class="line">&gt; [root@CentOS6 ~]<span class="comment">#ping 192.168.183.157</span></span><br><span class="line">&gt; PING 192.168.183.157 (192.168.183.157) 56(84) bytes of data.</span><br><span class="line">&gt; 64 bytes from 192.168.183.157: icmp_seq=1 ttl=64 time=0.074 ms</span><br><span class="line">&gt; 64 bytes from 192.168.183.157: icmp_seq=2 ttl=64 time=0.068 ms</span><br><span class="line">&gt; 64 bytes from 192.168.183.157: icmp_seq=3 ttl=64 time=0.069 ms</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>可写：可接受用户指定“新值”来实现对内核某功能或特性的配置,不支持编辑器编辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@CentOS6 ~]<span class="comment">#echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span></span><br><span class="line">&gt; [root@CentOS6 ~]<span class="comment">#cat /proc/sys/net/ipv4/icmp_echo_ignore_all</span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; [root@CentOS6 ~]<span class="comment">#ping -wl -c1 192.168.183.157</span></span><br><span class="line">&gt; PING 192.168.183.157 (192.168.183.157) 56(84) bytes of data.</span><br><span class="line">&gt; </span><br><span class="line">&gt; --- 192.168.183.157 ping statistics ---</span><br><span class="line">&gt; 1 packets transmitted, 0 received, 100% packet loss, time 10001ms</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys</span><br></pre></td></tr></table></figure>
<ol>
<li>echo命令通过重定向方式也可以修改大多数参数的值<br> echo “VALUE” &gt; /proc/sys/path/to/parameter<br> echo “websrv” &gt; /proc/sys/kernel/hostname</li>
<li>sysctl命令用于查看或设定此目录中诸多参数<br> sysctl -w path.to.parameter=VALUE<br> sysctl -w kernel.hostname=mail.magedu.com</li>
</ol>
<h1 id="sysctl命令"><a href="#sysctl命令" class="headerlink" title="sysctl命令"></a>sysctl命令</h1><p>默认配置文件：/etc/sysctl.conf</p>
<ol>
<li><p>设置某参数<br> sysctl -w parameter=VALUE</p>
</li>
<li><p>通过读取配置文件设置参数<br> sysctl -p [/path/to/conf_file]</p>
</li>
<li><p>查看所有生效参数<br> sysctl -a</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#sysctl -a |less</span></span><br><span class="line">kernel.sched_child_runs_first = 0</span><br><span class="line">kernel.sched_min_granularity_ns = 2000000</span><br><span class="line">kernel.sched_latency_ns = 10000000</span><br><span class="line">kernel.sched_wakeup_granularity_ns = 2000000</span><br><span class="line">kernel.sched_tunable_scaling = 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>常用的几个参数：<br> net.ipv4.ip_forward<br> net.ipv4.icmp_echo_ignore_all<br> vm.drop_caches</p>
</li>
</ol>
<h1 id="sys目录"><a href="#sys目录" class="headerlink" title="/sys目录"></a>/sys目录</h1><p>sysfs：为用户使用的伪文件系统，输出内核识别出的各硬件设备的相关属性信息，也有内核对硬件特性的设定信息；有些参数是可以修改的，用于调整硬件工作特性<br>udev通过此路径下输出的信息动态为各设备创建所需要设备文件，udev是运行用户空间程序<br>专用工具：udevadmin, hotplug<br>udev为设备创建设备文件时，会读取其事先定义好的规则文件，一般在/etc/udev/rules.d及/usr/lib/udev/rules.d目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">网卡</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat /etc/udev/rules.d/70-persistent-net.rules</span></span><br><span class="line"><span class="comment"># This file was automatically generated by the /lib/udev/write_net_rules</span></span><br><span class="line"><span class="comment"># program, run by the persistent-net-generator.rules rules file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can modify it, as long as you keep each rule on a single</span></span><br><span class="line"><span class="comment"># line, and change only the value of the NAME= key.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PCI device 0x8086:0x100f (e1000)</span></span><br><span class="line">SUBSYSTEM==<span class="string">"net"</span>, ACTION==<span class="string">"add"</span>, DRIVERS==<span class="string">"?*"</span>, ATTR&#123;address&#125;==<span class="string">"00:0c:29:bf:4b:56"</span>, ATTR&#123;<span class="built_in">type</span>&#125;==<span class="string">"1"</span>, KERNEL==<span class="string">"eth*"</span>, NAME=<span class="string">"eth0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PCI device 0x8086:0x100f (e1000)</span></span><br><span class="line">SUBSYSTEM==<span class="string">"net"</span>, ACTION==<span class="string">"add"</span>, DRIVERS==<span class="string">"?*"</span>, ATTR&#123;address&#125;==<span class="string">"00:0c:29:bf:4b:60"</span>, ATTR&#123;<span class="built_in">type</span>&#125;==<span class="string">"1"</span>, KERNEL==<span class="string">"eth*"</span>, NAME=<span class="string">"eth1"</span></span><br></pre></td></tr></table></figure>
<h1 id="内核模块管理"><a href="#内核模块管理" class="headerlink" title="内核模块管理"></a>内核模块管理</h1><h2 id="查看当前内核已经装载的模块-lsmod"><a href="#查看当前内核已经装载的模块-lsmod" class="headerlink" title="查看当前内核已经装载的模块 lsmod"></a>查看当前内核已经装载的模块 lsmod</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#lsmod</span></span><br><span class="line">Module                  Size  Used by</span><br><span class="line">rfcomm                 71207  4 </span><br><span class="line">sco                    17589  2 </span><br><span class="line">bridge                 85770  0 </span><br><span class="line">bnep                   16370  2 </span><br><span class="line">l2cap                  54498  16 rfcomm,bnep</span><br><span class="line">autofs4                27000  3 </span><br><span class="line">8021q                  20507  0 </span><br><span class="line">garp                    7184  1 8021q</span><br><span class="line">stp                     2218  2 bridge,garp</span><br><span class="line">llc                     5450  3 bridge,garp,stp</span><br><span class="line">ipt_REJECT              2383  2 </span><br><span class="line">nf_conntrack_ipv4       9218  2 </span><br><span class="line">...省略...</span><br></pre></td></tr></table></figure>
<h2 id="查看内核模块的文件-proc-modules"><a href="#查看内核模块的文件-proc-modules" class="headerlink" title="查看内核模块的文件/proc/modules"></a>查看内核模块的文件/proc/modules</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#cat /proc/modules </span></span><br><span class="line">rfcomm 71207 4 - Live 0xffffffffa05fd000</span><br><span class="line">sco 17589 2 - Live 0xffffffffa05f3000</span><br><span class="line">bridge 85770 0 - Live 0xffffffffa05d5000</span><br><span class="line">bnep 16370 2 - Live 0xffffffffa05cd000</span><br><span class="line">l2cap 54498 16 rfcomm,bnep, Live 0xffffffffa05b9000</span><br><span class="line">autofs4 27000 3 - Live 0xffffffffa05ad000</span><br><span class="line">8021q 20507 0 - Live 0xffffffffa05a2000</span><br><span class="line">garp 7184 1 8021q, Live 0xffffffffa059c000</span><br><span class="line">stp 2218 2 bridge,garp, Live 0xffffffffa0598000</span><br><span class="line">llc 5450 3 bridge,garp,stp, Live 0xffffffffa0592000</span><br><span class="line">ipt_REJECT 2383 2 - Live 0xffffffffa0567000</span><br><span class="line">nf_conntrack_ipv4 9218 2 - Live 0xffffffffa0560000</span><br><span class="line">nf_defrag_ipv4 1483 1 nf_conntrack_ipv4, Live 0xffffffffa055c000</span><br><span class="line">...省略...</span><br></pre></td></tr></table></figure>
<h2 id="查看模块的详细描述信息-modinfo"><a href="#查看模块的详细描述信息-modinfo" class="headerlink" title="查看模块的详细描述信息 modinfo"></a>查看模块的详细描述信息 modinfo</h2><p>modinfo [ -k kernel ] [ modulename|filename… ]<br>-n：只显示模块文件路径<br>-p：显示模块参数<br>-a：作者<br>-d：描述</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#modinfo xfs</span></span><br><span class="line">filename:       /lib/modules/2.6.32-754.el6.x86_64/kernel/fs/xfs/xfs.ko</span><br><span class="line">license:        GPL</span><br><span class="line">description:    SGI XFS with ACLs, security attributes, large block/inode numbers, no debug enabled</span><br><span class="line">author:         Silicon Graphics, Inc.</span><br><span class="line">retpoline:      Y</span><br><span class="line">srcversion:     032C69ECC93FCBD7B47F691</span><br><span class="line">depends:        exportfs</span><br><span class="line">vermagic:       2.6.32-754.el6.x86_64 SMP mod_unload modversions</span><br></pre></td></tr></table></figure>
<h2 id="内核模块装载或卸载-modprobe"><a href="#内核模块装载或卸载-modprobe" class="headerlink" title="内核模块装载或卸载 modprobe"></a>内核模块装载或卸载 modprobe</h2><p>装载模块：modprobe MOD_NAME (注意这里会自动解决模块间的依赖关系)<br>卸载模块：modprobe -r modulename</p>
<h2 id="手动实现模块文件的装载和卸载"><a href="#手动实现模块文件的装载和卸载" class="headerlink" title="手动实现模块文件的装载和卸载"></a>手动实现模块文件的装载和卸载</h2><p>insmod命令：insmod /path/to/module_file(注意这里不会自动解决模块间的依赖关系)<br>rmmod命令:rmmod MOD_NAME</p>
<h1 id="编译内核"><a href="#编译内核" class="headerlink" title="编译内核"></a>编译内核</h1><h2 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h2><ol>
<li><p>准备好开发环境</p>
</li>
<li><p>获取目标主机上硬件设备的相关信息</p>
</li>
<li><p>获取目标主机系统功能的相关信息<br> 例如:需要启用相应的文件系统</p>
</li>
<li><p>获取内核源代码包</p>
<p><a href="http://www.kernel.org" target="_blank" rel="noopener">www.kernel.org</a></p>
<h2 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a>开发环境准备</h2></li>
<li><p>包组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Development Tools</span><br><span class="line">ncurses-devel</span><br><span class="line">elfutils-libelf-devel</span><br><span class="line">openssl-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>目标主机硬件设备相关信息</p>
</li>
</ol>
<p>CPU：</p>
<blockquote>
<p>cat /proc/cpuinfo<br>x86info -a<br>lscpu</p>
</blockquote>
<p>PCI设备：</p>
<blockquote>
<p>lspci</p>
<blockquote>
<p>-v<br>-vv</p>
</blockquote>
</blockquote>
<blockquote>
<p>lsusb</p>
<blockquote>
<p>-v<br>-vv</p>
</blockquote>
</blockquote>
<blockquote>
<p>lsblk 块设备</p>
</blockquote>
<p>3.了解全部硬件设备信息<br>hal-device：CentOS 6</p>
<h2 id="内核编译安装系统"><a href="#内核编译安装系统" class="headerlink" title="内核编译安装系统"></a>内核编译安装系统</h2><ul>
<li><p>安装开发包组</p>
</li>
<li><p>下载源码文件</p>
</li>
<li>.config：准备文本配置文件</li>
<li>make menuconfig：配置内核选项</li>
<li>make [-j #]</li>
<li>make modules_install：安装模块</li>
<li>make install: 安装内核相关文件</li>
<li>​安装bzImage为/boot/vmlinuz-VERSION-RELEASE</li>
<li>​生成initramfs文件</li>
<li>​编辑grub的配置文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">编译安装内核示例</span><br><span class="line">tar xf linux-3.10.67.tar.xz -C /usr/src</span><br><span class="line"><span class="built_in">cd</span> /usr/src/linux-3.10.67 </span><br><span class="line">cp /boot/config-$(uname -r) ./.config</span><br><span class="line">make <span class="built_in">help</span>  </span><br><span class="line">make menuconfig  </span><br><span class="line">make -j 2  </span><br><span class="line">make modules_install</span><br><span class="line">make install  </span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h2 id="卸载内核"><a href="#卸载内核" class="headerlink" title="卸载内核"></a>卸载内核</h2><ul>
<li>make clean：清理大多数编译生成的文件，但会保留config文件等</li>
<li>make mrproper: 清理所有编译生成的文件、 config及某些备份文件</li>
<li>make distclean：mrproper、清理patches以及编辑器备份文件卸载内核</li>
<li>删除/lib/modules/目录下不需要的内核库文件</li>
<li>删除/usr/src/linux/目录下不需要的内核源码</li>
<li>删除/boot目录下启动的内核和内核映像文件</li>
<li>更改grub的配置文件，删除不需要的内核启动列表</li>
</ul>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/自动化安装系统/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/自动化安装系统/" itemprop="url">自动化安装系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="kickstart安装步骤"><a href="#kickstart安装步骤" class="headerlink" title="kickstart安装步骤"></a>kickstart安装步骤</h1><p>    自动化安装之前我们首先要使用相应的工具去生成相应的文件（应答文件），在我们的系统装好之后，在管理员的家目录下都有这样一个文件anaconda-ks.cfg,此文件中的 kickstart就是我们实现自动化安装的重要文件，那么在配置此文件之前首先要安装kickstart所依赖的服务的包system-config-kickstart使用此工具需要在图形界面下进行<br>具体步骤如下：</p>
<ol>
<li><p>首先安装包文件system-config-kickstart</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#yum install system-config-kickstart</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装之后在图形界面下打开system-config-kickstart</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#system-config-kickstart</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart1.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart2.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart3.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart5.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart6.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart7.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart8.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart9.png?raw=true" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">centos7上包安装界面时是空白的，此时需要把yum源的[base]改为[development]</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart10.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart11.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart12.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart13.png?raw=true" alt="img"></p>
<p>查看下是否生成了<code>ks.cfg</code>文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ll ks.cfg </span></span><br><span class="line">-rw-r--r-- 1 root root 1345 Nov 18 14:34 ks.cfg</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#mkdir -pv /var/www/html/ksdir/&#123;6,7&#125;</span></span><br><span class="line">mkdir: created directory `/var/www/html/ksdir<span class="string">'</span></span><br><span class="line"><span class="string">mkdir: created directory `/var/www/html/ksdir/6'</span></span><br><span class="line">mkdir: created directory `/var/www/html/ksdir/7<span class="string">'</span></span><br><span class="line"><span class="string">[root@CentOS6 ~]#mv ks.cfg /var/www/html/ksdir/6/ks_mini.cfg  </span></span><br><span class="line"><span class="string">[root@CentOS6 ~]#ll /var/www/html/ksdir/6/ks_mini.cfg</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1345 Nov 18 14:34 /var/www/html/ksdir/6/ks_mini.cfg</span></span><br></pre></td></tr></table></figure>
<p>如果对ks_mini.cfg文件进行修改，格式出现错误势必后面的安装也不能正常进行，那么此时我们可以用ksvalidator来进行检查</p>
<p>格式：ksvalidator ks_mini.cfg</p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/kickstart14.png?raw=true" alt="img"></p>
<p>    如果访问的时候出现没有权限的提示，首先查看该应答文件是否为644权限<br>如果权限不是此时应该修改权限<br>chmod 644 ks6_mini.cfg<br>如果权限是644权限，那么此时应该关闭selinux</p>
<p>关闭方法：vim /etc/selinux/config 将SELINUX=enabled 改为SELINUX=disabled,重启即可</p>
<p>此时已经可以通过刚才生成的文件通过网络来实现自动化安装，点击启动，把刚才的虚拟机重启（此时就需要光盘引导）</p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E5%BC%80%E6%9C%BA%E7%95%8C%E9%9D%A2.png?raw=true" alt="img"></p>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E9%85%8D%E7%BD%AEboot.png?raw=true" alt="img"><br>    此时当你按下ENTER之后，就意味着你可以去休息了，剩下的事情完全自动化安装了。</p>
<h1 id="kickstart文件的格式"><a href="#kickstart文件的格式" class="headerlink" title="kickstart文件的格式"></a>kickstart文件的格式</h1><ol>
<li><p>命令段：指明各种安装前配置，如键盘类型等</p>
</li>
<li><p>程序包段：指明要安装的程序包组或程序包，不安装的程序包等</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%packages  </span><br><span class="line">@group_name  </span><br><span class="line">package  </span><br><span class="line">-package</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
</li>
<li><p>脚本段：</p>
<blockquote>
<p>%pre: 安装前脚本<br>运行环境：运行于安装介质上的微型Linux环境</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>%post: 安装后脚本<br>运行环境：安装完成的系统</p>
<ol>
<li><p>命令段中的命令：</p>
<p> 必备命令</p>
<blockquote>
<p>authconfig: 认证方式配置<br>authconfig –useshadow –passalgo=sha512<br>bootloader：bootloader的安装位置及相关配置<br>bootloader –location=mbr –driveorder=sda –<br>append=”crashkernel=auto rhgb quiet”<br>keyboard: 设定键盘类型<br>lang: 语言类型<br>part: 创建分区<br>rootpw: 指明root的密码<br>timezone: 时区</p>
</blockquote>
</li>
</ol>
</blockquote>
<blockquote>
<p>可选命令</p>
<blockquote>
<p>install OR upgrade<br>text: 文本安装界面<br>network<br>firewall<br>selinux<br>halt<br>poweroff<br>reboot<br>repo<br>user：安装完成后为系统创建新用户<br>url: 指明安装源<br>key –skip 跳过安装号码,适用于rhel版本</p>
</blockquote>
</blockquote>
<h1 id="制作引导光盘和U盘"><a href="#制作引导光盘和U盘" class="headerlink" title="制作引导光盘和U盘"></a>制作引导光盘和U盘</h1><p>创建引导光盘：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir –pv /app/myiso</span><br><span class="line">cp -r /misc/<span class="built_in">cd</span>/isolinux/ /app/myiso/</span><br><span class="line">vim /app/myiso/isolinux/isolinux.cfg</span><br><span class="line">initrd=initrd.img text ks=cdrom:/myks.cfg</span><br><span class="line">cp /root/myks.cfg /app/myiso/</span><br><span class="line">mkisofs -R -J -T -v --no-emul-boot --boot-load-size 4 --boot-info-table -V <span class="string">"CentOS 6.9 x86_64 boot"</span> -b isolinux/isolinux.bin -c isolinux/boot.cat -o /root/boot.iso /app/myiso/</span><br></pre></td></tr></table></figure>
<p>注意：以上相对路径都是相对于光盘的根，和工作目录无关</p>
<p>创建U盘启动盘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/sr0 of=/dev/sdb</span><br></pre></td></tr></table></figure>
<h1 id="mkisofs选项"><a href="#mkisofs选项" class="headerlink" title="mkisofs选项"></a>mkisofs选项</h1><p>-o 指定映像文件的名称。<br>-b 指定在制作可开机光盘时所需的开机映像文件。<br>-c 制作可开机光盘时，会将开机映像文件中的 no-eltorito-catalog 全部内容作成一个文件。<br>-no-emul-boot 非模拟模式启动。<br>-boot-load-size 4 设置载入部分的数量<br>-boot-info-table 在启动的图像中现实信息<br>-R 或 -rock 使用 Rock RidgeExtensions<br>-J 或 -joliet 使用 Joliet 格式的目录与文件名称<br>-v 或 -verbose 执行时显示详细的信息<br>-T 或 -translation-table 建立文件名的转换表，适用于不支持 Rock Ridge Extensions 的系统上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#mkdir /data/iso</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cp -r /misc/cd/isolinux/ /data/iso</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#tree /data/iso</span></span><br><span class="line">/data/iso</span><br><span class="line">└── isolinux</span><br><span class="line">├── boot.cat</span><br><span class="line">├── boot.msg</span><br><span class="line">├── grub.conf</span><br><span class="line">├── initrd.img</span><br><span class="line">├── isolinux.bin</span><br><span class="line">├── isolinux.cfg</span><br><span class="line">├── memtest</span><br><span class="line">├── splash.jpg</span><br><span class="line">├── TRANS.TBL</span><br><span class="line">├── vesamenu.c32</span><br><span class="line">└── vmlinuz</span><br><span class="line"></span><br><span class="line">1 directory, 11 files</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cp /var/www/html/ksdir/6/ks_mini.cfg /data/iso/</span></span><br><span class="line">[root@CentOS6 iso]<span class="comment">#mkdir ksdir</span></span><br><span class="line">[root@CentOS6 iso]<span class="comment">#mv ks_mini.cfg ksdir/</span></span><br><span class="line">[root@CentOS6 iso]<span class="comment">#ls</span></span><br><span class="line">isolinux ksdir</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/文本三剑客之sed/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/文本三剑客之sed/" itemprop="url">文本三剑客之sed</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://github.com/xiejia1215225/Pictures/blob/master/linux-sed.png?raw=true" alt="">  </p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>&ensp;&ensp;&ensp;&ensp;sed是一种流编辑器、行编辑器。它一次处理一行内容。处理时，把当前处理的行存储在临时缓冲区中，称为“模式空间”（pattern space），接着用sed命令处理缓冲区中的内容，处理完成后，把缓冲区的内容送往屏幕。然后读入下行，执行下一个循环。如果没有使诸如‘D’ 的特殊命令，那会在两个循环之间清空模式空间，但不会清空保留空间。这样不断重复，直到文件末尾。文件内容并没有改变，除非你使用重定向存储输出。<br>&ensp;&ensp;&ensp;&ensp;sed和我们之前的文本处理工具vim、grep是有区别的，vim是一种交互式的文本编辑工具，而sed是一种非交互式的文本编辑器（通过给定的条件自动的逐行去处理文件）；grep虽然也是一种流失的文本处理工具，但grep是用来检索条件关键字的，而sed却是搜索匹配处理文本公积<br>&ensp;&ensp;&ensp;&ensp;sed的功能：主要用来自动编辑一个或多个文件,简化对文件的反复操作,编写转换程序等  </p>
<h1 id="sed语法"><a href="#sed语法" class="headerlink" title="sed语法"></a>sed语法</h1><p><code>sed [option]... &#39;script&#39; inputfile...</code></p>
<p>-n 不输出模式空间内容到屏幕，即不自动打印<br>-e 多点编辑<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n -e '2p' -e '6p' </span></span><br><span class="line">2</span><br><span class="line">6</span><br></pre></td></tr></table></figure></p>
<p>-f /PATH/SCRIPT_FILE 从指定文件中读取编辑脚本<br>-r 支持使用扩展正则表达式<br>-i.bak 备份文件并原处编辑  </p>
<h1 id="地址定界"><a href="#地址定界" class="headerlink" title="地址定界"></a>地址定界</h1><ol>
<li><p>不给地址：对全文进行处理 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed 'p'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>单地址:<br>#: 指定的行<br>$： 最后一行<br>/pattern/：被此处模式所能够匹配到的每一行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#seq 10 | sed -n &apos;1p&apos;</span><br><span class="line">[root@localhost ~]#seq 10 | sed -n &apos;$p&apos;</span><br><span class="line">[root@localhost ~]#sed  -n &apos;/^root/p&apos; /etc/passwd</span><br></pre></td></tr></table></figure>
</li>
<li><p>地址范围：<br>#,#<br>#,+#<br>/pat1/,/pat2/<br>#,/pat1/  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n '1,5p'</span></span><br><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n '1,+4p'</span></span><br><span class="line">[root@localhost ~]<span class="comment">#sed  -n '/^b/,/^f/p' /etc/passwd</span></span><br><span class="line">[root@localhost ~]<span class="comment">#sed  -n '2,/^f/p' /etc/passwd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>~：步进<br>1~2 奇数行<br>2~2 偶数行  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n '1~2p'</span></span><br><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n '2~2p'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="编辑命令"><a href="#编辑命令" class="headerlink" title="编辑命令"></a>编辑命令</h1><p>d 删除模式空间匹配的行，并立即启用下一轮循环<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 5 | sed '2d'</span></span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure></p>
<p>p 打印当前模式空间内容，追加到默认输出之后<br>a []text 在指定行后面追加文本，支持使用\n实现多行追加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 5 | sed  '$axxx\nyyy' </span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">xxx</span><br><span class="line">yyy</span><br></pre></td></tr></table></figure></p>
<p>i []text 在行前面插入文本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 5 | sed  '$ixxx\nyyy' </span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">xxx</span><br><span class="line">yyy</span><br><span class="line">5</span><br></pre></td></tr></table></figure></p>
<p>c []text 替换行为单行或多行文本<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 5 | sed  '$cxxx\nyyy' </span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">xxx</span><br><span class="line">yyy</span><br></pre></td></tr></table></figure></p>
<p>w /path/file 保存模式匹配的行至指定文件<br>r /path/file 读取指定文件的文本至模式空间中匹配到的行后<br>= 为模式空间中的行打印行号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]#sed  -n &apos;/root/=&apos; /etc/passwd</span><br></pre></td></tr></table></figure></p>
<p>! 模式空间中匹配行取反处理sed工具<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 5 | sed ' 2 ! d' </span></span><br><span class="line">2</span><br></pre></td></tr></table></figure></p>
<p>s/// 查找替换,支持使用其它分隔符， s@@@， s###<br><strong><em>替换标记：</em></strong><br>g 行内全局替换<br>p 显示替换成功的行</p>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><ol>
<li>删除centos7系统/etc/grub2.cfg文件中所有以空白开头的行行首的空白字符</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/grub2.cfg  | sed -nr <span class="string">'s@^([[:space:]]*)([[:alpha:]].*$)@\2@gp'</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>删除/etc/fstab文件中所有以#开头，后面至少跟一个空白字符的行的行首的#和空白字符  </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/fstab | sed -nr <span class="string">'s@^#[[:space:]]@@gp'</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在centos6系统/root/install.log每一行行首增加#号</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /root/install.log | sed -nr <span class="string">'s@^In.*@#&amp;@g'</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在/etc/fstab文件中不以#开头的行的行首增加#号</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/fstab  | sed -nr <span class="string">'s@^([^#]|$)@#&amp;@gp'</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>处理/etc/fstab路径,使用sed命令取出其目录名和基名</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dirname: <span class="built_in">echo</span> /etc/fstab | sed -nr <span class="string">'s@(.*/)([^/]+/?$)@\1@gp'</span></span><br><span class="line">basename: <span class="built_in">echo</span> /etc/fstab | sed -nr <span class="string">'s@(.*/)([^/]+/?$)@\2@gp'</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li><p>利用sed取出ifconfig命令中本机的IPv4地址  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig | sed -nr <span class="string">'2!d;s@.*inet (addr:)?@@;s@  .*@@gp'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>统计centos安装光盘中Package目录下的所有rpm文件的以.分隔倒数第二个<br>字段的重复次数</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls  /run/media/root/CentOS\ 7\ x86_64/Packages/ | sed -nr <span class="string">'s@(.*\.)(.*)\.rpm$@\2@gp'</span> |sort | uniq -c</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>统计/etc/init.d/functions文件中每个单词的出现次数，并排序（用grep和<br>sed两种方法分别实现）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep: cat /etc/init.d/<span class="built_in">functions</span> | grep -Eow <span class="string">"[[:alpha:]]*_?"</span> | sort | uniq -c</span><br><span class="line">sed:</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="高级编辑命令"><a href="#高级编辑命令" class="headerlink" title="高级编辑命令"></a>高级编辑命令</h1><p>&ensp;&ensp;&ensp;&ensp;sed除了模式空间外，还有一个“hold space”的内存空间，称为保持空间。<br>&ensp;&ensp;&ensp;&ensp;sed工作机制是每次自动读取一行到模式空间中，在模式空间中完成处理，将处理结果输出至标准输出设备；在模式空间中处理一行内容后会继续处理下一行。那么对于处理过的行还有其他处理时，我们就把处理过的行送至保持空间中，然后在后续处理中在传回至模式空间中。<br><img src="https://github.com/xiejia1215225/Pictures/blob/master/sed%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.jpg?raw=true" alt=""><br><strong><em>常见命令：</em></strong></p>
<p>P： 打印模式空间开端至\n内容，并追加到默认输出之前<br>h: 把模式空间中的内容覆盖至保持空间中<br>H：把模式空间中的内容追加至保持空间中<br>g: 从保持空间取出数据覆盖至模式空间<br>G：从保持空间取出内容追加至模式空间<br>x: 把模式空间中的内容与保持空间中的内容进行互换<br>n: 读取匹配到的行的下一行覆盖至模式空间<br>N：读取匹配到的行的下一行追加至模式空间<br>d: 删除模式空间中的行<br>D：如果模式空间包含换行符，则删除直到第一个换行符的模式空间中的文本，并不会读取新的输入行，而使用合成的模式空间重新启动循环。如果模式空间不包含换行符，则会像发出d命令那样启动正常的新循环</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ol>
<li>seq 10 | sed -n ‘n;p’  </li>
</ol>
<p>(1)首先-n禁止默认的打印功能，因为没有地址定界，所以默认为全文，首先读第一行至模式空间，n表示匹配到的下一行覆盖至模式空间，即用第二行覆盖模式空间内的第一行;</p>
<p>(2)然后读取第三行，继续-n操作，所以打印出来的都为偶数行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed -n 'n;p' </span></span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">8</span><br><span class="line">10</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>seq 10 | sed ‘1!G;h;$!d’ </li>
</ol>
<p>(1)依然是默认为全文，首先读取第一行，1！G，不做操作，h，覆盖至保持空间，因为保持空间本开始没有内容，所以此时保持空间内容为第一行，$!d，不是最后一行，执行删除。此第一行操作完毕，此时模式空间没有内容，保持空间为第一行；</p>
<p>(2)再读取第二行，1！G，因为不是第一行，执行G操作，即从保持空间取出内容追加至模式空间，此时模式空间的内容为第二行+第一行，且第一行在下面，h，把模式空间中的内容覆盖至保持空间中，此时保持空间为原来的模式空间内容，$!d，不是最后一行，执行删除。此时模式空间为空，保持空间为第二行+第一行。</p>
<p>(3)直到读到最后一行，1！G，此时模式空间内为第十行到第一行，h，再把模式空间内容覆盖至保持空间，最后$!d,因为是最后一行，所以不予操作，最后将模式空间的内容打印出来，即逆序显示。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed '1!G;h;$!d' </span></span><br><span class="line">10</span><br><span class="line">9</span><br><span class="line">8</span><br><span class="line">7</span><br><span class="line">6</span><br><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li><p>seq 10 | sed ‘$!d’<br>默认为全文内容，$!d表示不是最后一行执行d删除操作，所以只打印出最后一行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#seq 10 | sed '$!d'</span></span><br><span class="line">10</span><br></pre></td></tr></table></figure>
</li>
<li><p>将文本文件的n和n+1行合并为一行， n为奇数行  </p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seq 10 | sed <span class="string">'N;s@\n@ @'</span></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/系统启动流程与grub/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/系统启动流程与grub/" itemprop="url">系统启动流程与grub</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Centos6启动流程"><a href="#Centos6启动流程" class="headerlink" title="Centos6启动流程"></a>Centos6启动流程</h1><ol>
<li>POST加电自检,即加载BIOS的硬件信息，获取第一个启动设备</li>
<li>读取第一个启动设备MBR的引导加载程序(grub)的启动信息</li>
<li>加载核心操作系统的核心信息，核心开始解压缩，并尝试驱动所有的硬件设备</li>
<li>核心执行init程序，并获取默认的运行信息</li>
<li>init程序执行/etc/rc.d/rc.sysinit文件</li>
<li>启动核心的外挂模块</li>
<li>init执行运行的各个批处理文件(scripts)</li>
<li>执行/bin/login程序，等待用户登录</li>
<li>登录之后开始以Shell控制主机启动流程</li>
</ol>
<h2 id="加电自检：power-on-system-test-POST"><a href="#加电自检：power-on-system-test-POST" class="headerlink" title="加电自检：power on system test(POST)"></a>加电自检：power on system test(POST)</h2><p>    自检主要是检测一下硬件设备是否存在并能正常运行，如：CPU、内存、硬盘是否存在并能正常运行。这些自检的功能是有一个软件程序来实现的，这个软件程序叫做：BIOS。BIOS （Basic Input Output System）即基本输入输出系统。它是装载在一个硬件芯片CMOS之上，显然CMOS是一个硬件设备。加电过程就是给CMOS通电，然后启动其上的BIOS程序，BIOS程序会根据CMOS上面的一些配置信息去读取其他的硬件设备信息并检测其是否存在并能正常运行，之后进行硬件设备的初始化。</p>
<h2 id="读取MBR"><a href="#读取MBR" class="headerlink" title="读取MBR"></a>读取MBR</h2><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/MBR.gif?raw=true" alt="img"><br>    众所周知，硬盘上第0磁道第一个扇区被称为MBR，也就是Master Boot Record，即主引导记录，它的大小是512字节，别看地方不大，可里面却存放了预启动信息、分区表信息。前446字节存放grub的空间，中间64字节是分区表，最后2字节 55AA的标识。<br>系统找到BIOS所指定的硬盘的MBR后，就会将其复制到0×7c00地址所在的物理内存中。其实被复制到物理内存的内容就是Boot Loader。Boot Loader 就是在操作系统内核运行之前运行的一段小程序。</p>
<h2 id="Grub启动引导阶段"><a href="#Grub启动引导阶段" class="headerlink" title="Grub启动引导阶段"></a>Grub启动引导阶段</h2><p>    grub引导也分为三个阶段stage1阶段、stage1.5阶段和stage2阶段。</p>
<p>阶段 1<br>    如上文 POST（上电自检）阶段提到的，在 POST 阶段结束时，BIOS 将查找在接入的磁盘中查找引导记录，其通常位于 MBR（主引导记录Master Boot Record），它加载它找到的第一个引导记录中到内存中，并开始执行此代码。引导代码（及阶段 1 代码）必须非常小，因为它必须连同分区表放到硬盘的第一个 512 字节的扇区中。 在传统的常规 MBR 中，引导代码实际所占用的空间大小为 446 字节。这个阶段 1 的 446 字节的文件通常被叫做引导镜像（boot.img），其中不包含设备的分区信息，分区是一般单独添加到引导记录中。</p>
<p>由于引导记录必须非常的小，它不可能非常智能，且不能理解文件系统结构。因此阶段 1 的唯一功能就是定位并加载阶段 1.5 的代码。为了完成此任务，阶段 1.5 的代码必须位于引导记录与设备第一个分区之间的位置。在加载阶段 1.5 代码进入内存后，控制权将由阶段 1 转移到阶段 1.5。</p>
<p>阶段 1.5<br>    如上所述，阶段 1.5 的代码必须位于引导记录与设备第一个分区之间的位置。该空间由于历史上的技术原因而空闲。第一个分区的开始位置在扇区 63 和 MBR（扇区 0）之间遗留下 62 个 512 字节的扇区（共 31744 字节），该区域用于存储阶段 1.5 的代码镜像 core.img 文件。该文件大小为 25389 字节，故此区域有足够大小的空间用来存储 core.img。</p>
<p>因为有更大的存储空间用于阶段 1.5，且该空间足够容纳一些通用的文件系统驱动程序，如标准的 EXT 和其它的 Linux 文件系统，如 FAT 和 NTFS 等。故阶段 2 的文件可以存放于 /boot 文件系统中，一般在 /boot/grub 目录下。</p>
<p><strong>注意 /boot 目录必须放在一个 GRUB 所支持的文件系统（并不是所有的文件系统均可）。阶段 1.5 的功能是开始执行存放阶段 2 文件的 /boot 文件系统的驱动程序，并加载相关的驱动程序。</strong></p>
<p>阶段 2<br>    GRUB 阶段 2 所有的文件都已存放于 /boot/grub 目录及其几个子目录之下。该阶段没有一个类似于阶段 1 与阶段 1.5 的镜像文件。相应地，该阶段主要需要从 /boot/grub2/i386-pc 目录下加载一些内核运行时模块。</p>
<p>GRUB 阶段 2 的主要功能是定位和加载 Linux 内核到内存中，并转移控制权到内核。内核的相关文件位于 /boot 目录下，这些内核文件可以通过其文件名进行识别，其文件名均带有前缀 vmlinuz。你可以列出 /boot 目录中的内容来查看操作系统中当前已经安装的内核。</p>
<p>Red Hat 包管理器（DNF）支持保留多个内核版本，以防最新版本内核发生问题而无法启动时，可以恢复老版本的内核。默认情况下，GRUB 提供了一个已安装内核的预引导菜单，其中包括问题诊断菜单（recuse）以及恢复菜单（如果配置已经设置恢复镜像）。</p>
<p>阶段 2 加载选定的内核到内存中，并转移控制权到内核代码。</p>
<h2 id="加载内核"><a href="#加载内核" class="headerlink" title="加载内核"></a>加载内核</h2><p>    根据grub设定的内核映像所在路径，系统读取内存映像，并进行解压缩操作。此时，屏幕一般会输出“Uncompressing Linux”的提示。当解压缩内核完成后，屏幕输出“OK, booting the kernel”。<br>系统将解压后的内核放置在内存之中，并调用start_kernel()函数来启动一系列的初始化函数并初始化各种设备，完成Linux核心环境的建立。至此，Linux内核已经建立起来了，基于Linux的程序应该可以正常运行了。</p>
<h2 id="用户层init依据inittab文件来设定运行等级"><a href="#用户层init依据inittab文件来设定运行等级" class="headerlink" title="用户层init依据inittab文件来设定运行等级"></a>用户层init依据inittab文件来设定运行等级</h2><p>    内核被加载后，第一个运行的程序便是/sbin/init，该文件会读取/etc/inittab文件，并依据此文件来进行初始化工作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 rc5.d]<span class="comment">#cat /etc/inittab</span></span><br><span class="line"><span class="comment"># inittab is only used by upstart for the default runlevel.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">  ADDING OTHER CONFIGURATION HERE WILL HAVE NO EFFECT ON YOUR SYSTEM.</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># System initialization is started by /etc/init/rcS.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Individual runlevels are started by /etc/init/rc.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Ctrl-Alt-Delete is handled by /etc/init/control-alt-delete.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Terminal gettys are handled by /etc/init/tty.conf and /etc/init/serial.conf,</span></span><br><span class="line"><span class="comment"># with configuration in /etc/sysconfig/init.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For information on how to write upstart event handlers, or how</span></span><br><span class="line"><span class="comment"># upstart works, see init(5), init(8), and initctl(8).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Default runlevel. The runlevels used are:</span></span><br><span class="line"><span class="comment">#   0 - halt (Do NOT set initdefault to this)</span></span><br><span class="line"><span class="comment">#   1 - Single user mode</span></span><br><span class="line"><span class="comment">#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)</span></span><br><span class="line"><span class="comment">#   3 - Full multiuser mode</span></span><br><span class="line"><span class="comment">#   4 - unused</span></span><br><span class="line"><span class="comment">#   5 - X11</span></span><br><span class="line"><span class="comment">#   6 - reboot (Do NOT set initdefault to this)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">id:5:initdefault:</span><br></pre></td></tr></table></figure>
<p>其实/etc/inittab文件最主要的作用就是设定Linux的运行等级，</p>
<ul>
<li>运行级别：为系统运行或维护等目的而设定；0-6：7个级别<br>  0：关机<br>  1：单用户模式(root自动登录), single, 维护模式<br>  2：多用户模式，启动网络功能，但不会启动NFS；维护模式<br>  3：多用户模式，正常模式；文本界面<br>  4：保留，未使用<br>  5：多用户模式，正常模式；图形界面<br>  6：重启</li>
<li>默认级别：3, 5</li>
<li>切换级别：init #</li>
<li>查看级别：runlevel ; who -r</li>
</ul>
<p>每一行格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id:runlevel:action:process</span><br></pre></td></tr></table></figure>
<ul>
<li><p>id：是惟一标识该项的字符序列</p>
</li>
<li><p>runlevels： 定义了操作所使用的运行级别</p>
</li>
<li><p>action： 指定了要执行的特定操作</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>wait: 切换至此级别运行一次<br>respawn：此process终止，就重新启动之<br>initdefault：设定默认运行级别；process省略<br>sysinit：设定系统初始化方式</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</li>
<li><p>process：定义了要执行的进程</p>
</li>
</ul>
<p>故</p>
<p>id:5:initdefault:</p>
<p>这就表明Linux需要开机运行在5模式  </p>
<ul>
<li>破解CentOS5和6的root口令<br>进入单用户模式即可</li>
</ul>
<h2 id="init进程执行rc-sysinit"><a href="#init进程执行rc-sysinit" class="headerlink" title="init进程执行rc.sysinit"></a>init进程执行rc.sysinit</h2><p>/etc/rc.d/rc.sysinit: 系统初始化脚本（一般情况下，我们不需要改）  </p>
<ol>
<li>设置主机名  </li>
<li>设置欢迎信息  </li>
<li>激活udev和selinux  </li>
<li>挂载/etc/fstab文件中定义的文件系统  </li>
<li>检测根文件系统，并以读写方式重新挂载根文件系统  </li>
<li>设置系统时钟  </li>
<li>激活swap设备  </li>
<li>根据/etc/sysctl.conf文件设置内核参数  </li>
<li>激活lvm及software raid设备  </li>
<li>加载额外设备的驱动程序  </li>
<li>清理操作启动流程  </li>
</ol>
<h2 id="执行不同运行级别的脚本程序"><a href="#执行不同运行级别的脚本程序" class="headerlink" title="执行不同运行级别的脚本程序"></a>执行不同运行级别的脚本程序</h2><p>根据运行级别的不同，系统会运行rc0.d到rc6.d中的相应的脚本程序，来完成相应的初始化工作和启动相应的服务。<br>说明：rc N –&gt; 意味着读取/etc/rc.d/rcN.d/<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 rc.d]<span class="comment">#ll</span></span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov  6 09:32 init.d</span><br><span class="line">-rwxr-xr-x. 1 root root  2617 Jun 20 00:12 rc</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc0.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc1.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc2.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc3.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc4.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov  7 11:26 rc5.d</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Oct 30 20:19 rc6.d</span><br><span class="line">-rwxr-xr-x. 1 root root   220 Jun 20 00:12 rc.local</span><br><span class="line">-rwxr-xr-x. 1 root root 20199 Jun 20 00:12 rc.sysinit</span><br></pre></td></tr></table></figure></p>
<p>K<em>: K##</em>：##运行次序；数字越小，越先运行；数字越小的服务，通常为依赖到别的服务<br>S<em>: S##</em>：##运行次序；数字越小，越先运行；数字越小的服务，通常为被依赖到的服务  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> srv <span class="keyword">in</span> /etc/rc.d/rcN.d/K*; <span class="keyword">do</span></span><br><span class="line"><span class="variable">$srv</span> stop</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> srv <span class="keyword">in</span> /etc/rc.d/rcN.d/S*; <span class="keyword">do</span></span><br><span class="line"><span class="variable">$srv</span> start</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="执行-etc-rc-d-rc-local"><a href="#执行-etc-rc-d-rc-local" class="headerlink" title="执行/etc/rc.d/rc.local"></a>执行/etc/rc.d/rc.local</h2><p>你如果打开了此文件，里面有一句话，读过之后，你就会对此命令的作用一目了然：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 rc.d]<span class="comment">#cat /etc/rc.d/rc.local </span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script will be executed *after* all the other init scripts.</span></span><br><span class="line"><span class="comment"># You can put your own initialization stuff in here if you don't</span></span><br><span class="line"><span class="comment"># want to do the full Sys V style init stuff.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p><code>注意：</code>正常级别下，最后启动一个服务S99local没有链接至/etc/rc.d/init.d一个服务脚本，而是指向了/etc/rc.d/rc.local脚本<br>不便或不需写为服务脚本放置于/etc/rc.d/init.d/目录，且又想开机时自动运行的命令，可直接放置于/etc/rc.d/rc.local文件中<br>/etc/rc.d/rc.local在指定运行级别脚本后运行<br>可以根据情况，进行自定义修改</p>
<h2 id="执行-bin-login程序，进入登录状态"><a href="#执行-bin-login程序，进入登录状态" class="headerlink" title="执行/bin/login程序，进入登录状态"></a>执行/bin/login程序，进入登录状态</h2><p>此时，系统已经进入到了等待用户输入username和password的时候了，你已经可以用自己的帐号登入系统了。</p>
<h1 id="Grub"><a href="#Grub" class="headerlink" title="Grub"></a>Grub</h1><h2 id="Grub-GRand-Unified-Bootloader"><a href="#Grub-GRand-Unified-Bootloader" class="headerlink" title="Grub: GRand Unified Bootloader"></a>Grub: GRand Unified Bootloader</h2><p>如前面所述，grub分为三个阶段<br>stage1: mbr<br>stage1.5: mbr之后的扇区，让stage1中的bootloader能识别stage2所在的分区上的文件系统<br>stage2：磁盘分区(/boot/grub/)</p>
<h2 id="Grub安装"><a href="#Grub安装" class="headerlink" title="Grub安装"></a>Grub安装</h2><ol>
<li><p>grub-install<br> 安装grub stage1和stage1_5到/dev/DISK磁盘上，并复制GRUB相关文件<br> 到 DIR/boot目录下<br> grub-install –root-directory=DIR /dev/DISK</p>
</li>
<li><p>grub<br> grub&gt; root (hd#,#)<br> grub&gt; setup (hd#)grub</p>
</li>
<li><p>识别硬盘设备</p>
<p> (hd#,#)</p>
<p> hd#: 磁盘编号，用数字表示；从0开始编号</p>
<p> #: 分区编号，用数字表示; 从0开始编号</p>
<p> (hd0,0) 第一块硬盘，第一个分区</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#dd if=/dev/zero of=/dev/sda bs=1 count=446</span></span><br><span class="line">446+0 records <span class="keyword">in</span></span><br><span class="line">446+0 records out</span><br><span class="line">446 bytes (446 B) copied, 0.00308127 s, 145 kB/s</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#hexdump -C /dev/sda -n 512</span></span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</span><br><span class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</span><br><span class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 80 1a 06 00 fe  |)....... .......|</span><br><span class="line">000001e0  ff ff 83 fe ff ff 00 88  3a 06 00 80 a9 03 00 fe  |........:.......|</span><br><span class="line">000001f0  ff ff 05 fe ff ff 00 08  e4 09 00 f8 1b 0f 55 aa  |..............U.|</span><br><span class="line">00000200</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#grub</span></span><br><span class="line">Probing devices to guess BIOS drives. This may take a long time.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    GNU GRUB  version 0.97  (640K lower / 3072K upper memory)</span><br><span class="line"></span><br><span class="line"> [ Minimal BASH-like line editing is supported.  For the first word, TAB</span><br><span class="line">   lists possible <span class="built_in">command</span> completions.  Anywhere <span class="keyword">else</span> TAB lists the possible</span><br><span class="line">   completions of a device/filename.]</span><br><span class="line">grub&gt; root (hd0,0)                 </span><br><span class="line">root (hd0,0)</span><br><span class="line"> Filesystem <span class="built_in">type</span> is ext2fs, partition <span class="built_in">type</span> 0x83</span><br><span class="line">grub&gt; setup (hd0)</span><br><span class="line">setup (hd0)</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/boot/grub/stage1"</span> exists... no</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/grub/stage1"</span> exists... yes</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/grub/stage2"</span> exists... yes</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/grub/e2fs_stage1_5"</span> exists... yes</span><br><span class="line"> Running <span class="string">"embed /grub/e2fs_stage1_5 (hd0)"</span>...  27 sectors are embedded.</span><br><span class="line">succeeded</span><br><span class="line"> Running <span class="string">"install /grub/stage1 (hd0) (hd0)1+27 p (hd0,0)/grub/stage2 /grub/grub.conf"</span>... succeeded</span><br><span class="line">Done.</span><br><span class="line">grub&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果我们把/boot/grub/* 的文件移走</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#mv /boot/grub/* /data</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#dd if=/dev/zero of=/dev/sda bs=1 count=446</span></span><br><span class="line">446+0 records <span class="keyword">in</span></span><br><span class="line">446+0 records out</span><br><span class="line">446 bytes (446 B) copied, 0.00398936 s, 112 kB/s</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#hexdump -C /dev/sda -n 512</span></span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</span><br><span class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</span><br><span class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 80 1a 06 00 fe  |)....... .......|</span><br><span class="line">000001e0  ff ff 83 fe ff ff 00 88  3a 06 00 80 a9 03 00 fe  |........:.......|</span><br><span class="line">000001f0  ff ff 05 fe ff ff 00 08  e4 09 00 f8 1b 0f 55 aa  |..............U.|</span><br><span class="line">00000200</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#grub</span></span><br><span class="line">Probing devices to guess BIOS drives. This may take a long time.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    GNU GRUB  version 0.97  (640K lower / 3072K upper memory)</span><br><span class="line"></span><br><span class="line"> [ Minimal BASH-like line editing is supported.  For the first word, TAB</span><br><span class="line">   lists possible <span class="built_in">command</span> completions.  Anywhere <span class="keyword">else</span> TAB lists the possible</span><br><span class="line">   completions of a device/filename.]</span><br><span class="line">grub&gt; root (hd0,0)</span><br><span class="line">root (hd0,0)</span><br><span class="line"> Filesystem <span class="built_in">type</span> is ext2fs, partition <span class="built_in">type</span> 0x83</span><br><span class="line">grub&gt; setup (hd0)</span><br><span class="line">setup (hd0)</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/boot/grub/stage1"</span> exists... no</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">"/grub/stage1"</span> exists... no</span><br><span class="line"></span><br><span class="line">Error 15t: File not found</span><br><span class="line">grub&gt; </span><br><span class="line">[root@CentOS6 ~]<span class="comment">#grub-install /dev/sda</span></span><br><span class="line">Probing devices to guess BIOS drives. This may take a long time.</span><br><span class="line">Installation finished. No error reported.</span><br><span class="line">This is the contents of the device map /boot/grub/device.map.</span><br><span class="line">Check <span class="keyword">if</span> this is correct or not. If any of the lines is incorrect,</span><br><span class="line">fix it and re-run the script `grub-install<span class="string">'.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(fd0)   /dev/fd0</span></span><br><span class="line"><span class="string">(hd0)   /dev/sda</span></span><br></pre></td></tr></table></figure>
<p>由此实验我们可以看出grub&gt; root (hd#,#)；grub&gt; setup (hd#)这种修复方法依赖于/boot/grub/ <em>文件而grub-install这种修复方法不依赖/boot/grub/</em> 文件，感觉更通用一些。</p>
<h2 id="grub"><a href="#grub" class="headerlink" title="grub"></a>grub</h2><p>stage2及内核等通常放置于一个基本磁盘分区<br>功用：</p>
<ol>
<li><p>提供启动菜单、并提供交互式接口</p>
<blockquote>
<p>a：内核参数<br>e: 编辑模式，用于编辑菜单<br>c: 命令模式，交互式接口</p>
</blockquote>
</li>
<li><p>加载用户选择的内核或操作系统</p>
<blockquote>
<p>允许传递参数给内核<br>可隐藏启动菜单</p>
</blockquote>
</li>
<li><p>为菜单提供了保护机制</p>
<blockquote>
<p>为编辑启动菜单进行认证<br>为启用内核或操作系统进行认证grub legacy</p>
</blockquote>
</li>
</ol>
<p>grub的命令行接口</p>
<ul>
<li>help: 获取帮助列表</li>
<li>help KEYWORD: 详细帮助信息</li>
<li>find (hd#,#)/PATH/TO/SOMEFILE：</li>
<li>root (hd#,#)</li>
<li>kernel /PATH/TO/KERNEL_FILE: 设定本次启动时用到的内核文件；额外还可添加许多内核支持使用的cmdline参数<br>  例如：max_loop=100 selinux=0 init=/path/to/init</li>
<li>initrd /PATH/TO/INITRAMFS_FILE: 设定为选定的内核提供额外文件的ramdisk</li>
<li>boot: 引导启动选定的内核</li>
</ul>
<p>cat /proc/cmdline 内核参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]#cat /proc/cmdline </span><br><span class="line">ro root=UUID=d3df2aba-5cd3-47fe-8128-3445b87dba11 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16   KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</span><br></pre></td></tr></table></figure>
<p>手动在grub命令行接口启动系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grub&gt; root (hd<span class="comment">#,#)</span></span><br><span class="line">grub&gt; kernel /vmlinuz-VERSION-RELEASE ro root=/dev/DEVICE</span><br><span class="line">grub&gt; initrd /initramfs-VERSION-RELEASE.img</span><br><span class="line">grub&gt; bootgrub legacy配置文件</span><br></pre></td></tr></table></figure>
<h2 id="配置文件-boot-grub-grub-conf-lt-etc-grub-conf"><a href="#配置文件-boot-grub-grub-conf-lt-etc-grub-conf" class="headerlink" title="配置文件: /boot/grub/grub.conf &lt;- /etc/grub.conf"></a>配置文件: /boot/grub/grub.conf &lt;- /etc/grub.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]#vim  /boot/grub/grub.conf</span><br><span class="line"># grub.conf generated by anaconda                                                                 </span><br><span class="line">#</span><br><span class="line"># Note that you do not have to rerun grub after making changes to this file</span><br><span class="line"># NOTICE:  You have a /boot partition.  This means that</span><br><span class="line">#          all kernel and initrd paths are relative to /boot/, eg.</span><br><span class="line">#          root (hd0,0)</span><br><span class="line">#          kernel /vmlinuz-version ro root=/dev/sda2</span><br><span class="line">#          initrd /initrd-[generic-]version.img</span><br><span class="line">#boot=/dev/sda</span><br><span class="line">default=0</span><br><span class="line">timeout=5</span><br><span class="line">splashimage=(hd0,0)/grub/splash.xpm.gz</span><br><span class="line">hiddenmenu</span><br><span class="line">title CentOS 6 (2.6.32-754.el6.x86_64)</span><br><span class="line">        root (hd0,0)</span><br><span class="line">        kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=UUID=d3df2aba-5cd3-47fe-8128-3445b87dba11 rd</span><br><span class="line">_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto  KEYBOARDT</span><br><span class="line">YPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</span><br><span class="line">        initrd /initramfs-2.6.32-754.el6.x86_64.img</span><br></pre></td></tr></table></figure>
<p>参数：<br>default=#: 设定默认启动的菜单项；落单项(title)编号从0开始<br>timeout=#：指定菜单项等待选项选择的时长<br>splashimage=(hd#,#)/PATH/XPM_FILE：菜单背景图片文件路径<br>password [–md5] STRING: 启动菜单编辑认证<br>hiddenmenu：隐藏菜单<br>title TITLE：定义菜单项“标题” , 可出现多次<br>root (hd#,#)：查找stage2及kernel文件所在设备分区；为grub的根<br>kernel /PATH/TO/VMLINUZ_FILE [PARAMETERS]：启动的内核<br>initrd /PATH/TO/INITRAMFS_FILE: 内核匹配的ramfs文件</p>
<h2 id="grub加密"><a href="#grub加密" class="headerlink" title="grub加密"></a>grub加密</h2><p>因为linux只要进入单用户模式下就很轻易的破解root口令，所以我们在/boot/grub/grub.conf文件里加上一行passwd.<br>password [–md5|–encrypted ] STRING: 启动选定的内核或操作系统时进行认证</p>
<ol>
<li><p>生成grub口令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub-md5-crypt</span><br><span class="line">grub-crypt</span><br></pre></td></tr></table></figure>
</li>
<li><p>破解root口令</p>
<p>启动系统时，设置其运行级别1，进入单用户模式：</p>
<blockquote>
<p>编辑grub菜单(选定要编辑的title，而后使用a 或 e 命令)<br>在选定的kernel后附加1, s, S，single 都可以<br>在kernel所在行，键入“b” 命令</p>
</blockquote>
</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/文本处理三剑客之awk/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/文本处理三剑客之awk/" itemprop="url">文本处理三剑客之awk</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> Linux文本处理工具三剑客：grep、sed、awk.其中grep是一种文本过滤工具,sed是文本行编辑器,而awk是一种报表生成器，就是对文件进行格式化处理。这里的格式化就是对文件内容进行各种“排版”，进而格式化显示。<br>    在Linux之上我们使用的是GNU awk，简称gawk.我们通过man gawk得知gawk–模式扫描和处理语言，gawk是一种过程式编程语言。gawk还支持条件判断、数组、循环等各种编程语言中所有可以使用的功能，因此我们还可以把gwak称为一种脚本语言解释器。</p>
<ul>
<li>基本用法：<br>  awk [options] ‘program’ var=value file…<br>  awk [options] -f programfile var=value file…<br>  awk [options] ‘BEGIN{action;… }pattern{action;… }END{action;… }’ file …<br>  awk程序可由：BEGIN语句块、能够使用模式匹配的通用语句块、END语句块，共3部分组成<br>  program 通常是被放在单引号中<br>  选项：<br>  -F “分隔符” 指明输入时用到的字段分隔符<br>  -v var=value 变量赋值</li>
<li>awk语言</li>
</ul>
<p>基本格式：awk [options] ‘program’ file…<br>Program：pattern{action statements;..}</p>
<blockquote>
<p>pattern和action</p>
<blockquote>
<p>pattern部分决定动作语句何时触发及触发事件</p>
<blockquote>
<p>BEGIN,END</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>action statements对数据进行处理，放在{}内指明</p>
<blockquote>
<p>print, printf</p>
</blockquote>
</blockquote>
</blockquote>
<p>分割符、域和记录</p>
<blockquote>
<p>awk执行时，由分隔符分隔的字段（域）标记1,1,2…n称为域标识。n称为域标识。0为所有域，注意：此时和shell中变量符含义不同文件的每一行称为记录省略action，则默认执行print符含义不同文件的每一行称为记录省略action，则默认执行print0 的操作</p>
<ul>
<li>awk工作原理<br>  第一步：执行BEGIN{action;… }语句块中的语句<br>  第二步：从文件或标准输入(stdin)读取一行，然后执行pattern{ action;… }语句块，它逐行扫描文件，从第一行到最后一行重复这个过程，直到文件全部被读取完毕。<br>  第三步：当读至输入流末尾时，执行END{action;…}语句块</li>
</ul>
</blockquote>
<p>    BEGIN语句块在awk开始从输入流中读取行之前被执行，这是一个可选的语句块，<br>比如变量初始化、打印输出表格的表头等语句通常可以写在BEGIN语句块中<br>    END语句块在awk从输入流中读取完所有的行之后即被执行，比如打印所有行的分析结果这类信息汇总都是在END语句块中完成，它也是一个可选语句块<br>    pattern语句块中的通用命令是最重要的部分，也是可选的。如果没有提供pattern语句块，则默认执行<code>{ print }</code>，即打印每一个读取到的行，awk读取的每一行都会执行该语句块</p>
<h2 id="awk的输出命令之一：print"><a href="#awk的输出命令之一：print" class="headerlink" title="awk的输出命令之一：print"></a>awk的输出命令之一：print</h2><p>print格式：print item1, item2, …</p>
<blockquote>
<p>item:字符串，用引号引用;</p>
<blockquote>
<p>print “hello”,”world”</p>
</blockquote>
</blockquote>
<blockquote>
<p>变量：显示变量的值，也可以直接使用变量的名进行引用;</p>
<blockquote>
<p>print name</p>
</blockquote>
</blockquote>
<p>要点：</p>
<ol>
<li>各item之间需要逗号分隔：而输出的分隔符为默认空白字符;</li>
<li>输出item可以字符串，也可是数值；当前记录的字段、变量或awk的表达式:数值会被隐士转换为字符串进行输出；</li>
<li>如省略item，相当于”print $0”,用于输出整行;</li>
<li>输出空白字符：print “ “</li>
</ol>
<p>示例：</p>
<blockquote>
<p>awk -F: ‘{print}’ /etc/passwd 等同于 awk -F: ‘{print $0}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#cat /etc/passwd</span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt; bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print&#125;' /etc/passwd</span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt; bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘{print “wang”}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print "wang"&#125;' /etc/passwd  </span></span><br><span class="line">&gt; <span class="comment"># 以：为分隔符，打印wang</span></span><br><span class="line">&gt; wang</span><br><span class="line">&gt; wang</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘{print $1}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print $1&#125;' /etc/passwd  </span></span><br><span class="line">&gt; <span class="comment"># 以：为分隔符，打印第一列</span></span><br><span class="line">&gt; root</span><br><span class="line">&gt; bin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘{print 1”\t”1”\t”3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print $1" \t"$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; <span class="comment"># 以：为分隔符，打印第一列、第三列加上空格和制表符</span></span><br><span class="line">&gt; root    0</span><br><span class="line">&gt; bin     1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>grep “^UUID” /etc/fstab | awk ‘{print 2,2,4}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#grep "^UUID" /etc/fstab | awk '&#123;print $2,$4&#125;'</span></span><br><span class="line">&gt; / defaults</span><br><span class="line">&gt; /boot defaults</span><br><span class="line">&gt; /data defaults</span><br><span class="line">&gt; swap defaults</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="awk变量"><a href="#awk变量" class="headerlink" title="awk变量"></a>awk变量</h1><p>变量：内置和自定义变量</p>
<h2 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h2><ol>
<li><p>FS：输入字段分隔符，默认为空白字符</p>
<blockquote>
<p>awk -v FS=’:’ ‘{print 1,FS,1,FS,3}’ /etc/passwd<br>等同于awk -F: ‘{print 1,”:”,1,”:”,3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -v FS=':' '&#123;print $1,FS,$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; root : 0</span><br><span class="line">&gt; bin : 1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>OFS：输出字段分隔符，默认为空白字符</p>
<blockquote>
<p>awk -v FS=’:’ -v OFS=’:’ ‘{print 1,1,3,$7}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -v FS=':' -v OFS=':' '&#123;print $1,$3,$7&#125;' /etc/passwd</span></span><br><span class="line">&gt; root:0:/bin/bash</span><br><span class="line">&gt; bin:1:/sbin/nologin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>RS：输入记录分隔符，指定输入时的换行符</p>
<blockquote>
<p>awk -v RS=’:’ ‘{print }’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -v RS=':' '&#123;print &#125;' /etc/passwd</span></span><br><span class="line">&gt; root</span><br><span class="line">&gt; x</span><br><span class="line">&gt; 0</span><br><span class="line">&gt; 0</span><br><span class="line">&gt; root</span><br><span class="line">&gt; /root</span><br><span class="line">&gt; /bin/bash</span><br><span class="line">&gt; bin</span><br><span class="line">&gt; x</span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 1</span><br><span class="line">&gt; bin</span><br><span class="line">&gt; /bin</span><br><span class="line">&gt; /sbin/nologin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>ORS：输出记录分隔符，输出时用指定符号代替换行符</p>
<blockquote>
<p>awk -v RS=’:’ -v ORS=’\t’ ‘{print }’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -v RS=':' -v ORS='\t' '&#123;print &#125;' /etc/passwd   </span></span><br><span class="line">&gt; root    x       0       0       root    /root   /bin/bash</span><br><span class="line">&gt; bin     x       1       1       bin     /bin    /sbin/nologin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>NF：字段数量</p>
<blockquote>
<p>awk -F: ‘{print NF}’ /etc/passwd 引用变量时，变量前不需加$</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print NF&#125;' /etc/passwd</span></span><br><span class="line">&gt; 7</span><br><span class="line">&gt; 7</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk -F: ‘{print $(NF-1)}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print $(NF-1)&#125;' /etc/passwd</span></span><br><span class="line">&gt; /root</span><br><span class="line">&gt; /bin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>NR：记录号(如果是多个文件，它会一起计数的)</p>
<blockquote>
<p>awk ‘{print NR}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print NR&#125;' /etc/passwd</span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk END’{print NR}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk END'&#123;print NR&#125;' /etc/passwd </span></span><br><span class="line">&gt; 58</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>FNR：各文件分别计数,记录号</p>
<blockquote>
<p>awk ‘{print FNR}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print FNR&#125;' /etc/passwd</span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>FILENAME：当前文件名</p>
<blockquote>
<p>awk ‘{print FILENAME}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print FILENAME&#125;' /etc/fstab </span></span><br><span class="line">&gt; /etc/fstab</span><br><span class="line">&gt; /etc/fstab</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>ARGC：命令行参数的个数</p>
<blockquote>
<p>awk ‘{print ARGC}’ /etc/fstab /etc/inittab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print ARGC&#125;' /etc/passwd</span></span><br><span class="line">&gt; 2</span><br><span class="line">&gt; 2</span><br><span class="line">&gt; ``` </span><br><span class="line">&gt; 10. ARGV：数组，保存的是命令行所给定的各参数  </span><br><span class="line">&gt; &gt;awk <span class="string">'&#123;print ARGV[0]&#125;'</span> /etc/passwd  </span><br><span class="line">&gt; ```bash</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print ARGV[0]&#125;' /etc/passwd  </span></span><br><span class="line">&gt; awk</span><br><span class="line">&gt; awk</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;print ARGV[1]&#125;' /etc/passwd </span></span><br><span class="line">&gt; /etc/passwd</span><br><span class="line">&gt; /etc/passwd</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<h2 id="自定义变量-区分字符大小写"><a href="#自定义变量-区分字符大小写" class="headerlink" title="自定义变量(区分字符大小写)"></a>自定义变量(区分字符大小写)</h2><ol>
<li><p>-v var=value</p>
</li>
<li><p>在program中直接定义</p>
<p> 示例：</p>
<blockquote>
<p>awk -v name=”test” ‘{print $1,name}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -v name="test" '&#123;print $1,name&#125;' /etc/fstab </span></span><br><span class="line">&gt;  <span class="built_in">test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; <span class="comment"># test</span></span><br><span class="line">&gt; UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 <span class="built_in">test</span></span><br><span class="line">&gt; UUID=7d1b5c8d-8054-4496-befe-267963e07605 <span class="built_in">test</span></span><br><span class="line">&gt; UUID=7556e4a8-128e-457f-99f7-3f1ccf517952 <span class="built_in">test</span></span><br><span class="line">&gt; UUID=152e9015-e93a-44f9-8c7d-65fe67fb5201 <span class="built_in">test</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk ‘{sex=”male”;print $1,sex,age;age=”18”}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;sex="male";print $1,sex,age;age="18"&#125;' /etc/fstab </span></span><br><span class="line">&gt;  male        <span class="comment">#第一次age变量没有值，为空。所以变量应该先赋值，后使用</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; <span class="comment"># male 18</span></span><br><span class="line">&gt; UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 male 18</span><br><span class="line">&gt; UUID=7d1b5c8d-8054-4496-befe-267963e07605 male 18</span><br><span class="line">&gt; UUID=7556e4a8-128e-457f-99f7-3f1ccf517952 male 18</span><br><span class="line">&gt; UUID=152e9015-e93a-44f9-8c7d-65fe67fb5201 male 18</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]<span class="comment">#cat awkscript</span></span><br><span class="line">&#123;<span class="built_in">print</span> script,<span class="variable">$1</span>,<span class="variable">$2</span>&#125;    <span class="comment">#print的内容可以写在一个脚本，可以用 -f  调用。</span></span><br><span class="line">[root@cetos7 ~]<span class="comment">#awk -F: -f awkscript script="awk" /etc/passwd</span></span><br><span class="line">awk root x</span><br><span class="line">awk bin x</span><br><span class="line">awk daemon x</span><br><span class="line">awk adm x</span><br></pre></td></tr></table></figure>
<h1 id="awk的输出命令之二-printf命令"><a href="#awk的输出命令之二-printf命令" class="headerlink" title="awk的输出命令之二:printf命令"></a>awk的输出命令之二:printf命令</h1><p>格式化输出：printf “FORMAT” , item1, item2, …</p>
<ul>
<li>必须指定FORMAT</li>
<li>不会自动换行，需要显式给出换行控制符，\n</li>
<li>FORMAT中需要分别为后面每个item指定格式符</li>
</ul>
<ol>
<li>格式符：与item一一对应<br> %c：显示字符的ASCII码<br> %d, %i：显示十进制整数<br> %e, %E：显示科学计数法数值<br> %f：显示为浮点数<br> %g, %G：以科学计数法或浮点形式显示数值<br> %s：显示字符串<br> %u：无符号整数<br> %%：显示%自身</li>
<li>修饰符<br> #[.#] 第一个数字控制显示的宽度；第二个#表示小数点后精度，%3.1f</li>
</ol>
<ul>
<li><p>左对齐（默认右对齐） %-15s</p>
</li>
<li><p>显示数值的正负符号 %+dprintf示例</p>
<p>  示例：</p>
<blockquote>
<p>awk -F: ‘{printf “%s”,$1}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;printf "%s",$1&#125;'  /etc/passwd  </span></span><br><span class="line">&gt; rootbindaemonadmlpsyncshutdownhaltmailoperatorgamesftpnobodysystemd-networkdbuspolkitdlibstoragemgmtrpccolordsaslauthabrtsetroubleshootrtkitchronyrpcusernfsnobodyqemuunboundglustertssusbmuxdgeoclueradvdpulsegdmgnome-initial-setupsshdavahipostfixntptcpdumpxiealiceyanglizhaohuappapp2webuserapp3zhanggentoomagetomcatapachememcachedhttpd</span><br><span class="line">&gt; ```   </span><br><span class="line">&gt; &gt;awk -F: <span class="string">'&#123;printf "%-20s %10d\n",$1,$3&#125;'</span> /etc/passwd  </span><br><span class="line">&gt; </span><br><span class="line">&gt; &gt;awk -F: <span class="string">'&#123;printf "Username: %s,UID:%d\n",$1,$3&#125;'</span> /etc/passwd </span><br><span class="line">&gt; ```bash</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;printf "Username: %s,UID:%d\n",$1,$3&#125;' /etc/passwd  </span></span><br><span class="line">&gt; Username: root,UID:0</span><br><span class="line">&gt; Username: bin,UID:1</span><br><span class="line">&gt; ``` </span><br><span class="line">&gt; &gt;awk -F: <span class="string">'&#123;printf "Username: %15s,UID:%d\n",$1,$3&#125;'</span> /etc/passwd  </span><br><span class="line">&gt; ```bash</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;printf "Username: %15s,UID:%d\n",$1,$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; Username:            root,UID:0</span><br><span class="line">&gt; Username:             bin,UID:1</span><br><span class="line">&gt; Username:          daemon,UID:2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<blockquote>
<p>awk -F: ‘{printf “Username: %-15s,UID:%d\n”,1,1,3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;printf "Username: %-15s,UID:%d\n",$1,$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; Username: root           ,UID:0</span><br><span class="line">&gt; Username: bin            ,UID:1</span><br><span class="line">&gt; Username: daemon         ,UID:2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h1><ol>
<li><p>算术操作符：<br> x+y, x-y, x*y, x/y, x^y, x%y<br> -x：转换为负数<br> +x：将字符串转换为数值</p>
</li>
<li><p>字符串操作符：没有符号的操作符，字符串连接</p>
</li>
<li><p>赋值操作符：<br> =, +=, -=, *=, /=, %=, ^=，++, –<br> 下面两语句有何不同</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk ‘BEGIN&#123;i=0;<span class="built_in">print</span> ++i,i&#125;’  <span class="comment">#先自加再打印</span></span><br><span class="line">awk ‘BEGIN&#123;i=0;<span class="built_in">print</span> i++,i&#125;’  <span class="comment">#先打印再自加</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>比较操作符：<br> ==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
</li>
<li><p>模式匹配符：</p>
<p> ~：左边是否和右边匹配，包含</p>
<p> !~：是否不匹配</p>
<p> 示例：</p>
<blockquote>
<p>awk -F: ‘0 ~ /root/{print0 ~ /root/{print1}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$0 ~ /root/&#123;print $1&#125;' /etc/passwd   </span></span><br><span class="line">&gt; root</span><br><span class="line">&gt; operator</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk ‘$0~”^root”‘ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '$0~"^root"' /etc/passwd  </span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘$3==0’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$3==0' /etc/passwd   </span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>逻辑操作符：与&amp;&amp;，或||，非!</p>
<p> 示例：</p>
<blockquote>
<p>awk -F: ‘3&gt;1000{print3&gt;1000{print1,$3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$3&gt;1000&#123;print $1,$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; nfsnobody 65534</span><br><span class="line">&gt; alice 1003</span><br><span class="line">&gt; yang 1004</span><br><span class="line">&gt; ·········</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk -F: ‘3&lt;1000{print3&lt;1000{print1,$3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$3&lt;1000&#123;print $1,$3&#125;' /etc/passwd </span></span><br><span class="line">&gt; root 0</span><br><span class="line">&gt; bin 1</span><br><span class="line">&gt; daemon 2</span><br><span class="line">&gt; ·········</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>条件表达式（三目表达式）</p>
<p> selector?if-true-expression:if-false-expression</p>
<p> 示例：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]<span class="comment">#awk -F: '&#123;$3&gt;=1000 ? usertype="Common User":usertype="SysUser";printf "%15s:%-s\n",$1,usertype&#125;' /etc/passwd</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="awk-PATTERN"><a href="#awk-PATTERN" class="headerlink" title="awk PATTERN"></a>awk PATTERN</h2><p>PATTERN:根据pattern条件，过滤匹配的行，再做处理</p>
<ol>
<li><p>如果未指定：空模式，匹配每一行</p>
</li>
<li><p>/regular expression/：仅处理能够模式匹配到的行，需要用/ /括起来</p>
<blockquote>
<p>awk ‘/^UUID/{print $1}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '/^UUID/&#123;print $1&#125;' /etc/fstab </span></span><br><span class="line">&gt; UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920</span><br><span class="line">&gt; UUID=7d1b5c8d-8054-4496-befe-267963e07605</span><br><span class="line">&gt; UUID=7556e4a8-128e-457f-99f7-3f1ccf517952</span><br><span class="line">&gt; UUID=152e9015-e93a-44f9-8c7d-65fe67fb5201</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk ‘!/^UUID/{print $1}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '!/^UUID/&#123;print $1&#125;' /etc/fstab </span></span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt; <span class="comment">#</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>relational expression: 关系表达式，结果为“真”才会被处理</p>
<p> 真：结果为非0值，非空字符串</p>
<p> 假：结果为空字符串或0值</p>
<p> 示例：</p>
<blockquote>
<p>awk -F: ‘i=1;j=1{print i,j}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: 'i=1;j=1&#123;print i,j&#125;' /etc/passwd</span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt; 1 1</span><br><span class="line">&gt; bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">&gt; 1 1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk ‘!0’ /etc/passwd ; awk ‘!1’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '!0' /etc/passwd</span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt; bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '!1' /etc/passwd</span></span><br><span class="line">&gt; root:x:0:0:root:/root:/bin/bash</span><br><span class="line">&gt; bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘NF==”/bin/bash” {printNF==”/bin/bash” {print1,$NF}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$NF=="/bin/bash" &#123;print $1,$NF&#125;' /etc/passwd       </span></span><br><span class="line">&gt; root /bin/bash</span><br><span class="line">&gt; xie /bin/bash</span><br><span class="line">&gt; alice /bin/bash</span><br><span class="line">&gt; yang /bin/bash</span><br><span class="line">&gt; li /bin/bash</span><br><span class="line">&gt; zhao /bin/bash</span><br><span class="line">&gt; hu /bin/bash</span><br><span class="line">&gt; app /bin/bash</span><br><span class="line">&gt; app3 /bin/bash</span><br><span class="line">&gt; zhang /bin/bash</span><br><span class="line">&gt; mage /bin/bash</span><br><span class="line">&gt; tomcat /bin/bash</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘NF /bashNF /bash/{print 1,1,NF}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '$NF ~ /bash$/&#123;print $1,$NF&#125;' /etc/passwd</span></span><br><span class="line">&gt; root /bin/bash</span><br><span class="line">&gt; xie /bin/bash</span><br><span class="line">&gt; alice /bin/bash</span><br><span class="line">&gt; yang /bin/bash</span><br><span class="line">&gt; li /bin/bash</span><br><span class="line">&gt; zhao /bin/bash</span><br><span class="line">&gt; hu /bin/bash</span><br><span class="line">&gt; app /bin/bash</span><br><span class="line">&gt; app3 /bin/bash</span><br><span class="line">&gt; zhang /bin/bash</span><br><span class="line">&gt; mage /bin/bash</span><br><span class="line">&gt; tomcat /bin/bash</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>line ranges：行范围</p>
<p> startline,endline：/pat1/,/pat2/ 不支持直接给出数字格式</p>
<blockquote>
<p>awk -F: ‘/^root/,/^adm/{print $1}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '/^root/,/^adm/&#123;print $1&#125;' /etc/passwd</span></span><br><span class="line">&gt; root</span><br><span class="line">&gt; bin</span><br><span class="line">&gt; daemon</span><br><span class="line">&gt; adm</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk -F: ‘(NR&gt;5&amp;&amp;NR&lt;10){print NR,$1}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '(NR&gt;5&amp;&amp;NR&lt;10)&#123;print NR,$1&#125;' /etc/passwd      </span></span><br><span class="line">&gt; 6 sync</span><br><span class="line">&gt; 7 shutdown</span><br><span class="line">&gt; 8 halt</span><br><span class="line">&gt; 9 mail</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>BEGIN/END模式</p>
<p> BEGIN{}：仅在开始处理文件中的文本之前执行一次</p>
<p> END{}：仅在文本处理完成之后执行一次</p>
<p> 示例 :</p>
<blockquote>
<p>awk -F: ‘BEGIN{print “USER USERID”} {print 1”:”1”:”3} END{print “END FILE”}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: 'BEGIN&#123;print "USER USERID"&#125; &#123;print $1":"$3&#125; END&#123;print "END FILE"&#125;' /etc/passwd</span></span><br><span class="line">&gt; USER USERID</span><br><span class="line">&gt; root:0</span><br><span class="line">&gt; bin:1</span><br><span class="line">&gt; ······</span><br><span class="line">&gt; memcached:986</span><br><span class="line">&gt; httpd:80</span><br><span class="line">&gt; END FILE</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk -F: ‘{print “USER USERID”;print 1”:”1”:”3} END{print “END FILE”}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: '&#123;print "USER USERID";print $1":"$3&#125; END&#123;print "END FILE"&#125;' /etc/passwd  </span></span><br><span class="line">&gt; USER USERID</span><br><span class="line">&gt; root:0</span><br><span class="line">&gt; USER USERID</span><br><span class="line">&gt; bin:1</span><br><span class="line">&gt; ······</span><br><span class="line">&gt; USER USERID</span><br><span class="line">&gt; memcached:986</span><br><span class="line">&gt; USER USERID</span><br><span class="line">&gt; httpd:80</span><br><span class="line">&gt; END FILE</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘BEGIN{print “USER UID \n————— “}{print 1,1,3}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: 'BEGIN&#123;print "USER UID \n--------------- "&#125;&#123;print $1,$3&#125;' /etc/passwd</span></span><br><span class="line">&gt; USER UID </span><br><span class="line">&gt; --------------- </span><br><span class="line">&gt; root 0</span><br><span class="line">&gt; bin 1</span><br><span class="line">&gt; ······</span><br><span class="line">&gt; memcached:986</span><br><span class="line">&gt; httpd:80</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk -F: ‘BEGIN{print “USER UID \n—————– “}{print 1,1,3}END{print”=================”}’ /etc/passwd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk -F: 'BEGIN&#123;print "USER UID \n----------------- "&#125;&#123;print $1,$3&#125;END&#123;print"================="&#125;'  /etc/passwd </span></span><br><span class="line">&gt; USER UID </span><br><span class="line">&gt; ----------------- </span><br><span class="line">&gt; root 0</span><br><span class="line">&gt; bin 1</span><br><span class="line">&gt; ······</span><br><span class="line">&gt; memcached 986</span><br><span class="line">&gt; httpd 80</span><br><span class="line">&gt; =================</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>seq 5 | awk ‘i=0’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk 'i=0'</span></span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>seq 5 | awk ‘i=1’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk 'i=1'  </span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 2</span><br><span class="line">&gt; 3</span><br><span class="line">&gt; 4</span><br><span class="line">&gt; 5</span><br><span class="line">&gt; ``` </span><br><span class="line">&gt; &gt;seq 5 | awk <span class="string">'i=!i'</span>  </span><br><span class="line">&gt; ```bash</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk 'i=!i' </span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 3</span><br><span class="line">&gt; 5</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>seq 5 | awk ‘{i=!i;print i}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk '&#123;i=!i;print i&#125;'</span></span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 0</span><br><span class="line">&gt; 1</span><br><span class="line">&gt; 0</span><br><span class="line">&gt; 1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>seq 5 | awk ‘!(i=!i)’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk '!(i=!i)</span></span><br><span class="line">&gt; 2</span><br><span class="line">&gt; 4</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>seq 5 | awk -v i=1 ‘i=!i’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#seq 5 | awk -v i=1 'i=!i'</span></span><br><span class="line">&gt; 2</span><br><span class="line">&gt; 4</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="awk-action"><a href="#awk-action" class="headerlink" title="awk action"></a>awk action</h1><p>常用的action分类</p>
<ul>
<li><p>Expressions：算术，比较表达式等</p>
</li>
<li><p>Control statements：if, while等</p>
</li>
<li><p>Compound statements：组合语句</p>
</li>
<li><p>input statements</p>
</li>
<li><p>output statements：print等</p>
<h1 id="awk控制语句"><a href="#awk控制语句" class="headerlink" title="awk控制语句"></a>awk控制语句</h1></li>
</ul>
<ol>
<li><p>if-else</p>
<p> 语法：if(condition){statement;…}[else statement]</p>
<p> if(condition1){statement1}else if(condition2){statement2}else{statement3}</p>
<p> 使用场景：对awk取得的整行或某个字段做条件判断</p>
<p> 示例：</p>
<blockquote>
<p>df -h|awk -F% ‘/^\/dev/{print 1}’|awk ‘1}’|awk ‘NF&gt;=10{print 1,1,5}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#df -h|awk -F% '/^\/dev/&#123;print $1&#125;'|awk '$NF&gt;=10&#123;print $1,$5&#125;'  </span></span><br><span class="line">&gt; /dev/sda2 21</span><br><span class="line">&gt; /dev/sda1 17</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<blockquote>
<p>awk ‘BEGIN{ test=100;if(test&gt;90){print “very good”}else if(test&gt;60){ print “good”}else{print “no pass”}}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123; test=100;if(test&gt;90)&#123;print "very good"&#125;else if(test&gt;60)&#123; print "good"&#125;else&#123;print "no pass"&#125;&#125;'  </span></span><br><span class="line">&gt; very good</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>while循环<br> 语法：while(condition){statement;…}<br> 条件“真”，进入循环；条件“假”，退出循环<br> 使用场景：<br> 对一行内的多个字段逐一类似处理时使用<br> 对数组中的各元素逐一处理时使用<br> 示例：</p>
<blockquote>
<p>awk ‘/^[[:space:]]*linux16/{i=1;while(i&lt;=NF){if(length(i)&gt;=10){printi)&gt;=10){print1,length($i)};i++}}’ /etc/grub2.cfg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '/^[[:space:]]*linux16/&#123;i=1;while(i&lt;=NF)&#123;if(length($i)&gt;=10)&#123;print $1,length($i)&#125;;i++&#125;&#125;' /etc/grub2.cfg </span></span><br><span class="line">&gt; linux16 30</span><br><span class="line">&gt; linux16 46</span><br><span class="line">&gt; linux16 16</span><br><span class="line">&gt; linux16 16</span><br><span class="line">&gt; linux16 50</span><br><span class="line">&gt; linux16 46</span><br><span class="line">&gt; linux16 16</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>do-while循环<br> 语法：do {statement;…}while(condition)<br> 意义：无论真假，至少执行一次循环体<br> 示例：</p>
<blockquote>
<p>awk ‘BEGIN{total=0;i=0;do{ total+=i;i++ } while( i&lt;=100 );print total}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123;total=0;i=0;do&#123; total+=i;i++ &#125; while( i&lt;=100 );print total&#125;'</span></span><br><span class="line">&gt; 5050</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>for循环<br> 语法：for(expr1;expr2;expr3) {statement;…}<br> 常见用法：<br> for(variable assignment;condition;iteration process)<br> {for-body}</p>
</li>
<li><p>特殊用法：能够遍历数组中的元素<br> 语法：for(var in array) {for-body}<br> 示例：</p>
<blockquote>
<p>awk ‘/^[[:space:]]*linux16/{for(i=1;i&lt;=NF;i++) {print i,length(i,length(i)}}’ /etc/grub2.cfg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt;             ^ syntax error</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '/^[[:space:]]*linux16/&#123;for(i=1;i&lt;=NF;i++) &#123;print $i,length($i)&#125;&#125;' /etc/grub2.cfg</span></span><br><span class="line">&gt; linux16 7</span><br><span class="line">&gt; /vmlinuz-3.10.0-862.el7.x86_64 30</span><br><span class="line">&gt; root=UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 46</span><br><span class="line">&gt; ro 2</span><br><span class="line">&gt; crashkernel=auto 16</span><br><span class="line">&gt; rhgb 4</span><br><span class="line">&gt; quiet 5</span><br><span class="line">&gt; LANG=en_US.UTF-8 16</span><br><span class="line">&gt; linux16 7</span><br><span class="line">&gt; /vmlinuz-0-rescue-adda87b767b846f69b46c9188469daa7 50</span><br><span class="line">&gt; root=UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 46</span><br><span class="line">&gt; ro 2</span><br><span class="line">&gt; crashkernel=auto 16</span><br><span class="line">&gt; rhgb 4</span><br><span class="line">&gt; quiet 5</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>switch语句<br> 语法：switch(expression) {case VALUE1 or /REGEXP/: statement1; case<br> VALUE2 or /REGEXP2/: statement2; …; default: statementn}</p>
</li>
<li><p>break和continue</p>
<p> continue:满足条件则结束本次循环，不满足条件，继续执行。</p>
<blockquote>
<p>awk ‘BEGIN{sum=0;for(i=1;i&lt;=100;i++){if(i%2==0)continue;sum+=i}print sum}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123;sum=0;for(i=1;i&lt;=100;i++)&#123;if(i%2==0)continue;sum+=i&#125;print sum&#125;' </span></span><br><span class="line">&gt; 2500</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<p>break:满足条件则结束整个循环</p>
<blockquote>
<p>awk ‘BEGIN{sum=0;for(i=1;i&lt;=100;i++){if(i==50)break;sum+=i}print sum}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123;sum=0;for(i=1;i&lt;=100;i++)&#123;if(i==50)break;sum+=i&#125;print sum&#125;'   </span></span><br><span class="line">&gt; 1225</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>next:提前结束对本行处理而直接进入下一行处理（awk自身循环）</p>
<blockquote>
<p>awk ‘{if (NR%2==0)next;print NR,$0}’ /etc/fstab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;if (NR%2==0)next;print NR,$0&#125;' /etc/fstab  </span></span><br><span class="line">&gt; 1 </span><br><span class="line">&gt; 3 <span class="comment"># /etc/fstab</span></span><br><span class="line">&gt; 5 <span class="comment">#</span></span><br><span class="line">&gt; 7 <span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line">&gt; 9 UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 /                       xfs     defaults        0 0</span><br><span class="line">&gt; 11 UUID=7556e4a8-128e-457f-99f7-3f1ccf517952 /data                   xfs     defaults        0</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="awk数组"><a href="#awk数组" class="headerlink" title="awk数组"></a>awk数组</h1><ol>
<li><p>关联数组：array[index-expression]</p>
<p> index-expression:</p>
<blockquote>
<p>可使用任意字符串；字符串要使用双引号括起来<br>如果某数组元素事先不存在，在引用时，awk会自动创建此元素，并将其值初始化为“空串”<br>若要判断数组中是否存在某元素，要使用“index in array” 格式进行遍历</p>
</blockquote>
</li>
</ol>
<p>示例：</p>
<blockquote>
<p>awk ‘BEGIN{weekdays[“mon”]=”Monday”;weekdays[“tue”]=”Tuesday”;print weekdays[“mon”]}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123;weekdays["mon"]="Monday";weekdays["tue"]="Tuesday";print weekdays["mon"]&#125;'</span></span><br><span class="line">&gt; Monday</span><br><span class="line">&gt; ```  </span><br><span class="line">&gt; 2. 若要遍历数组中的每个元素，要使用<span class="keyword">for</span>循环  </span><br><span class="line">&gt; <span class="keyword">for</span>(var <span class="keyword">in</span> array) &#123;<span class="keyword">for</span>-body&#125;  </span><br><span class="line">&gt; 注意：var会遍历array的每个索引  </span><br><span class="line">&gt; 示例：  </span><br><span class="line">&gt; awk<span class="string">'BEGIN&#123;weekdays["mon"]="Monday";weekdays["tue"]="Tuesday";for(i in weekdays) &#123;print weekdays[i]&#125;&#125;'</span>  </span><br><span class="line">&gt; &gt;netstat -tan | awk <span class="string">'/^tcp/&#123;state[$NF]++&#125;END&#123;for(i in state) &#123; print i,state[i]&#125;&#125;'</span></span><br><span class="line">&gt; ```bash</span><br><span class="line">&gt; [root@cetos7 ~]<span class="comment">#netstat -tan | awk '/^tcp/&#123;state[$NF]++&#125;END&#123;for(i in state) &#123; print i,state[i]&#125;&#125;'</span></span><br><span class="line">&gt; LISTEN 10</span><br><span class="line">&gt; ESTABLISHED 1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>awk ‘{ip[$1]++}END{for(i in ip) {print i,ip[i]}}’ /var/log/httpd/access_log</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk '&#123;ip[$1]++&#125;END&#123;for(i in ip) &#123;print i,ip[i]&#125;&#125;' /var/log/httpd/access_log       </span></span><br><span class="line">&gt; 192.168.189.129 8</span><br><span class="line">&gt; 192.168.183.140 8</span><br><span class="line">&gt; 192.168.183.1 38</span><br><span class="line">&gt; 192.168.189.1 34</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="awk函数"><a href="#awk函数" class="headerlink" title="awk函数"></a>awk函数</h1><ol>
<li><p>数值处理：<br> rand()：返回0和1之间一个随机数</p>
<blockquote>
<p>awk ‘BEGIN{srand(); for (i=1;i&lt;=5;i++)print int(rand()*100)}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#awk 'BEGIN&#123;srand(); for (i=1;i&lt;=5;i++)print int(rand()*100)&#125;'  </span></span><br><span class="line">&gt; 87</span><br><span class="line">&gt; 77</span><br><span class="line">&gt; 39</span><br><span class="line">&gt; 61</span><br><span class="line">&gt; 76</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>字符串处理：<br> length([s])：返回指定字符串的长度<br> sub(r,s,[t])：对t字符串搜索r表示模式匹配的内容，并将第一个匹配内容替换为s</p>
<blockquote>
<p>echo “2008:08:08 08:08:08” | awk ‘sub(/:/, “-“, $1)’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#echo "2008:08:08 08:08:08" | awk 'sub(/:/,"-",$1)'</span></span><br><span class="line">&gt; 2008-08:08 08:08:08</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<p>gsub(r,s,[t])：对t字符串进行搜索r表示的模式匹配的内容，并全部替换为s所表示的内容</p>
<blockquote>
<p>echo “2008:08:08 08:08:08” | awk ‘gsub(/:/,”-“,$0)’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#echo "2008:08:08 08:08:08" | awk 'gsub(/:/,"-",$0)'</span></span><br><span class="line">&gt; 2008-08-08 08-08-08</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>• split(s,array,[r])：以r为分隔符，切割字符串s，并将切割后的结果保存至array所表示的数组中，第一个索引值为1,第二个索引值为2,…</p>
<blockquote>
<p>netstat -tn | awk ‘/^tcp&gt;/{split($5,ip,”:”);count[ip[1]]++}END{for (i in count) {print i,count[i]}}’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#netstat -tn | awk '/^tcp\&gt;/&#123;split($5,ip,":");count[ip[1]]++&#125;END&#123;for (i in count) &#123;print i,count[i]&#125;&#125;'</span></span><br><span class="line">&gt; 192.168.183.1 1</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>自定义函数格式：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> name ( parameter, parameter, ... ) &#123;</span><br><span class="line">statements</span><br><span class="line"><span class="built_in">return</span> expression</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat fun.awk</span><br><span class="line"><span class="keyword">function</span> max(x,y) &#123;</span><br><span class="line">x&gt;y?var=x:var=y</span><br><span class="line"><span class="built_in">return</span> var</span><br><span class="line">&#125;</span><br><span class="line">BEGIN&#123;a=3;b=2;<span class="built_in">print</span> max(a,b)&#125;</span><br><span class="line">awk -f fun.awk</span><br></pre></td></tr></table></figure>
<h1 id="awk中调用shell命令"><a href="#awk中调用shell命令" class="headerlink" title="awk中调用shell命令"></a>awk中调用shell命令</h1><p>system命令<br>空格是awk中的字符串连接符，如果system中需要使用awk中的变量可以使用空格分隔，或者说除了awk的变量外其他一律用””引用起来<br>awk ‘BEGIN{system(“hostname”) }’<br>awk ‘BEGIN{score=100; system(“echo your score is “ score)}’</p>
<h1 id="awk脚本"><a href="#awk脚本" class="headerlink" title="awk脚本"></a>awk脚本</h1><p>将awk程序写成脚本，直接调用或执行<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat f1.awk</span><br><span class="line">&#123;<span class="keyword">if</span>(<span class="variable">$3</span>&gt;=1000)<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$3</span>&#125;</span><br><span class="line">awk -F: -f f1.awk /etc/passwd</span><br><span class="line">cat f2.awk</span><br><span class="line"><span class="comment">#!/bin/awk –f</span></span><br><span class="line"><span class="comment">#this is a awk script</span></span><br><span class="line">&#123;<span class="keyword">if</span>(<span class="variable">$3</span>&gt;=1000)<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$3</span>&#125;</span><br><span class="line">chmod +x f2.awk</span><br><span class="line">f2.awk –F: /etc/passwd</span><br></pre></td></tr></table></figure>
<p>向awk脚本传递参数<br>格式：<br>awkfile var=value var2=value2… Inputfile<br>注意：在BEGIN过程中不可用。直到首行输入完成以后，变量才可用。可以通过-v 参数，让awk在执行BEGIN之前得到变量的值。命令行中每一个指定的变量都需要一个-v参数<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat test.awk</span><br><span class="line"><span class="comment">#!/bin/awk –f</span></span><br><span class="line">&#123;<span class="keyword">if</span>(<span class="variable">$3</span> &gt;=min &amp;&amp; <span class="variable">$3</span>&lt;=max)<span class="built_in">print</span> <span class="variable">$1</span>,<span class="variable">$3</span>&#125;</span><br><span class="line">chmod +x test.awk</span><br><span class="line">test.awk -F: min=100 max=200 /etc/passwd</span><br></pre></td></tr></table></figure>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><ol>
<li>文件ip_list.txt如下格式，请提取” .magedu.com” 前面的主机名部分并写入到回到该文件中<br> 1 blog.magedu.com<br> 2 <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a><br> …<br> 999 study.magedu.com</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">'[ .]'</span> <span class="string">'&#123;print "."$3"."$4&#125;'</span>  ip_list.txt &gt;&gt; ip_list.txt</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>统计/etc/fstab文件中每个文件系统类型出现的次数</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'/^UUID/&#123;filetype[$3]++&#125;END&#123;for (i in filetype)&#123;print i,filetype[i]&#125;&#125;'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>统计/etc/fstab文件中每个单词出现的次数</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'&#123;i=1;while(i&lt;=NF)&#123;word[$i]++;i++&#125;&#125;END&#123;for(num in word)&#123;print num,word[num]&#125;&#125;'</span> /etc/fstab</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>提取出字符串Yd$C@M05MB%9&amp;Bdh7dq+YVixp3vpw中的所有数字</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Yd<span class="variable">$C</span>@M05MB%9&amp;Bdh7dq+YVixp3vpw"</span>|awk <span class="string">'gsub(/[^0-9]/,"",$0)'</span></span><br><span class="line"><span class="comment">#把不是数字的全部用空代替掉</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>有一文件记录了1-100000之间随机的整数共5000个，存储的格式100,50,35,89…请取出其中最大和最小的整数</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">','</span> <span class="string">'&#123;i=2;max=$1;min=$1;while(i&lt;=NF)&#123;if &#123;$i &gt; max&#125;&#123;max=$i&#125;else if&#123;$i&lt;min&#125;&#123;min=$i&#125;;i++&#125;END&#123;print "max="max,"min="min&#125;'</span> random.txt</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>解决DOS攻击生产案例：根据web日志或者或者网络连接数，监控当某个IP并发连接数或者短时内PV达到100，即调用防火墙命令封掉对应的IP，监控频率每隔5分钟。防火墙命令为：iptables -A INPUT -s IP -j REJECT</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'&#123;access[$1]++&#125;END&#123;for(i in access)&#123;if(access[i]&gt;=100)&#123;print i,access[i]&#125;&#125;&#125;'</span> /var/<span class="built_in">log</span>/httpd/access_log</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>将以下文件内容中FQDN取出并根据其进行计数从高到低排序<br> <a href="http://mail.magedu.com/index.html" target="_blank" rel="noopener">http://mail.magedu.com/index.html</a><br> <a href="http://www.magedu.com/test.html" target="_blank" rel="noopener">http://www.magedu.com/test.html</a><br> <a href="http://study.magedu.com/index.html" target="_blank" rel="noopener">http://study.magedu.com/index.html</a><br> <a href="http://blog.magedu.com/index.html" target="_blank" rel="noopener">http://blog.magedu.com/index.html</a><br> <a href="http://www.magedu.com/images/logo.jpg" target="_blank" rel="noopener">http://www.magedu.com/images/logo.jpg</a><br> <a href="http://blog.magedu.com/20080102.html" target="_blank" rel="noopener">http://blog.magedu.com/20080102.html</a></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F <span class="string">'/'</span> <span class="string">'&#123;fqdn[$3]++&#125;END&#123;for (i in fqdn)&#123;print i fqdn[i]&#125;'</span> filename | sort -k2 -nr</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>将以下文本以inode为标记，对inode相同的counts进行累加，并且统计出同一inode中beginnumber的最小值和endnumber的最大值<br> inode|beginnumber|endnumber|counts|<br> 106|3363120000|3363129999|10000|<br> 106|3368560000|3368579999|20000|<br> 310|3337000000|3337000100|101|<br> 310|3342950000|3342959999|10000|<br> 310|3362120960|3362120961|2|<br> 311|3313460102|3313469999|9898|<br> 311|3313470000|3313499999|30000|<br> 311|3362120962|3362120963|2|<br> 输出的结果格式为：<br> 310|3337000000|3362120961|10103|<br> 311|3313460102|3362120963|39900|</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">'|'</span> <span class="string">'NR==1&#123;print;next&#125;&#123;a[$1]?(a[$1]&gt;$2?a[$1]=$2:0):(a[$1]=$2);b[$1]?(b[$1]&lt;$3?b[$1]=$3:0):(b[$1]=$3);c[$1]+=$4&#125;END&#123;l=asorti(a,d);for(i=1;i&lt;=l;i++)print d[i] FS a[d[i]] FS b[d[i]] FS c[d[i]] FS&#125;'</span> f1.txt</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/文本三剑客之grep/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/文本三剑客之grep/" itemprop="url">文本三剑客之grep</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="grep-and-Regular-Expressions"><a href="#grep-and-Regular-Expressions" class="headerlink" title="grep and Regular Expressions"></a>grep and Regular Expressions</h1><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%B0%81%E9%9D%A2.jpg?raw=true" alt=""></p>
<h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/grep.jpg?raw=true" alt=""><br>&ensp;&ensp;&ensp;&ensp;grep: Global search REgular expression and Print out the line,是一款文本过滤工具。<br>&ensp;&ensp;&ensp;&ensp;作用：文本搜索工具，根据用户指定的“模式”对目标文本逐行进行匹配检查；打印匹配到的行。<br>&ensp;&ensp;&ensp;&ensp;模式：由正则表达式字符及文本字符所编写的过滤条件。<br>&ensp;&ensp;&ensp;&ensp;正则表达式REGEXP： Regular Expressions，由一类特殊字符及文本字符所编写的模式，其中有些字符（元字符）不表示字符字面意义，而表示控制或通配的功能。  </p>
<p>正则表达式分两类：  </p>
<ul>
<li>基本正则表达式： BRE</li>
<li>扩展正则表达式： ERE<br>grep工具支持基本正则表达式，egrep工具支持扩展的正则表达式，并且grep -E = egrep.</li>
</ul>
<h2 id="grep语法"><a href="#grep语法" class="headerlink" title="grep语法"></a><strong><em>grep语法</em></strong></h2><p>grep [OPTIONS] PATTERN [FILE…]   </p>
<ul>
<li>-v: 显示不被pattern匹配到的行  </li>
<li>-i: 忽略字符大小写  </li>
<li>-n： 显示匹配的行号  </li>
<li>-c: 统计匹配的行数  </li>
<li>-o: 仅显示匹配到的字符串    </li>
<li>-q: 静默模式，不输出任何信息  </li>
<li>-A #: after, 后#行  </li>
<li>-B #: before, 前#行  </li>
<li>-C #： context, 前后各#行</li>
<li>-e：实现多个选项间的逻辑or关系</li>
<li>-w：匹配整个单词</li>
<li>-E：使用ERE</li>
<li>-F：相当于fgrep，不支持正则表达式</li>
<li>-f file: 根据模式文件处理</li>
</ul>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.jpg?raw=true" alt=""></p>
<h2 id="基本正则表达式元字符"><a href="#基本正则表达式元字符" class="headerlink" title="基本正则表达式元字符"></a>基本正则表达式元字符</h2><h3 id="字符匹配"><a href="#字符匹配" class="headerlink" title="字符匹配"></a><strong><em>字符匹配</em></strong></h3><ul>
<li><p>.  &ensp; &ensp;&ensp;&ensp;匹配任意单个字符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#grep "r..t" /etc/passwd </span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br></pre></td></tr></table></figure>
</li>
<li><p>[] &ensp; &ensp;&ensp;匹配指定范围内的任意单个字符，示例:[wang] [0-9] [a-z] [a-zA-Z]</p>
</li>
<li>[^] &ensp;&ensp;匹配指定范围外的任意单个字符</li>
<li>[:alnum:] 字母和数字</li>
<li>[:alpha:] 代表任何英文大小写字符，亦即 A-Z, a-z</li>
<li>[:lower:] 小写字母,亦即 a-z  </li>
<li>[:upper:] 大写字母,亦即 A-Z</li>
<li>[:blank:] 空白字符（空格和制表符）</li>
<li>[:space:] 水平和垂直的空白字符（比[:blank:]包含的范围广）</li>
<li>[:cntrl:] 不可打印的控制字符（退格、删除、警铃…）</li>
<li>[:digit:] 十进制数字   </li>
<li>[:xdigit:] 十六进制数字</li>
<li>[:graph:] 可打印的非空白字符</li>
<li>[:print:] 可打印字符</li>
<li>[:punct:] 标点符号<br>例  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ifconfig ens33 | grep netmask | grep "[[:digit:]]."</span></span><br><span class="line">        inet 192.168.183.132  netmask 255.255.255.0  broadcast 192.168.183.255</span><br><span class="line">等价于</span><br><span class="line">[root@localhost data]<span class="comment">#ifconfig ens33 | grep netmask | grep "[0-9]."      </span></span><br><span class="line">        inet 192.168.183.132  netmask 255.255.255.0  broadcast 192.168.183.255</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="次数匹配"><a href="#次数匹配" class="headerlink" title="次数匹配"></a><strong><em>次数匹配</em></strong></h3><p><code>用在要指定次数的字符后面，用于指定前面的字符要出现的次数</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*  匹配前面的字符任意次，包括0次  </span><br><span class="line">贪婪模式：尽可能长的匹配.默认正则表达式为贪婪模式  </span><br><span class="line">.* 任意长度的任意字符  </span><br><span class="line">\? 匹配其前面的字符0或1次  </span><br><span class="line">\+ 匹配其前面的字符至少1次  </span><br><span class="line">\&#123;n\&#125; 匹配前面的字符n次  </span><br><span class="line">\&#123;m,n\&#125; 匹配前面的字符至少m次，至多n次  </span><br><span class="line">\&#123;,n\&#125; 匹配前面的字符至多n次  </span><br><span class="line">\&#123;n,\&#125; 匹配前面的字符至少n次正则表达式</span><br></pre></td></tr></table></figure></p>
<p>例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ifconfig ens33 | grep "[0-9]\&#123;1,3\&#125;"    </span></span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.183.132  netmask 255.255.255.0  broadcast 192.168.183.255</span><br><span class="line">        inet6 fe80::bf41:5d04:86fa:37c9  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:30:79:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 7676  bytes 850492 (830.5 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 6678  bytes 2198697 (2.0 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">例:只显示ifconfig ens33 的ip</span><br><span class="line"></span><br><span class="line">[root@localhost data]<span class="comment">#ifconfig ens33 | grep -o  "[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;"</span></span><br><span class="line">192.168.183.132</span><br><span class="line">255.255.255.0</span><br><span class="line">192.168.183.255</span><br></pre></td></tr></table></figure></p>
<h3 id="位置锚定"><a href="#位置锚定" class="headerlink" title="位置锚定"></a><strong><em>位置锚定</em></strong></h3><p><code>定位出现的位置</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">* ^ 行首锚定，用于模式的最左侧  </span><br><span class="line">* $ 行尾锚定，用于模式的最右侧  </span><br><span class="line">* ^PATTERN$ 用于模式匹配整行  </span><br><span class="line">* ^$ 空行  </span><br><span class="line">* ^[[:space:]]*$ 空白行</span><br><span class="line">* \&lt; 或 \b 词首锚定，用于单词模式的左侧  </span><br><span class="line">* \&gt; 或 \b 词尾锚定，用于单词模式的右侧  </span><br><span class="line">* \&lt;PATTERN\&gt; 匹配整个单词正则表达式  </span><br><span class="line">``` </span><br><span class="line">```bash </span><br><span class="line">例:只显示/etc/fstab非空的行</span><br><span class="line"></span><br><span class="line">[root@localhost data]<span class="comment">#cat /etc/fstab  | grep  -v "^#" | grep -v "^$"</span></span><br><span class="line">UUID=d33ffb51-004a-4c4d-ac00-c40b9e2c2920 /                       xfs     defaults        0 0</span><br><span class="line">UUID=7d1b5c8d-8054-4496-befe-267963e07605 /boot                   xfs     defaults        0 0</span><br><span class="line">UUID=7556e4a8-128e-457f-99f7-3f1ccf517952 /data                   xfs     defaults        0 0</span><br><span class="line">UUID=152e9015-e93a-44f9-8c7d-65fe67fb5201 swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">显示以root为单词词首的行</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment">#grep "\&lt;root" /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br></pre></td></tr></table></figure>
<h3 id="分组"><a href="#分组" class="headerlink" title="_分组_"></a><strong>_分组_</strong></h3><p><code>\(\) 将一个或多个字符捆绑在一起，当作一个整体处理，如： \(root\)\+</code>  </p>
<ul>
<li>分组括号中的模式匹配到的内容会被正则表达式引擎记录于内部的变量中，这些<br>变量的命名方式为: \1, \2, \3, …  </li>
<li><p>\1 表示从左侧起第一个左括号以及与之匹配右括号之间的模式所匹配到的字符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\(string1\+\(string2\)*\)</span><br><span class="line">\1 ： string1\+\(string2\)*</span><br><span class="line">\2 ： string2</span><br></pre></td></tr></table></figure>
</li>
<li><p>后向引用：引用前面的分组括号中的模式所匹配字符(结果)， 而非模式本身</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#cat f1</span></span><br><span class="line">123ab123xxy123</span><br><span class="line">234xxx567</span><br><span class="line">[root@localhost ~]<span class="comment">#cat f1 | grep "\([0-9]\)\&#123;3\&#125;.*\1"</span></span><br><span class="line">123ab123xxy123</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者：\|<br>示例： a\|b: a或b C\|cat: C或cat \(C\|c\)at:Cat或cat</p>
</li>
</ul>
<h2 id="扩展的正则表达式"><a href="#扩展的正则表达式" class="headerlink" title="扩展的正则表达式"></a>扩展的正则表达式</h2><p>egrep [OPTIONS] PATTERN [FILE…]</p>
<h3 id="字符匹配-1"><a href="#字符匹配-1" class="headerlink" title="字符匹配"></a><strong><em>字符匹配</em></strong></h3><ul>
<li>. 任意单个字符  </li>
<li>[] 指定范围的字符  </li>
<li>[^] 不在指定范围的字符<br>基本和正则表达式相同</li>
</ul>
<h3 id="次数匹配-1"><a href="#次数匹配-1" class="headerlink" title="次数匹配"></a><strong><em>次数匹配</em></strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*  匹配前面的字符任意次，包括0次  </span><br><span class="line">.* 任意长度的任意字符  </span><br><span class="line">?  匹配其前面的字符0或1次  </span><br><span class="line">+  匹配其前面的字符至少1次  </span><br><span class="line">&#123;n&#125;   匹配前面的字符n次  </span><br><span class="line">&#123;m,n&#125; 匹配前面的字符至少m次，至多n次  </span><br><span class="line">&#123;,n&#125;  匹配前面的字符至多n次  </span><br><span class="line">&#123;n,&#125;  匹配前面的字符至少n次正则表达式</span><br></pre></td></tr></table></figure>
<h3 id="位置锚定-1"><a href="#位置锚定-1" class="headerlink" title="位置锚定"></a><strong><em>位置锚定</em></strong></h3><p>扩展正则表达式的位置锚定和基本正则表达式相同。</p>
<h3 id="分组-1"><a href="#分组-1" class="headerlink" title="_分组_"></a><strong>_分组_</strong></h3><p>( )的内容不需要用<code>\</code>转义</p>
<ul>
<li>或者：|<br>示例： a|b: a或b C|cat: C或cat (C|c)at:Cat或cat</li>
</ul>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><ol>
<li>利用df和grep，取出磁盘各分区利用率，并从大到小排序<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df | grep /dev/sd | grep -o <span class="string">"[0-9]\+%"</span> | grep -o <span class="string">"[0-9]\+"</span> |sort -nr</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df | grep  -E /dev/sd | grep -oE <span class="string">"[0-9]+%"</span> | grep -Eo <span class="string">"[0-9]+"</span> |sort -nr</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>显示ifconfig命令结果中所有IPv4地址<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens33 | grep -o <span class="string">"\&lt;\(\([0-1][0-9]\?\&#123;2\&#125;\|2[0-4][0-9]\|25[0-5]\)\.\)\&#123;3\&#125;\([0-1][0-9]\?\&#123;2\&#125;\|2[0-4][0-9]\|25[0-5]\)\&gt;"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens33 | egrep -o <span class="string">"\&lt;(([0-1][0-9]?&#123;2&#125;|2[0-4][0-9]|25[0-5])\.)&#123;3&#125;([0-1][0-9]?&#123;2&#125;|2[0-4][0-9]|25[0-5])\&gt;"</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>找出/etc/passwd用户名和shell同名的行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"^\([[:alnum:]]\&#123;1,\&#125;\):.*\1$"</span> /etc/passwd</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">"^([[:alnum:]]&#123;1,&#125;):.*\1$"</span> /etc/passwd</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>手机号<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -o <span class="string">"1[34578][0-9]\&#123;9\&#125;"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -Eo <span class="string">"1[34578][0-9]&#123;9&#125;"</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>使用egrep取出/etc/rc.d/init.d/functions中其基名  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> /etc/rc.d/init.d/<span class="built_in">functions</span>/ | grep -o  <span class="string">"[^/]\+/\?$"</span> | grep -o <span class="string">".*[^/]"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> /etc/rc.d/init.d/<span class="built_in">functions</span>/ | egrep -o  <span class="string">"[^/]+/?$"</span> | egrep -o <span class="string">".*[^/]"</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>显示CentOS7的/etc/grub2.cfg文件中，至少以一个空白字符开头的且后面有非空白字符的行<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"^[[:space:]]\+[^[:space:]]"</span> /etc/grub2.cfg</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">"^[[:space:]]+[^[:space:]]"</span> /etc/grub2.cfg</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/加密和安全/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/加密和安全/" itemprop="url">加密和安全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h1><h2 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h2><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86.png?raw=true" alt="img"></p>
<p>加密和解密使用同一个密钥<br>特性：</p>
<blockquote>
<p>加密、解密使用同一个密钥，效率高<br>将原始数据分割成固定大小的块，逐个进行加密</p>
</blockquote>
<p>缺陷：</p>
<blockquote>
<p>密钥过多<br>密钥分发<br>数据来源无法确认</p>
</blockquote>
<h1 id="非对称加密算法"><a href="#非对称加密算法" class="headerlink" title="非对称加密算法"></a>非对称加密算法</h1><h2 id="公钥加密-密钥是成对出现"><a href="#公钥加密-密钥是成对出现" class="headerlink" title="公钥加密:密钥是成对出现"></a>公钥加密:密钥是成对出现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]#cd /etc/ssh</span><br><span class="line">[root@cetos7 ssh]#ll</span><br><span class="line">-rw-r-----. 1 root ssh_keys   1679 Sep 25 11:01 ssh_host_rsa_key</span><br><span class="line">-rw-r--r--. 1 root root        382 Sep 25 11:01 ssh_host_rsa_key.pub</span><br></pre></td></tr></table></figure>
<blockquote>
<p>公钥：公开给所有人；public key<br>私钥：自己留存，必须保证其私密性；secret key</p>
</blockquote>
<p>特点：用公钥加密数据，只能使用与之配对的私钥解密；反之亦然</p>
<p>功能：</p>
<blockquote>
<p>数字签名：主要在于让接收方确认发送方身份<br>对称密钥交换：发送方用对方的公钥加密一个对称密钥后发送给对方<br>数据加密：适合加密较小数据</p>
</blockquote>
<p>缺点：密钥长，加密解密效率低下</p>
<h2 id="非对称加密-基于一对公钥-密钥对"><a href="#非对称加密-基于一对公钥-密钥对" class="headerlink" title="非对称加密:基于一对公钥/密钥对"></a>非对称加密:基于一对公钥/密钥对</h2><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86.png?raw=true" alt="img"><br>用密钥对中的一个加密，另一个解密</p>
<ol>
<li><p>实现加密：</p>
<blockquote>
<p>接收者生成公钥/密钥对：P和S ;公开公钥P，保密密钥S<br>发送者使用接收者的公钥来加密消息M ;将P(M)发送给接收者<br>接收者使用密钥S来解密：M=S(P(M))</p>
</blockquote>
</li>
<li><p>实现数字签名</p>
<blockquote>
<p>发送者生成公钥/密钥对：P和S ;公开公钥P，保密密钥S ;使用密钥S来加密消息M ;发送给接收者S(M)<br>接收者使用发送者的公钥来解密M=P(S(M))</p>
</blockquote>
</li>
</ol>
<p>数字签名<br><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D.png?raw=true" alt="数字签名"></p>
<ol>
<li>结合签名和加密</li>
<li>分离签名</li>
</ol>
<h1 id="单向散列-数字指纹"><a href="#单向散列-数字指纹" class="headerlink" title="单向散列(数字指纹)"></a>单向散列(数字指纹)</h1><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E5%8D%95%E5%90%91%E6%95%A3%E5%88%97.png?raw=true" alt="img"></p>
<ol>
<li><p>将任意数据缩小成固定大小的“指纹”</p>
<blockquote>
<p>任意长度输入<br>固定长度输出<br>若修改数据，指纹也会改变（“不会产生冲突”）<br>无法从指纹中重新生成数据（“单向”）</p>
</blockquote>
</li>
<li><p>功能：数据完整性</p>
</li>
<li><p>常见算法<br> md5: 128bits、<br> sha1: 160bits、 sha224、sha256、 sha384、 sha512</p>
</li>
<li><p>常用工具</p>
<blockquote>
<p>md5sum | sha1sum [ –check ] file<br>openssl、 gpg<br>rpm -V</p>
</blockquote>
</li>
</ol>
<p>加密类型对比</p>
<table>
<thead>
<tr>
<th></th>
<th><code>加密速度</code></th>
<th><code>密钥数</code></th>
<th><code>分发难度</code></th>
<th><code>密钥安全性</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>对称加密</td>
<td>中</td>
<td>多</td>
<td>难，方式很多，很混乱</td>
<td>安全机制很不健全</td>
</tr>
<tr>
<td>单向加密</td>
<td>快</td>
<td>无</td>
<td>最简单，官网公布</td>
<td>不需要安全性</td>
</tr>
<tr>
<td>非对称加密</td>
<td>慢</td>
<td>少</td>
<td>中，通过CA分发</td>
<td>有健全的安全机制</td>
</tr>
</tbody>
</table>
<h1 id="密钥交换"><a href="#密钥交换" class="headerlink" title="密钥交换"></a>密钥交换</h1><p>密钥交换：IKE（ Internet Key Exchange ）</p>
<blockquote>
<p>公钥加密<br>DH (Deffie-Hellman)：生成会话密钥，</p>
<blockquote>
<p>DH</p>
<blockquote>
<p>A: g,p 协商生成公开的整数g, 大素数p<br>B: g,p<br>A:生成隐私数据 :a (a&lt;p )，计算得出 g^a%p，发送给B<br>B:生成隐私数据 :b,计算得出 g^b%p，发送给A<br>A:计算得出 [(g^b%p)^a] %p = g^ab%p，生成为密钥<br>B:计算得出 [(g^a%p)^b] %p = g^ab%p，生成为密钥</p>
</blockquote>
</blockquote>
</blockquote>
<h1 id="使用gpg实现对称加密"><a href="#使用gpg实现对称加密" class="headerlink" title="使用gpg实现对称加密"></a>使用gpg实现对称加密</h1><ol>
<li><p>对称加密file文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg -c filename</span><br><span class="line">ls filename.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>在另一台主机上解密filename</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -o file -d filename.gpg</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="使用gpg工具实现公钥加密"><a href="#使用gpg工具实现公钥加密" class="headerlink" title="使用gpg工具实现公钥加密"></a>使用gpg工具实现公钥加密</h1><p>在hostB主机上用公钥加密，在hostA主机上解密</p>
<ol>
<li><p>在hostA主机上生成公钥/私钥对</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg –gen-key</span><br></pre></td></tr></table></figure>
</li>
<li><p>在hostA主机上查看公钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg –list-keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>在hostA主机上导出公钥到/data/magedupubkey</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -a –<span class="built_in">export</span> -o /data/magedupubkey</span><br></pre></td></tr></table></figure>
</li>
<li><p>从hostA主机上复制公钥文件到需加密的B主机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp magedupubkey hostB:</span><br></pre></td></tr></table></figure>
</li>
<li><p>在需加密数据的hostB主机上生成公钥/私钥对</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg –list-keys</span><br><span class="line">gpg –gen-key</span><br></pre></td></tr></table></figure>
</li>
<li><p>在hostB主机上导入公钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg –import magedupubkey</span><br><span class="line">gpg –list-keys</span><br></pre></td></tr></table></figure>
</li>
<li><p>用从hostA主机导入的公钥，加密hostB主机的文件file,生成file.gpg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg -e -r magedu f1.txt</span><br><span class="line">f1.txt.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>复制加密文件到hostA主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp f1.txt.gpg hostA:</span><br></pre></td></tr></table></figure>
</li>
<li><p>在hostA主机解密文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -o f1.txt -d f1.txt.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除公钥和私钥(先删除私钥再删公钥)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg –delete-secret-keys wange</span><br><span class="line">gpg –delete-keys wange</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h1><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB.png?raw=true" alt="img"></p>
<h1 id="CA和证书"><a href="#CA和证书" class="headerlink" title="CA和证书"></a>CA和证书</h1><p>PKI: Public Key Infrastructure</p>
<blockquote>
<p>签证机构：CA（Certificate Authority）<br>注册机构：RA<br>证书吊销列表：CRL<br>证书存取库：</p>
</blockquote>
<h2 id="证书获取"><a href="#证书获取" class="headerlink" title="证书获取"></a>证书获取</h2><p>证书类型：</p>
<blockquote>
<p>证书授权机构的证书<br>服务器<br>用户证书<br>获取证书两种方法：</p>
<ol>
<li>使用证书授权机构<br> 生成证书请求（csr）<br> 将证书请求csr发送给CA<br> CA签名颁发证书</li>
<li>自签名的证书<br> 自已签发自己的公钥</li>
</ol>
</blockquote>
<h1 id="安全协议"><a href="#安全协议" class="headerlink" title="安全协议"></a>安全协议</h1><h2 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h2><p>功能：机密性，认证，完整性，重放保护<br>两阶段协议，分为握手阶段和应用阶段</p>
<ol>
<li><p>握手阶段(协商阶段):客户端和服务器端认证对方身份（依赖于PKI体系，利用数字证书进行身份认证），并协商通信中使用的安全参数、密码套件以及主密钥。 后续通信使用的所有密钥都是通过MasterSecret生成。</p>
</li>
<li><p>应用阶段:在握手阶段完成后进入，在应用阶段通信双方使用握手阶段协商好的密钥进行安全通信</p>
</li>
</ol>
<h2 id="SSL-TLS"><a href="#SSL-TLS" class="headerlink" title="SSL/TLS"></a>SSL/TLS</h2><p><img src="https://github.com/xiejia1215225/Pictures/blob/master/SSL%E5%92%8CTLS.png?raw=true" alt="SSL和TLS.png"></p>
<ul>
<li>Handshake协议：包括协商安全参数和密码套件、服务器身份认证（客户端身份认证可选）、密钥交换</li>
<li>ChangeCipherSpec 协议：一条消息表明握手协议已经完成</li>
<li>Alert 协议：对握手协议中一些异常的错误提醒，分为fatal和warning两个级别，fatal类型错误会直接中断SSL链接，而warning级别的错误SSL链接仍可继续，只是会给出错误警告</li>
<li>Record 协议：包括对消息的分段、压缩、消息认证和完整性保护、加密等</li>
<li>HTTPS 协议：就是“HTTP 协议”和“SSL/TLS 协议”的组合。 HTTP overSSL” 或“HTTP over TLS” ，对http协议的文本数据进行加密处理后，成为二进制形式传输</li>
</ul>
<h1 id="openssl命令"><a href="#openssl命令" class="headerlink" title="openssl命令"></a>openssl命令</h1><p>两种运行模式：交互模式和批处理模式<br>openssl version：程序版本号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]<span class="comment">#openssl version</span></span><br><span class="line">OpenSSL 1.0.2k-fips  26 Jan 2017</span><br></pre></td></tr></table></figure>
<ol>
<li><p>对称加密：</p>
<p>工具：openssl enc, gpg</p>
<p>算法：3des, aes, blowfish, twofish</p>
<blockquote>
<p>enc命令<br>加密：<br>openssl enc -e -des3 -a -salt -in filename -out filename.enc<br>解密：<br>openssl enc -d -des3 -a -salt –in filename.enc -out filename</p>
</blockquote>
</li>
<li><p>单向加密：</p>
<p>工具：md5sum, sha1sum, sha224sum,sha256sum…</p>
<blockquote>
<p>dgst命令：<br>openssl dgst -md5 [-hex默认] filename<br>md5sum filename</p>
</blockquote>
</li>
<li><p>生成用户密码<br> passwd命令:<br> openssl passwd -1<br> openssl passwd -1 -salt “SALT(最多8位)”</p>
</li>
<li><p>生成随机数<br> openssl rand -base64|-hex NUM<br> NUM: 表示字节数,使用-hex,每个字符为十六进制,相当于4位二进制,出现的字符数为NUM*2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]<span class="comment">#openssl rand -base64 3</span></span><br><span class="line">n5c0</span><br><span class="line">[root@cetos7 ~]<span class="comment">#openssl rand -hex 3</span></span><br><span class="line">a8e1d2</span><br></pre></td></tr></table></figure>
</li>
<li><p>公钥加密<br> 算法：RSA, ELGamal<br> 工具：gpg, openssl rsautl（man rsautl）</p>
</li>
<li><p>数字签名<br> 算法：RSA, DSA, ELGamal</p>
</li>
<li><p>密钥交换：</p>
<p>算法：dh</p>
<p>生成私钥<br>openssl genrsa -out /PATH/TO/PRIVATEKEY.FILE NUM_BITS</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos~]<span class="comment">#openssl genrsa -out test.key 1024</span></span><br></pre></td></tr></table></figure>
<p>(umask 077; openssl genrsa –out test.key –des 2048) 加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos~]<span class="comment">#(umask 077;openssl genrsa -out test.key -des 2048)</span></span><br></pre></td></tr></table></figure>
<p>openssl rsa -in test.key –out test.bak 将加密key解密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos~]<span class="comment">#openssl rsa -in test.key -out test.bak</span></span><br></pre></td></tr></table></figure>
<p>从私钥中提取出公钥</p>
<blockquote>
<p>openssl rsa –in test.key –pubout –out test.key.pub</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@centos~]<span class="comment">#openssl rsa -in test.key -pubout -out test.key.pub</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>随机数生成器：伪随机数字</p>
<p>  键盘和鼠标，块设备中断</p>
<blockquote>
<p>/dev/random：仅从熵池返回随机数；随机数用尽，阻塞</p>
<blockquote>
<p>/dev/urandom：从熵池返回随机数；随机数用尽，会利用软件生成伪随机数,非阻塞OpenSSL</p>
</blockquote>
</blockquote>
<h1 id="创建CA和申请证书"><a href="#创建CA和申请证书" class="headerlink" title="创建CA和申请证书"></a>创建CA和申请证书</h1><ol>
<li><p>创建所需要的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /etc/pki/CA/index.txt 生成证书索引数据库文件</span><br><span class="line"><span class="built_in">echo</span> 01 &gt; /etc/pki/CA/serial 指定第一个颁发证书的序列号</span><br></pre></td></tr></table></figure>
</li>
<li><p>CA自签证书<br> 生成私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/pki/CA/</span><br><span class="line">(<span class="built_in">umask</span> 066; openssl genrsa -out private/cakey.pem 2048)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>生成自签名证书</p>
<blockquote>
<p>openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 3650 -out /etc/pki/CA/cacert.pem<br>选项说明：<br>-new：生成新证书签署请求<br>-x509：专用于CA生成自签证书<br>-key：生成请求时用到的私钥文件<br>-days n：证书的有效期限<br>-out /PATH/TO/SOMECERTFILE: 证书的保存路径  </p>
</blockquote>
<ol start="3">
<li><p>颁发证书</p>
<p> 在需要使用证书的主机生成证书请求<br> 给web服务器生成私钥<br> ​    (umask 066; openssl genrsa –out /data/test.key 2048)</p>
</li>
</ol>
<p>生成证书申请文件</p>
<blockquote>
<p>openssl req -new -key /data/test.key -out /data/test.csr</p>
</blockquote>
<p>将证书请求文件传输给CA</p>
<p>CA签署证书，并将证书颁发给请求者</p>
<blockquote>
<p>openssl ca -in /tmp/test.csr –out /etc/pki/CA/certs/test.crt -days 100<br>注意：默认要求 国家，省，公司名称三项必须和CA一致创建CA和证书管理</p>
</blockquote>
<p>查看证书中的信息：</p>
<blockquote>
<p>openssl x509 -in /PATH/FROM/CERT_FILE -noout -text|issuer|subject|serial|dates<br>openssl ca -status SERIAL 查看指定编号的证书状态</p>
</blockquote>
<ol start="4">
<li><p>吊销证书</p>
<blockquote>
<p>openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem<br>指定第一个吊销证书的编号,注意：第一次更新证书吊销列表前，才需要执行<br>echo 01 &gt; /etc/pki/CA/crlnumber</p>
</blockquote>
</li>
</ol>
<p>更新证书吊销列表</p>
<blockquote>
<p>openssl ca -gencrl -out /etc/pki/CA/crl.pem</p>
</blockquote>
<p>查看crl文件：</p>
<blockquote>
<p>openssl crl -in /etc/pki/CA/crl.pem -noout -text</p>
</blockquote>
<h1 id="SSH-22-tcp"><a href="#SSH-22-tcp" class="headerlink" title="SSH(22/tcp)"></a>SSH(22/tcp)</h1><ol>
<li><p>具体的软件实现：</p>
<blockquote>
<p>OpenSSH: ssh协议的开源实现，CentOS默认安装<br>dropbear：另一个开源实现</p>
</blockquote>
</li>
<li><p>两种方式的用户登录认证：</p>
<blockquote>
<p>基于password<br>基于key</p>
</blockquote>
</li>
<li><p>Openssh软件组成<br> 相关包：<br> openssh<br> openssh-clients<br> openssh-server</p>
</li>
<li><p>工具：<br> 基于C/S结构</p>
<blockquote>
<p>Client: ssh, scp, sftp，slogin<br>Windows客户端:xshell, putty, securecrt, sshsecureshellclient<br>Server: sshd</p>
</blockquote>
</li>
</ol>
<h2 id="ssh客户端"><a href="#ssh客户端" class="headerlink" title="ssh客户端"></a>ssh客户端</h2><ol>
<li>允许实现对远程系统经验证地加密安全访问</li>
<li>当用户远程连接ssh服务器时，会复制ssh服务器/etc/ssh/ssh_host*key.pub（CentOS7默认是ssh_host_ecdsa_key.pub）文件中的公钥到客户机的~./ssh/know_hosts中。下次连接时，会自动匹配相应私钥，不能匹配，将拒绝连接</li>
</ol>
<p>客户端组件：<br>ssh, 配置文件：/etc/ssh/ssh_config<br>Host PATTERN<br>StrictHostKeyChecking no 首次登录不显示检查提示<br>格式：ssh [user@]host [COMMAND]<br>ssh [-l user] host [COMMAND]<br>常见选项<br>-p port：远程服务器监听的端口<br>-b：指定连接的源IP<br>-v：调试模式<br>-C：压缩方式<br>-X：支持x11转发<br>-t：强制伪tty分配<br>ssh -t remoteserver1 ssh -t remoteserver2 ssh remoteserver3</p>
<h2 id="ssh服务登录验证方式："><a href="#ssh服务登录验证方式：" class="headerlink" title="ssh服务登录验证方式："></a>ssh服务登录验证方式：</h2><h3 id="基于用户和口令登录验证"><a href="#基于用户和口令登录验证" class="headerlink" title="基于用户和口令登录验证"></a>基于用户和口令登录验证</h3><blockquote>
<p>客户端发起ssh请求，服务器会把自己的公钥发送给用户<br>用户会根据服务器发来的公钥对密码进行加密<br>加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功</p>
</blockquote>
<h3 id="基于密钥的登录方式"><a href="#基于密钥的登录方式" class="headerlink" title="基于密钥的登录方式"></a>基于密钥的登录方式</h3><blockquote>
<p>首先在客户端生成一对密钥（ssh-keygen）<br>并将客户端的公钥ssh-copy-id 拷贝到服务端<br>当客户端再次发送一个连接请求，包括ip、用户名<br>服务端得到客户端的请求后，会到authorized_keys中查找，如果有响应的IP和用户，就会随机生成一个字符串，例如：magedu<br>服务端将使用客户端拷贝过来的公钥进行加密，然后发送给客户端<br>得到服务端发来的消息后，客户端会使用私钥进行解密，然后将解密后的字符串发送给服务端<br>服务端接受到客户端发来的字符串后，跟之前的字符串进行对比，如果一致，就允许免密码登录</p>
</blockquote>
<p>基于key认证</p>
<ol>
<li><p>在客户端生成密钥对</p>
<blockquote>
<p>ssh-keygen -t rsa [-P ‘’] [-f “~/.ssh/id_rsa”]</p>
</blockquote>
</li>
<li><p>把公钥文件传输至远程服务器对应用户的家目录</p>
<blockquote>
<p>ssh-copy-id [-i [identity_file]] [user@]host</p>
</blockquote>
</li>
<li><p>重设私钥口令：</p>
<blockquote>
<p>ssh-keygen –p</p>
</blockquote>
</li>
<li><p>验证代理（authentication agent）保密解密后的密钥<br> • 这样口令就只需要输入一次<br> • 在GNOME中，代理被自动提供给root用户<br> • 否则运行ssh-agent bash</p>
</li>
<li><p>钥匙通过命令添加给代理</p>
<blockquote>
<p>ssh-add</p>
</blockquote>
</li>
</ol>
<h1 id="rsync命令"><a href="#rsync命令" class="headerlink" title="rsync命令"></a>rsync命令</h1><p>基于ssh和rsh服务实现高效率的远程系统之间复制文件<br>使用安全的shell连接做为传输方式</p>
<blockquote>
<p>rsync -av /etc server1:/tmp 复制目录和目录下文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@CentOS6 data]<span class="comment">#ll ssl</span></span><br><span class="line">&gt; total 12</span><br><span class="line">&gt; -rw-r--r--. 1 root root 3715 Nov 14 12:27 app.crt</span><br><span class="line">&gt; -rw-r--r--. 1 root root  655 Nov 14 08:52 app.csr</span><br><span class="line">&gt; -rw-------. 1 root root  887 Nov 14 08:48 app.key</span><br><span class="line">&gt; [root@CentOS6 data]<span class="comment">#rsync -av /data/ssl 192.168.183.148:/data</span></span><br><span class="line">&gt; root@192.168.183.148<span class="string">'s password: </span></span><br><span class="line"><span class="string">&gt; sending incremental file list</span></span><br><span class="line"><span class="string">&gt; ssl/</span></span><br><span class="line"><span class="string">&gt; ssl/app.crt</span></span><br><span class="line"><span class="string">&gt; ssl/app.csr</span></span><br><span class="line"><span class="string">&gt; ssl/app.key</span></span><br><span class="line"><span class="string">&gt; </span></span><br><span class="line"><span class="string">&gt; sent 5472 bytes  received 73 bytes  528.10 bytes/sec</span></span><br><span class="line"><span class="string">&gt; total size is 5257  speedup is 0.95</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>rsync -av /etc/ server1:/tmp 只复制目录下文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@CentOS6 data]<span class="comment">#rsync -av /data/ssl/ 192.168.183.148:/data</span></span><br><span class="line">&gt; root@192.168.183.148<span class="string">'s password: </span></span><br><span class="line"><span class="string">&gt; sending incremental file list</span></span><br><span class="line"><span class="string">&gt; ./</span></span><br><span class="line"><span class="string">&gt; app.crt</span></span><br><span class="line"><span class="string">&gt; app.csr</span></span><br><span class="line"><span class="string">&gt; app.key</span></span><br><span class="line"><span class="string">&gt; </span></span><br><span class="line"><span class="string">&gt; sent 5460 bytes  received 72 bytes  1229.33 bytes/sec</span></span><br><span class="line"><span class="string">&gt; total size is 5257  speedup is 0.95</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>比scp更快，只复制不同的文件<br>常用选项：<br>-n 模拟复制过程<br>-v 显示详细过程<br>-r 递归复制目录树<br>-p 保留权限<br>-t 保留时间戳<br>-g 保留组信息<br>-o 保留所有者信息<br>-l 将软链接文件本身进行复制（默认）<br>-L 将软链接文件指向的文件复制<br>-a 存档，相当于–rlptgoD，但不保留ACL（-A）和SELinux属性（-X）</p>
<h1 id="pssh工具"><a href="#pssh工具" class="headerlink" title="pssh工具"></a>pssh工具</h1><p>pssh是一个python编写可以在多台服务器上执行命令的工具，也可实现文件复制<br>选项如下：<br>–version：查看版本<br>-h：主机文件列表，内容格式” [user@]host[:port]”<br>-H：主机字符串，内容格式” [user@]host[:port]”<br>-A：手动输入密码模式<br>-i：每个服务器内部处理信息输出<br>-l：登录使用的用户名<br>-p：并发的线程数【可选】<br>-o：输出的文件目录【可选】<br>-e：错误输入文件【可选】<br>-t：TIMEOUT 超时时间设置，0无限制【可选】<br>-O：SSH的选项<br>-P：打印出服务器返回信息<br>-v：详细模式</p>
<p>pssh示例</p>
<ol>
<li><p>通过pssh批量关闭seLinux</p>
<blockquote>
<p>pssh -H <a href="mailto:root@192.168.183.158" target="_blank" rel="noopener">root@192.168.183.158</a> -i “sed-i “s/SELINUX=enforcing/SELINUX=disabled/“ /etc/selinux/config”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; [root@cetos7 ~]<span class="comment">#pssh -H root@192.168.183.158 -i "sed -i "s/SELINUX=enforcing/SELINUX=disabled/" /etc/selinux/config"</span></span><br><span class="line">&gt; [1] 20:25:13 [SUCCESS] root@192.168.183.158</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>批量发送指令</p>
<blockquote>
<p>pssh -H <a href="mailto:root@192.168.1.10" target="_blank" rel="noopener">root@192.168.1.10</a> -i setenforce 0<br>pssh -H <a href="mailto:wang@192.168.1.10" target="_blank" rel="noopener">wang@192.168.1.10</a> -i hostname</p>
</blockquote>
</li>
<li><p>当不支持ssh的key认证时，通过 -A选项，使用密码认证批量执行指令</p>
<blockquote>
<p>pssh -H <a href="mailto:wang@192.168.1.10" target="_blank" rel="noopener">wang@192.168.1.10</a> -A -i hostname</p>
</blockquote>
</li>
<li><p>将标准错误和标准正确重定向都保存至/app目录下</p>
<blockquote>
<p>pssh -H 192.168.1.10 -o /app -e /app -i “hostname”</p>
</blockquote>
</li>
</ol>
<h1 id="SSH端口转发"><a href="#SSH端口转发" class="headerlink" title="SSH端口转发"></a>SSH端口转发</h1><p>    SSH会自动加密和解密所有SSH客户端与服务端之间的网络数据。但是SSH还能够将其他TCP端口的网络数据通过SSH链接来转发，并且自动提供了相应的加密及解密服务。这一过程也被叫做“隧道”（tunneling),这是因为 SSH 为其他TCP链接提供了一个安全的通道来进行传输而得名。例如Telnet，SMTP，LDAP这些TCP应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传输。而与此同时，如果工作环境中的防火墙限制了一些网络端口的使用，但是允许SSH的连接，也能够通过将TCP端口转发来使用SSH进行通讯</p>
<p>SSH 端口转发能够提供两大功能：</p>
<blockquote>
<p>加密 SSH Client 端至 SSH Server 端之间的通讯数据<br>突破防火墙的限制完成一些之前无法建立的 TCP 连接SSH端口转发</p>
</blockquote>
<ol>
<li><p>本地转发：</p>
<p> -L localport:remotehost:remotehostport sshserver</p>
<p> 选项：</p>
<p> -f 后台启用</p>
<p> -N 不打开远程shell，处于等待状态</p>
<p> -g 启用网关功能</p>
<p> 示例</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ssh –L 9527:telnetsrv:23 -Nfg sshsrv</span><br><span class="line">telnet 127.0.0.1 9527 </span><br><span class="line">​``` </span><br><span class="line">当访问本机的9527的端口时，被加密后转发到sshsrv的ssh服务，再解密被转发到telnetsrv:23</span><br><span class="line">&gt;data &lt;--&gt; localhost:9527 &lt;--&gt; localhost:XXXXX &lt;--&gt; sshsrv:22 &lt;--&gt; sshsrv:YYYYY &lt;--&gt; telnetsrv:23</span><br><span class="line"></span><br><span class="line">2. 远程转发:</span><br><span class="line">-R sshserverport:remotehost:remotehostport sshserver  </span><br><span class="line">示例：</span><br><span class="line">​```bash</span><br><span class="line">ssh –R 9527:telnetsrv:23 –Nf sshsrv</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>让sshsrv侦听9527端口的访问，如有访问，就加密后通过ssh服务转发请求到本机ssh客户端，再由本机解密后转发到telnetsrv:23</p>
<blockquote>
<p>Data <--> sshsrv:9527 <--> sshsrv:22 <--> localhost:XXXXX <-->localhost:YYYYY <--> telnetsrv:23</--></--></--></--></--></p>
</blockquote>
<ol>
<li><p>动态端口转发：<br> 当用firefox访问internet时，本机的1080端口做为代理服务器，firefox的访问请求被转发到sshserver上，由sshserver替之访问internet</p>
<blockquote>
<p>ssh -D 1080 root@sshserver -fNg<br>在本机firefox设置代理socket proxy:127.0.0.1:1080<br>curl –socks5 127.0.0.1:1080 <a href="http://www.qq.com" target="_blank" rel="noopener">http://www.qq.com</a></p>
</blockquote>
</li>
<li><p>X 协议转发<br> 所有图形化应用程序都是X客户程序</p>
<blockquote>
<p>能够通过tcp/ip连接远程X服务器<br>数据没有加密机，但是它通过ssh连接隧道安全进行</p>
</blockquote>
</li>
</ol>
<p>ssh -X user@remotehost gedit<br>remotehost主机上的gedit工具，将会显示在本机的X服务器上<br>传输的数据将通过ssh连接加密</p>
<h1 id="ssh服务器"><a href="#ssh服务器" class="headerlink" title="ssh服务器"></a>ssh服务器</h1><p>服务器端：sshd</p>
<h2 id="配置文件-etc-ssh-sshd-config"><a href="#配置文件-etc-ssh-sshd-config" class="headerlink" title="配置文件: /etc/ssh/sshd_config"></a>配置文件: /etc/ssh/sshd_config</h2><p>常用参数：<br>Port<br>ListenAddress ip<br>LoginGraceTime 2m<br>PermitRootLogin yes<br>StrictModes yes 检查.ssh/文件的所有者，权限等<br>MaxAuthTries 6<br>MaxSessions 10 同一个连接最大会话<br>PubkeyAuthentication yes<br>PermitEmptyPasswords no<br>PasswordAuthentication yes<br>GatewayPorts no<br>ClientAliveInterval 单位:秒<br>ClientAliveCountMax 默认3<br>UseDNS yes<br>GSSAPIAuthentication yes 提高速度可改为no<br>MaxStartups 未认证连接最大值，默认值10<br>Banner /path/file 登录提示信息<br>限制可登录用户的办法：</p>
<blockquote>
<p>AllowUsers user1 user2 user3<br>DenyUsers<br>AllowGroups<br>DenyGroup</p>
</blockquote>
<h2 id="sssh服务的最佳实践"><a href="#sssh服务的最佳实践" class="headerlink" title="sssh服务的最佳实践"></a>sssh服务的最佳实践</h2><p>建议使用非默认端口<br>禁止使用protocol version 1<br>限制可登录用户<br>设定空闲会话超时时长<br>利用防火墙设置ssh访问策略<br>仅监听特定的IP地址<br>基于口令认证时，使用强密码策略</p>
<blockquote>
<p>tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 12| xargs<br>使用基于密钥的认证<br>禁止使用空密码<br>禁止root用户直接登录<br>限制ssh的访问频度和并发在线数<br>经常分析日志</p>
</blockquote>
<h1 id="编译安装dropbear"><a href="#编译安装dropbear" class="headerlink" title="编译安装dropbear"></a>编译安装dropbear</h1><p>ssh协议的另一个实现：dropbear</p>
<h2 id="源码编译安装："><a href="#源码编译安装：" class="headerlink" title="源码编译安装："></a>源码编译安装：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 安装开发包组:yum groupinstall <span class="string">"Development tools"</span>    </span><br><span class="line">2. 下载dropbear-2017.75.tar.bz2 </span><br><span class="line"></span><br><span class="line">wget https://matt.ucc.asn.au/dropbear/dropbear-2017.75.tar.bz2</span><br><span class="line"></span><br><span class="line">3. tar xf dropbear-2017.75.tar.bz2  </span><br><span class="line">4.  cat INSTALL </span><br><span class="line">    cat README  </span><br><span class="line">5. ./configure --prefix=/app/dropbear --sysconfdir=/etc/dropbear</span><br><span class="line">6. make PROGRAMS=<span class="string">"dropbear dbclient dropbearkey dropbearconvert scp"</span>  </span><br><span class="line">7. make PROGRAMS=<span class="string">"dropbear dbclient dropbearkey dropbearconvert scp"</span> install</span><br></pre></td></tr></table></figure>
<h2 id="启动ssh服务："><a href="#启动ssh服务：" class="headerlink" title="启动ssh服务："></a>启动ssh服务：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. ls /app/dropbear/sbin/ /app/dropbear/bin/  </span><br><span class="line">2. /app/dropbear/sbin/dropbear -h  </span><br><span class="line">3. mkdir /etc/dropbear  </span><br><span class="line">4. <span class="built_in">cd</span> /app/dropbear/bin</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'PATH=$PATH:/app/dropbear/bin:/app/dropbear/sbin'</span> &gt; /etc/profile.d/dropbear.sh</span><br><span class="line">dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key   </span><br><span class="line">5.  <span class="built_in">cd</span> /app/dropbear/sbin</span><br><span class="line">dropbear -p :2222 -F –E  <span class="comment">#前台运行  </span></span><br><span class="line">dropbear -p :2222        <span class="comment">#后台运行</span></span><br><span class="line">6. 客户端访问：</span><br><span class="line">ssh -p 2222 root@127.0.0.1  </span><br><span class="line">或者</span><br><span class="line"><span class="built_in">cd</span> /app/dropbear/bin</span><br><span class="line">dbclient 127.0.0.1</span><br></pre></td></tr></table></figure>
<h1 id="AIDE"><a href="#AIDE" class="headerlink" title="AIDE"></a>AIDE</h1><p>    当一个入侵者进入了你的系统并且种植了木马，通常会想办法来隐蔽这个木马（除了木马自身的一些隐蔽特性外,他会尽量给你检查系统的过程设置障碍),通常入侵者会修改一些文件,比如管理员通常用<code>ps -aux</code>来查看系统进程，那么入侵者很可能用自己经过修改的ps程序来替换掉你系统上的ps程序，以使用ps命令查不到正在运行的木马程序。如果入侵者发现管理员正在运行crontab作业,也有可能替换掉crontab程序等等。所以由此可以看出对于系统文件或是关键文件的检查是很必要的.目前就系统完整性检查的工具用的比较多的有两款:Tripwire和AIDE，前者是一款商业软件,后者是一款免费的但功能也很强大的工具.</p>
<ul>
<li>AIDE:高级入侵检测环境)是一个入侵检测工具，主要用途是检查文件的完整性，审计计算机上的那些文件被更改过了.</li>
<li>AIDE能够构造一个指定文件的数据库，它使用aide.conf作为其配置文件。 AIDE数据库能够保存文件的各种属性，包括：权限(permission)、索引节点序号(inode number)、所属用户(user)、所属用户组(group)、文件大小、最后修改时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小以及连接数。 AIDE还能够使用下列算法：sha1、 md5、 rmd160、 tiger，以密文形式建立每个文件的校验码或散列号</li>
<li>这个数据库不应该保存那些经常变动的文件信息，例如：日志文件、邮件、 /proc文件系统、用户起始目录以及临时目录.</li>
</ul>
<ol>
<li><p>安装<br> yum install aide</p>
</li>
<li><p>修改配置文件</p>
<p> vim /etc/aide.conf (指定对哪些文件进行检测)</p>
<blockquote>
<p>/test/chameleon R<br>/bin/ps R+a<br>/usr/bin/crontab R+a<br>/etc PERMS<br>!/etc/mtab #“!” 表示忽略这个文件的检查<br>R=p+i+n+u+g+s+m+c+md5<br>权限+索引节点+链接数+用户+组+大小+最后一次修改时间+创建时间+md5校验值<br>NORMAL = R+rmd60+sha256</p>
</blockquote>
</li>
<li><p>初始化默认的AIDE的库：</p>
<blockquote>
<p>aide –init</p>
</blockquote>
</li>
<li><p>生成检查数据库（建议初始数据库存放到安全的地方）</p>
<blockquote>
<p>cd /var/lib/aide<br>mv aide.db.new.gz aide.db.gz</p>
</blockquote>
</li>
<li><p>检测：</p>
<blockquote>
<p>aide –check/-C</p>
</blockquote>
</li>
<li><p>更新数据库</p>
<blockquote>
<p>aide –update</p>
</blockquote>
</li>
</ol>
<h1 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h1><ul>
<li><p>sudo能够授权指定用户在指定主机上运行某些命令。 如果未授权用户尝试使用 sudo，会提示联系管理员</p>
</li>
<li><p>sudo可以提供日志，记录每个用户使用sudo操作</p>
</li>
<li><p>sudo为系统管理员提供配置文件，允许系统管理员集中地管理用户的使用权限和使用的主机</p>
</li>
<li><p>sudo使用时间戳文件来完成类似“检票”的系统，默认存活期为5分钟的“入场券”</p>
</li>
<li><p>通过visudo命令编辑配置文件，具有语法检查功能</p>
<blockquote>
<p>visudo –c 检查语法<br>visudo -f /etc/sudoers.d/test</p>
</blockquote>
</li>
<li><p>配置文件：/etc/sudoers, /etc/sudoers.d/</p>
</li>
<li><p>时间戳文件：/var/db/sudo</p>
</li>
<li><p>日志文件：/var/log/secure</p>
</li>
<li><p>配置文件支持使用通配符glob</p>
<blockquote>
<p>？:任意单一字符</p>
<ul>
<li>:匹配任意长度字符</li>
</ul>
<p>[wxc]:匹配其中一个字符<br>[!wxc]:除了这三个字符的其它字符<br>\x : 转义<br>[[alpha]]:字母 示例： /bin/ls [[alpha]]*</p>
</blockquote>
</li>
</ul>
<p>配置文件规则有两类<br>1、别名定义:不是必须的<br>2、授权规则:必须的<br>授权规则格式 ：<br>用户 登入主机=(代表用户) 命令<br>示例：<br>root ALL=(ALL) ALL<br>格式说明：<br>user: 运行命令者的身份<br>host: 通过哪些主机<br>(runas)：以哪个用户的身份<br>command: 运行哪些命令</p>
<ul>
<li><p>别名</p>
<blockquote>
<p>Users和runas:</p>
<blockquote>
<p>username<br>#uid<br>%group_name<br>%#gid<br>user_alias|runas_alias</p>
</blockquote>
</blockquote>
</li>
<li><p>host:</p>
<blockquote>
<p>ip或hostname<br>network(/netmask)<br>host_alias</p>
</blockquote>
</li>
</ul>
<p>*command:</p>
<blockquote>
<p>command name<br>directory<br>sudoedit<br>Cmnd_Alias</p>
</blockquote>
<h2 id="sudo别名和示例"><a href="#sudo别名和示例" class="headerlink" title="sudo别名和示例"></a>sudo别名和示例</h2><ul>
<li>别名有四种类型：User_Alias, Runas_Alias, Host_Alias ，Cmnd_Alias</li>
<li>别名格式：<a href="[A-Z][0-9]_">A-Z</a>*</li>
<li>别名定义：<br>  Alias_Type NAME1 = item1, item2, item3 : NAME2 = item4, item5</li>
</ul>
<p>示例1：</p>
<blockquote>
<p>Student ALL=(ALL) ALL<br>%wheel ALL=(ALL) ALL</p>
</blockquote>
<p>示例2：</p>
<blockquote>
<p>student ALL=(root) /sbin/pidof,/sbin/ifconfig<br>%wheel ALL=(ALL) NOPASSWD: ALL</p>
</blockquote>
<p>示例3</p>
<blockquote>
<p>User_Alias NETADMIN= netuser1,netuser2<br>Cmnd_Alias NETCMD = /usr/sbin/ip<br>NETADMIN ALL=（root） NETCMD</p>
</blockquote>
<p>示例4</p>
<blockquote>
<p>User_Alias SYSADER=wang,mage,%admins<br>User_Alias DISKADER=tom<br>Host_Alias SERS=<a href="http://www.magedu.com,172.16.0.0/24" target="_blank" rel="noopener">www.magedu.com,172.16.0.0/24</a><br>Runas_Alias OP=root<br>Cmnd_Alias SYDCMD=/bin/chown,/bin/chmod<br>Cmnd_Alias DSKCMD=/sbin/parted,/sbin/fdisk<br>SYSADER SERS= SYDCMD,DSKCMD<br>DISKADER ALL=(OP) DSKCMD</p>
</blockquote>
<p>示例5</p>
<blockquote>
<p>User_Alias ADMINUSER = adminuser1,adminuser2<br>Cmnd_Alias ADMINCMD = /usr/sbin/useradd，/usr/sbin/usermod,<br>/usr/bin/passwd [a-zA-Z]*, !/usr/bin/passwd root<br>ADMINUSER ALL=(root) NOPASSWD:ADMINCMD，<br>PASSWD:/usr/sbin/userdel</p>
</blockquote>
<p>示例6</p>
<blockquote>
<p>Defaults:wang runas_default=tom<br>wang ALL=(tom,jerry) ALL</p>
</blockquote>
<p>示例7</p>
<blockquote>
<p>wang 192.168.1.6,192.168.1.8=(root) /usr/sbin/,!/usr/sbin/useradd</p>
</blockquote>
<p>示例8</p>
<blockquote>
<p>wang ALL=(ALL) /bin/cat /var/log/messages*</p>
</blockquote>
<h2 id="sudo命令"><a href="#sudo命令" class="headerlink" title="sudo命令"></a>sudo命令</h2><p>ls -l /usr/bin/sudo<br>sudo –i –u wang 切换身份<br>sudo [-u user] COMMAND</p>
<blockquote>
<p>-V 显示版本信息等配置信息<br>-u user 默认为root<br>-l,ll 列出用户在主机上可用的和被禁止的命令<br>-v 再延长密码有效期限5分钟,更新时间戳<br>-k 清除时间戳（1970-01-01），下次需要重新输密码<br>-K 与-k类似，还要删除时间戳文件<br>-b 在后台执行指令<br>-p 改变询问密码的提示符号<br>示例：-p “password on %h for user %p:”</p>
</blockquote>
<h1 id="TCP-Wrappers"><a href="#TCP-Wrappers" class="headerlink" title="TCP_Wrappers"></a>TCP_Wrappers</h1><ol>
<li><p>工作在第四层（传输层）的TCP协议</p>
</li>
<li><p>对有状态连接的特定服务进行安全检测并实现访问控制</p>
</li>
<li><p>以库文件形式实现</p>
</li>
<li><p>某进程是否接受libwrap的控制取决于发起此进程的程序在编译时是否针对libwrap进行编译的</p>
</li>
<li><p>判断服务程序是否能够由tcp_wrapper进行访问控制的方法：</p>
<blockquote>
<p>ldd /PATH/TO/PROGRAM|grep libwrap.so<br>strings PATH/TO/PROGRAM|grep libwrap.so</p>
</blockquote>
</li>
</ol>
<h2 id="TCP-Wrappers的使用"><a href="#TCP-Wrappers的使用" class="headerlink" title="TCP_Wrappers的使用"></a>TCP_Wrappers的使用</h2><ol>
<li>配置文件：/etc/hosts.allow, /etc/hosts.deny</li>
<li>检查顺序：hosts.allow，hosts.deny<br> 注意：一旦前面规则匹配，直接生效，将不再继续（默认允许）</li>
<li>基本语法:<br> daemon_list@host: client_list [ :options :option… ]</li>
<li>Daemon_list@host格式<br> 单个应用程序的二进制文件名，而非服务名，例如vsftpd<br> 以逗号或空格分隔的应用程序文件名列表，如:sshd,vsftpd<br> ALL表示所有接受tcp_wrapper控制的服务程序<br> 主机有多个IP，可用@hostIP来实现控制<br> 如：<a href="mailto:in.telnetd@192.168.0.254" target="_blank" rel="noopener">in.telnetd@192.168.0.254</a></li>
</ol>
<h2 id="客户端Client-list格式"><a href="#客户端Client-list格式" class="headerlink" title="客户端Client_list格式"></a>客户端Client_list格式</h2><blockquote>
<p>以逗号或空格分隔的客户端列表<br>基于IP地址：192.168.10.1 192.168.1.<br>基于主机名：<a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a> .magedu.com 较少用<br>基于网络/掩码：192.168.0.0/255.255.255.0<br>基于net/prefixlen: 192.168.1.0/24（CentOS7）<br>基于网络组（NIS 域）：@mynetwork<br>内置ACL：ALL，LOCAL，KNOWN，UNKNOWN，PARANOID<br>EXCEPT用法：<br>示例：<br>vsftpd: 172.16. EXCEPT 172.16.100.0/24 EXCEPT 172.16.100.1<br>示例：只允许192.168.1.0/24的主机访问sshd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; /etc/hosts.allow    </span><br><span class="line">&gt; sshd: 192.168.1.    </span><br><span class="line">&gt; /etc/hosts.deny    </span><br><span class="line">&gt; sshd :ALL</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>示例：只允许192.168.1.0/24的主机访问telnet和vsftpd服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/hosts.allow</span><br><span class="line">vsftpd,in.telnetd: 192.168.1.</span><br><span class="line">/etc/host.deny  </span><br><span class="line">vsftpd,in.telnetd: ALL</span><br></pre></td></tr></table></figure>
<h2 id="options-选项："><a href="#options-选项：" class="headerlink" title="[:options]选项："></a>[:options]选项：</h2><ol>
<li><p>deny 主要用在/etc/hosts.allow定义“拒绝”规则<br> 如：vsftpd: 172.16. :deny</p>
</li>
<li><p>allow 主要用在/etc/hosts.deny定义“允许” 规则<br> 如：vsftpd:172.16. :allow</p>
</li>
<li><p>spawn 启动一个外部程序完成执行的操作<br> 示例</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshd: ALL :spawn <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date +%%F)</span> login attempt from %c to %s,%d"</span> &gt;&gt; /var/<span class="built_in">log</span>/sshd.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>说明：<br>在/etc/hosts.allow中添加，允许登录，并记录日志<br>在/etc/hosts.deny中添加，拒绝登录，并记录日志</p>
<blockquote>
<p>%c 客户端信息<br>%s 服务器端信息<br>%d 服务名<br>%p 守护进程的PID<br>%% 表示%</p>
<ol>
<li><p>twist 实际动作是拒绝访问,使用指定操作替换当前服务,标准输出和ERROR</p>
<p> 发送到客户端,默认至/dev/null</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; 	vsftpd: 172.16. :twist /bin/<span class="built_in">echo</span> <span class="string">"connection prohibited"</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<h1 id="PAM模块"><a href="#PAM模块" class="headerlink" title="PAM模块"></a>PAM模块</h1><ol>
<li><p>认证库：文本文件，MySQL，NIS，LDAP等</p>
</li>
<li><p>Sun公司于1995 年开发的一种与认证相关的通用框架机制</p>
</li>
<li><p>PAM 是关注如何为服务验证用户的 API，通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的认证方式分开.使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序</p>
</li>
<li><p>一种认证框架，自身不做认证</p>
</li>
<li><p>它提供了对所有服务进行认证的中央机制，适用于本地登录，远程登录，如：telnet,rlogin,fsh,ftp,点对点协议PPP，su等应用程序中，系统管理员通过PAM配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序中使用PAM API(pam_xxxx( ))来实现对认证方法的调用；而PAM服务模块的开发者则利用PAM SPI来编写模块（主要调用函数pam_sm_xxxx( )供PAM接口库调用，将不同的认证机制加入到系统中；PAM接口库（libpam）则读取配置文件，将应用程序和相应的PAM服务模块联系起来</p>
</li>
</ol>
<h2 id="PAM架构"><a href="#PAM架构" class="headerlink" title="PAM架构"></a>PAM架构</h2><p>  <img src="https://github.com/xiejia1215225/Pictures/blob/master/PAM%E6%9E%B6%E6%9E%84.png?raw=true" alt="PAM架构.png"></p>
<h2 id="PAM相关文件"><a href="#PAM相关文件" class="headerlink" title="PAM相关文件"></a>PAM相关文件</h2><ol>
<li><p>模块文件目录：/lib64/security/*.so</p>
</li>
<li><p>环境相关的设置：/etc/security/</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 bin]<span class="comment">#cd /lib64/security/</span></span><br><span class="line">[root@cetos7 security]<span class="comment">#ls</span></span><br><span class="line">pam_access.so     pam_gdm.so               pam_permit.so          pam_time.so</span><br><span class="line">pam_cap.so        pam_gnome_keyring.so     pam_postgresok.so      pam_timestamp.so</span><br><span class="line">pam_chroot.so     pam_group.so             pam_pwhistory.so       pam_tty_audit.so</span><br><span class="line">pam_console.so    pam_issue.so             pam_pwquality.so       pam_umask.so</span><br><span class="line">pam_cracklib.so   pam_keyinit.so           pam_rhosts.so          pam_unix_acct.so</span><br><span class="line">pam_debug.so      pam_lastlog.so           pam_rootok.so          pam_unix_auth.so</span><br><span class="line">pam_deny.so       pam_limits.so            pam_securetty.so       pam_unix_passwd.so</span><br><span class="line">pam_echo.so       pam_listfile.so          pam_selinux_permit.so  pam_unix_session.so</span><br><span class="line">pam_env.so        pam_localuser.so         pam_selinux.so         pam_unix.so</span><br><span class="line">pam_exec.so       pam_loginuid.so          pam_sepermit.so        pam_userdb.so</span><br><span class="line">pam_faildelay.so  pam_mail.so              pam_shells.so          pam_warn.so</span><br><span class="line">pam_faillock.so   pam_mkhomedir.so         pam_sss.so             pam_wheel.so</span><br><span class="line">pam_filter        pam_motd.so              pam_stress.so          pam_xauth.so</span><br><span class="line">pam_filter.so     pam_namespace.so         pam_succeed_if.so</span><br><span class="line">pam_fprintd.so    pam_nologin.so           pam_systemd.so</span><br><span class="line">pam_ftp.so        pam_oddjob_mkhomedir.so  pam_tally2.so</span><br></pre></td></tr></table></figure>
</li>
<li><p>主配置文件:/etc/pam.conf，默认不存在</p>
</li>
<li><p>为每种应用模块提供一个专用的配置文件：/etc/pam.d/APP_NAME</p>
<p> 注意：如/etc/pam.d存在，/etc/pam.conf将失效pam认证原理</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 security]<span class="comment">#cd /etc/pam.d/</span></span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#ls</span></span><br><span class="line">atd                  gdm-launch-environment  pluto         smartcard-auth     system-auth-ac</span><br><span class="line">chfn                 gdm-password            polkit-1      smartcard-auth-ac  systemd-user</span><br><span class="line">chsh                 gdm-pin                 postlogin     smtp               vlock</span><br><span class="line">config-util          gdm-smartcard           postlogin-ac  smtp.postfix       vmtoolsd</span><br><span class="line">crond                liveinst                ppp           sshd               vsftpd</span><br><span class="line">cups                 login                   remote        su                 xserver</span><br><span class="line">fingerprint-auth     other                   runuser       sudo</span><br><span class="line">fingerprint-auth-ac  passwd                  runuser<span class="_">-l</span>     sudo-i</span><br><span class="line">gdm-autologin        password-auth           screen        su<span class="_">-l</span></span><br><span class="line">gdm-fingerprint      password-auth-ac        setup         system-auth</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="PAM认证原理"><a href="#PAM认证原理" class="headerlink" title="PAM认证原理"></a>PAM认证原理</h2><ol>
<li>PAM认证一般遵循这样的顺序：Service(服务)→PAM(配置文件)→pam_*.so</li>
<li>PAM认证首先要确定那一项服务，然后加载相应的PAM的配置文件(位于/etc/pam.d下)，最后调用认证文件(位于/lib/security下)进行安全认证</li>
</ol>
<h2 id="PAM配置文件详解"><a href="#PAM配置文件详解" class="headerlink" title="PAM配置文件详解"></a>PAM配置文件详解</h2><p>专用配置文件/etc/pam.d/* 格式<br>type control module-path arguments<br>说明：</p>
<h3 id="模块类型（module-type）"><a href="#模块类型（module-type）" class="headerlink" title="模块类型（module-type）"></a>模块类型（module-type）</h3><blockquote>
<p>Auth 账号的认证和授权<br>Account 与账号管理相关的非认证类的功能，如：用来限制/允许用户对某个服务的访问时间，当前有效的系统资源(最多可以有多少个用户)，限制用户的位置(例如：root用户只能从控制台登录)<br>Password 用户修改密码时密码复杂度检查机制等功能<br>Session 用户获取到服务之前或使用服务完成之后需要进行一些附加的操作，如：记录打开/关闭数据的信息，监视目录等<br>-type 表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安装在系统上的模块有用</p>
</blockquote>
<h3 id="Control"><a href="#Control" class="headerlink" title="Control:"></a>Control:</h3><ol>
<li><p>PAM库如何处理与该服务相关的PAM模块成功或失败情况</p>
</li>
<li><p>两种方式实现：简单和复杂</p>
<blockquote>
<blockquote>
<p>简单方式实现：一个关健词实现</p>
<blockquote>
<p>required ：一票否决，表示本模块必须返回成功才能通过认证，但是如果该模块返回失败，失败结果也不会立即通知用户，而是要等到同一type中的所有模块全部执行完毕再将失败结果返回给应用程序，即为必要条件<br>requisite ：一票否决，该模块必须返回成功才能通过认证，但是一旦该模块返回失败，将不再执行同一type内的任何模块，而是直接将控制权返回给应用程序。是一个必要条件<br>sufficient ：一票通过，表明本模块返回成功则通过身份认证的要求，不必再执行同一type内的其它模块，但如果本模块返回失败可忽略，即为充分条件<br>optional ：表明本模块是可选的，它的成功与否不会对身份认证起关键作用，其返回值一般被忽略<br>include： 调用其他的配置文件中定义的配置信息</p>
</blockquote>
</blockquote>
</blockquote>
</li>
</ol>
<blockquote>
<blockquote>
<p>复杂详细实现：使用一个或多个“status=action”<br>[status1=action1 status2=action …]<br>Status:检查结果的返回状态<br>Action:采取行为 ok，done，die，bad，ignore，reset</p>
<blockquote>
<p>ok 模块通过，继续检查<br>done 模块通过，返回最后结果给应用<br>bad 结果失败，继续检查<br>die 结果失败，返回失败结果给应用<br>ignore 结果忽略，不影响最后结果<br>reset 忽略已经得到的结果PAM认证机制</p>
</blockquote>
</blockquote>
</blockquote>
<h3 id="module-path-模块路径"><a href="#module-path-模块路径" class="headerlink" title="module-path: 模块路径"></a>module-path: 模块路径</h3><ol>
<li><p>相对路径：<br> /lib64/security目录下的模块可使用相对路径<br> 如：pam_shells.so、 pam_limits.so</p>
</li>
<li><p>绝对路径：</p>
<p> 模块通过读取配置文件完成用户对系统资源的使用控制</p>
<p> /etc/security/*.conf</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：修改PAM配置文件将马上生效</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">编辑pam规则时，保持至少打开一个root会话，以防止root身份验证错误</span><br></pre></td></tr></table></figure>
<h3 id="Arguments-用来传递给该模块的参数"><a href="#Arguments-用来传递给该模块的参数" class="headerlink" title="Arguments 用来传递给该模块的参数"></a>Arguments 用来传递给该模块的参数</h3></li>
</ol>
<h2 id="PAM模块示例"><a href="#PAM模块示例" class="headerlink" title="PAM模块示例"></a>PAM模块示例</h2><h3 id="模块：pam-shells"><a href="#模块：pam-shells" class="headerlink" title="模块：pam_shells"></a>模块：pam_shells</h3><p>功能：检查有效shell<br>man pam_shells<br>示例：不允许使用/bin/csh的用户进行切换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@cetos7 ~]<span class="comment">#vim /etc/pam.d/su  </span></span><br><span class="line">auth required pam_shells.so  </span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#cat /etc/shells </span></span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/usr/bin/sh</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/usr/sbin/nologin</span><br><span class="line">/bin/tcsh</span><br><span class="line"><span class="comment">#/bin/csh                                 用#把/bin/csh注释掉</span></span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#getent passwd mage</span></span><br><span class="line">mage:x:1242:1244::/home/mage:/bin/bash</span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#usermod -s /bin/csh mage</span></span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#getent passwd mage      </span></span><br><span class="line">mage:x:1242:1244::/home/mage:/bin/csh       把账号xie的shell类型改成 /bin/csh</span><br><span class="line">[root@cetos7 pam.d]<span class="comment">#su - mage</span></span><br><span class="line">Password: </span><br><span class="line">su: Authentication failure                   mage账号将不可切换，其它不受影响 </span><br><span class="line">tail /var/<span class="built_in">log</span>/secure</span><br></pre></td></tr></table></figure>
<h3 id="模块：pam-securetty-so"><a href="#模块：pam-securetty-so" class="headerlink" title="模块：pam_securetty.so"></a>模块：pam_securetty.so</h3><p>功能：只允许root用户在/etc/securetty列出的安全终端上登陆<br>示例：允许root在telnet登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]vim /etc/pam.d/remote  </span><br><span class="line"><span class="comment">#auth required pam_securetty.so #将这一行加上注释  </span></span><br><span class="line">或者/etc/securetty文件中加入  </span><br><span class="line">pts/0,pts/1…pts/n</span><br></pre></td></tr></table></figure>
<h3 id="模块：pam-nologin-so"><a href="#模块：pam-nologin-so" class="headerlink" title="模块：pam_nologin.so"></a>模块：pam_nologin.so</h3><p>功能：</p>
<ol>
<li>如果/etc/nologin文件存在,将导致非root用户不能登陆</li>
<li>如果用户shell是/sbin/nologin 时，当该用户登陆时，会显示/etc/nologin文件内容，并拒绝登陆</li>
</ol>
<h3 id="模块：pam-limits-so"><a href="#模块：pam-limits-so" class="headerlink" title="模块：pam_limits.so"></a>模块：pam_limits.so</h3><p>功能：在用户级别实现对其可使用的资源的限制，例如：可打开的文件数量，可运行的进程数量，可用内存空间<br>修改限制的实现方式：</p>
<ol>
<li><p>ulimit命令，立即生效，但无法保存</p>
<blockquote>
<p>-n 每个进程最多的打开的文件描述符个数<br>-u 最大用户进程数<br>-S 使用 soft（软）资源限制<br>-H 使用 hard（硬）资源限制</p>
</blockquote>
</li>
<li><p>配置文件：/etc/security/limits.conf, /etc/security/limits.d/*.conf<br> 配置文件：每行一个定义</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;domain&gt;  &lt;<span class="built_in">type</span>&gt;  &lt;item&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>\ 应用于哪些对象</p>
<blockquote>
<p>Username 单个用户<br>@group 组内所有用户<br>* 所有用户</p>
</blockquote>
</blockquote>
<blockquote>
<p>\ 限制的类型</p>
<blockquote>
<p>Soft 软限制,普通用户自己可以修改<br>Hard 硬限制,由root用户设定，且通过kernel强制生效<br>- 二者同时限定</p>
</blockquote>
</blockquote>
<blockquote>
<p>\ 限制的资源</p>
<blockquote>
<p>nofile 所能够同时打开的最大文件数量,默认为1024<br>nproc 所能够同时运行的进程的最大数量,默认为1024</p>
</blockquote>
</blockquote>
<blockquote>
<p>\ 指定具体值</p>
<blockquote>
<p>限制用户最多打开的文件数和运行进程数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; /etc/pam.d/system-auth  </span><br><span class="line">&gt; &gt; session required pam_limits.so  </span><br><span class="line">&gt; &gt; </span><br><span class="line">&gt; &gt; vim /etc/security/limits.conf  </span><br><span class="line">&gt; &gt; apache – nofile 10240   用户apache可打开10240个文件  </span><br><span class="line">&gt; &gt; student hard nproc 20   用户student不能运行超过20个进程</span><br><span class="line">&gt; &gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</blockquote>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/浅议linux中的硬链接和软链接/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/浅议linux中的硬链接和软链接/" itemprop="url">浅议linux中的硬链接和软链接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="链接文件的概念"><a href="#链接文件的概念" class="headerlink" title="链接文件的概念"></a>链接文件的概念</h1><p>&ensp;&ensp;&ensp;&ensp;Linux中的链接文件就相当于是Windows中的快捷方式，通过链接文件可以访问到链接指向的源文件。但是Linux下的链接文件和Windows中的快捷方式还是有一定的区别。Linux中有两种链接文件分别为硬链接和软链接（也称为符号链接）。在介绍链接文件之前先要介绍一下Linux文件系统中的inode。</p>
<h1 id="节点的概念"><a href="#节点的概念" class="headerlink" title="节点的概念"></a>节点的概念</h1><p>&ensp;&ensp;&ensp;&ensp;我们都知道文件数据都是储存在硬盘的”块”区域中。那么很显然，我们还必须找一块区域储存文件的元数据信息，比如文件的创建者、文件的创建时间、文件的大小等等，这种存储文件元数据信息的区域就叫做inode，中文译名为”索引节点”</p>
<p>Inode（索引节点）包含有关文件的信息（元数据），具体有如下内容：</p>
<ul>
<li>文件类型，权限，UID，GID  </li>
<li>链接数（指向这个文件名路径名称个数）  </li>
<li>该文件的大小和不同的时间戳  </li>
<li>指向磁盘上文件的数据块指针  </li>
<li>有关文件的其他数据  </li>
</ul>
<p>我们可以使用stat命令来查看某个文件的inode的信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#stat /data/f1</span></span><br><span class="line">  File: ‘/data/f1’</span><br><span class="line">  Size: 0               Blocks: 0          IO Block: 4096   regular empty file</span><br><span class="line">Device: 803h/2051d      Inode: 67          Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Context: unconfined_u:object_r:etc_runtime_t:s0</span><br><span class="line">Access: 2018-09-29 10:34:06.156131723 +0800</span><br><span class="line">Modify: 2018-09-29 10:34:06.156131723 +0800</span><br><span class="line">Change: 2018-09-29 10:34:06.156131723 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure></p>
<p><code>注意：文件名是不存在inode中的！！!</code>  </p>
<p>查看每个硬盘分区的inode总数和使用的数量，可以用<code>df -i</code> 来查看:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#df -i</span></span><br><span class="line">Filesystem       Inodes  IUsed    IFree IUse% Mounted on</span><br><span class="line">/dev/sda2      26214400 122731 26091669    1% /</span><br><span class="line">devtmpfs         229181    397   228784    1% /dev</span><br><span class="line">tmpfs            233163      1   233162    1% /dev/shm</span><br><span class="line">tmpfs            233163    881   232282    1% /run</span><br><span class="line">tmpfs            233163     16   233147    1% /sys/fs/cgroup</span><br><span class="line">/dev/sda1        524288    327   523961    1% /boot</span><br><span class="line">/dev/sda3      15728640      4 15728636    1% /data</span><br><span class="line">tmpfs            233163      9   233154    1% /run/user/42</span><br><span class="line">tmpfs            233163      1   233162    1% /run/user/0</span><br></pre></td></tr></table></figure></p>
<p>空间满了和inode用光了都报<code>No space left on device</code></p>
<p>下图就是磁盘空间占满了提示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#dd if=/dev/zero of=/boot/bigfile bs=1M count=860</span></span><br><span class="line">dd: error writing ‘/boot/bigfile’: No space left on device</span><br><span class="line">850+0 records <span class="keyword">in</span></span><br><span class="line">849+0 records out</span><br><span class="line">890306560 bytes (890 MB) copied, 2.25818 s, 394 MB/s</span><br><span class="line"></span><br><span class="line">[root@localhost data]<span class="comment">#df -h /dev/sda1</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1      1014M 1014M  336K 100% /boot</span><br><span class="line"></span><br><span class="line">[root@localhost data]<span class="comment">#df -i /dev/sda1 </span></span><br><span class="line">Filesystem     Inodes IUsed IFree IUse% Mounted on</span><br><span class="line">/dev/sda1        1184   328   856   28% /boot</span><br></pre></td></tr></table></figure></p>
<p>下图就是inode用光的提示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dir1]<span class="comment">#df -i /dev/sda1</span></span><br><span class="line">Filesystem     Inodes  IUsed IFree IUse% Mounted on</span><br><span class="line">/dev/sda1      524288 524288     0  100% /boot</span><br><span class="line"></span><br><span class="line">也会报</span><br><span class="line">touch: cannot touch ‘f524284’: No space left on device</span><br><span class="line">touch: cannot touch ‘f524285’: No space left on device</span><br><span class="line">touch: cannot touch ‘f524286’: No space left on device</span><br></pre></td></tr></table></figure></p>
<p>每个inode都有一个号码，操作系统用inode号码来识别不同的文件。对于系统来说，文件名只是inode号码便于识别的别称和绰号。表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：首先，系统找到这个文件名对应的inode号码；其次，通过inode号码，获取inode信息；最后，根据inode信息，找到文件所在的block，读出数据。</p>
<p><img src="https://s1.51cto.com/images/20180329/1522294130887366.png" alt="http://s1.51cto.com"></p>
<p>使用<code>ls -i</code>命令，可以看出文件名对应的inode号码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#ls -i /data/f1</span></span><br><span class="line">67 /data/f1</span><br></pre></td></tr></table></figure></p>
<h1 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h1><p>一般情况下，文件名和inode号码是”一一对应”关系，每个inode号码对应一个文件名。但是，Linux系统允许多个文件名指向同一个inode号码。这意味着，可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名;删除一个文件名，不影响另一个文件名的访问。这种情况就被称为:硬链接”(hard link)。可以通过ln命令来创建硬链接：<br>&ensp;&ensp;&ensp;&ensp;ln&ensp; 源文件&ensp; 目标文件   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ls</span></span><br><span class="line">2.txt  f1</span><br><span class="line">[root@localhost data]<span class="comment">#ln 2.txt 22.txt</span></span><br><span class="line">[root@localhost data]<span class="comment">#ls</span></span><br><span class="line">22.txt  2.txt  f1</span><br><span class="line">[root@localhost data]<span class="comment">#ll -i</span></span><br><span class="line">total 8</span><br><span class="line">68 -rw-r--r--. 2 root root 22 Sep 25 15:41 22.txt</span><br><span class="line">68 -rw-r--r--. 2 root root 22 Sep 25 15:41 2.txt</span><br><span class="line">67 -rw-r--r--. 1 root root  0 Sep 25 14:16 f1</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建文件时链接数递增  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ll -i f1</span></span><br><span class="line">67 -rw-r--r--. 1 root root 0 Sep 29 10:34 f1</span><br><span class="line">[root@localhost data]<span class="comment">#ln f1 f11</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll -i f1 f11</span></span><br><span class="line">67 -rw-r--r--. 2 root root 0 Sep 29 10:34 f1</span><br><span class="line">67 -rw-r--r--. 2 root root 0 Sep 29 10:34 f11</span><br></pre></td></tr></table></figure>
</li>
<li><p>不能跨越驱动器或分区  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ln /data/f2 /root/f22</span></span><br><span class="line">ln: failed to create hard link ‘/root/f22’ =&gt; ‘/data/f2’: Invalid cross-device link</span><br></pre></td></tr></table></figure>
</li>
<li><p>不支持文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ln dir1 dir11</span></span><br><span class="line">ln: ‘dir1’: hard link not allowed <span class="keyword">for</span> directory</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="软链接"><a href="#软链接" class="headerlink" title="软链接"></a>软链接</h1><p>除了硬链接以外，还有一种特殊情况。文件A和文件B的incode号码虽然不一样，但是文件A的内容就是文件B的路径。读取文件A时系统会自动将访问者导向文件B。因此，无论打开哪一个文件，最终读取的都是文件B。这时文件A就称为文件B的”软链接”(soft link)或者”符号链接”(symbolic link)可以通过ln -s命令来创建软链接：<br>&ensp;&ensp;&ensp;&ensp;ln -s &ensp;源文件或目录&ensp; 目标文件或目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ll</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 2 root root 22 Sep 25 15:41 22.txt</span><br><span class="line">-rw-r--r--. 2 root root 22 Sep 25 15:41 2.txt</span><br><span class="line">-rw-r--r--. 1 root root  0 Sep 25 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#ln -s 2.txt 2.txt-link</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 2 root root 22 Sep 25 15:41 22.txt</span><br><span class="line">-rw-r--r--. 2 root root 22 Sep 25 15:41 2.txt</span><br><span class="line">lrwxrwxrwx. 1 root root  5 Sep 25 16:01 2.txt-link -&gt; 2.txt</span><br><span class="line">[root@localhost data]<span class="comment">#cat 2.txt</span></span><br><span class="line">学习使我快乐！</span><br><span class="line">[root@localhost data]<span class="comment">#cat 2.txt-link</span></span><br><span class="line">学习使我快乐！</span><br></pre></td></tr></table></figure></p>
<p>指向的是另一个文件的路径<br>其大小为指向的路径字符串的长度<br>不增加或减少目标文件inode的引用计数</p>
<h1 id="硬链接和软链接的区别"><a href="#硬链接和软链接的区别" class="headerlink" title="硬链接和软链接的区别"></a>硬链接和软链接的区别</h1><ol>
<li>是不是同一个文件? <strong><em>这是根本的原因</em></strong> </li>
</ol>
<ul>
<li>硬链接本质上是一个文件，只是有多个名字。</li>
<li>软链接不是同一个文件</li>
</ul>
<ol start="2">
<li>能不能跨分区？</li>
</ol>
<ul>
<li>硬链接不能跨分区</li>
<li>软链接可以跨分区</li>
</ul>
<ol start="3">
<li>链接数是否增长？  </li>
</ol>
<ul>
<li>硬链接的链接数会增加</li>
<li>软链接的链接数不会增加</li>
</ul>
<ol start="4">
<li>inode Number 是否相同？</li>
</ol>
<ul>
<li>硬链接的inode number完全一样</li>
<li>软链接的inode number不一样</li>
</ul>
<ol start="5">
<li>原始文件删除，链接文件可否访问？  </li>
</ol>
<ul>
<li>硬链接：原始文件与链接文件是平级关系，原始文件删除，链接文件可以继续访问。</li>
<li>软链接：原始文件删除，软链接就找不到路径，无法访问</li>
</ul>
<ol start="6">
<li>大小是否一样  </li>
</ol>
<ul>
<li>硬链接的大小就是存储原始文件的大小</li>
<li>软链接的大小就是它指向路径的大小</li>
</ul>
<ol start="7">
<li>支持目录？  </li>
</ol>
<ul>
<li>硬链接不支持目录</li>
<li>软链接支持目录</li>
</ul>
<ol start="8">
<li>相对路径？ </li>
</ol>
<ul>
<li>硬链接：相对路径是相对当前目录的路径</li>
<li>软链接：相对路径是相对软链接的路径</li>
</ul>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/管道和标准IO/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/管道和标准IO/" itemprop="url">标准IO和管道</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="标准输入和输出"><a href="#标准输入和输出" class="headerlink" title="标准输入和输出"></a>标准输入和输出</h1><h2 id="程序：指令-数据"><a href="#程序：指令-数据" class="headerlink" title="程序：指令+数据"></a>程序：指令+数据</h2><ul>
<li>读入数据：Input  </li>
<li>输出数据：Output  <h2 id="打开的文件都有一个fd-file-descriptor-文件描述符"><a href="#打开的文件都有一个fd-file-descriptor-文件描述符" class="headerlink" title="打开的文件都有一个fd: file descriptor (文件描述符)"></a>打开的文件都有一个fd: file descriptor (文件描述符)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#ll /proc/$$/fd</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Oct 28 14:43 0 -&gt; /dev/pts/2</span><br><span class="line">lrwx------ 1 root root 64 Oct 28 14:43 1 -&gt; /dev/pts/2</span><br><span class="line">lrwx------ 1 root root 64 Oct 28 14:43 2 -&gt; /dev/pts/2</span><br><span class="line">lrwx------ 1 root root 64 Oct 28 19:33 255 -&gt; /dev/pts/2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Linux给程序提供三种I-O设备"><a href="#Linux给程序提供三种I-O设备" class="headerlink" title="Linux给程序提供三种I/O设备"></a>Linux给程序提供三种I/O设备</h2><p>标准输入（STDIN） －0 默认接受来自键盘的输入<br>标准输出（STDOUT）－1 默认输出到终端窗口<br>标准错误（STDERR）－2 默认输出到终端窗口  </p>
<h1 id="I-O重定向"><a href="#I-O重定向" class="headerlink" title="I/O重定向"></a>I/O重定向</h1><p>改变文件保存的默认位置  </p>
<h2 id="标准输出和错误输出重定向"><a href="#标准输出和错误输出重定向" class="headerlink" title="标准输出和错误输出重定向"></a>标准输出和错误输出重定向</h2><p>格式: 命令 操作符号 文件名  </p>
<p>支持的操作符号包括:<br>> 把STDOUT重定向到文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ls /data</span></span><br><span class="line">lost+found</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#ls /data &gt; f1.txt   #f1为一空文件</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt</span></span><br><span class="line">lost+found</span><br></pre></td></tr></table></figure></p>
<p>2&gt; 把STDERR重定向到文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ls /error</span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#ls /error 2&gt; f2.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f2.txt </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>&amp;&gt; 把所有输出重定向到文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ls /data /error &amp;&gt;f3.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f3.txt </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">/data:</span><br><span class="line">lost+found</span><br></pre></td></tr></table></figure></p>
<p>> 文件内容会被覆盖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">lost+found</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 123</span></span><br><span class="line">123</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 123 &gt;f1.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">123</span><br></pre></td></tr></table></figure></p>
<p>>&gt; 原有内容基础上，追加内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ls /data &gt;f1.txt </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 123 &gt;&gt;f1.txt </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">lost+found</span><br><span class="line">123</span><br></pre></td></tr></table></figure></p>
<p>2&gt; 覆盖重定向错误输出数据流<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#cat f2.txt </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cdm</span></span><br><span class="line">-bash: cdm: <span class="built_in">command</span> not found</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cdm 2&gt; f2.txt </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f2.txt </span></span><br><span class="line">-bash: cdm: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure></p>
<p>2&gt;&gt; 追加重定向错误输出数据流<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#ls /error 2&gt;&gt; f2.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f2.txt </span></span><br><span class="line">-bash: cdm: <span class="built_in">command</span> not found</span><br><span class="line">ls: cannot access /error: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>set –C 禁止将内容覆盖已有文件,但可追加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">lost+found</span><br><span class="line">123</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#set -C</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 345 &gt; f1.txt </span></span><br><span class="line">-bash: f1.txt: cannot overwrite existing file</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 345 &gt;&gt; f1.txt </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">lost+found</span><br><span class="line">123</span><br><span class="line">345</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>| file 强制覆盖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#echo 345 &gt;|f1.txt </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">345</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>set +C 允许覆盖<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#set +C</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#echo 123&gt;f1.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">123</span><br></pre></td></tr></table></figure></p>
<p>标准输出和错误输出各自定向至不同位置<br>COMMAND &gt; /path/to/file.out 2&gt; /path/to/error.out<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 ~]<span class="comment">#ls /data /error &gt;f1.txt 2&gt;f2.txt</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f1.txt </span></span><br><span class="line">/data:</span><br><span class="line">lost+found</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat f2.txt </span></span><br><span class="line">ls: cannot access /error: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>合并标准输出和错误输出为同一个数据流进行重定向<br> &amp;&gt; 覆盖重定向<br> &amp;&gt;&gt; 追加重定向<br> COMMAND &gt; /path/to/file.out 2&gt;&amp;1 （顺序很重要）<br> COMMAND &gt;&gt; /path/to/file.out 2&gt;&amp;1   </p>
<p> ()：合并多个程序的STDOUT<br>( cal 2007 ; cal 2008 ) &gt; all.txt</p>
<h2 id="重定向的实验："><a href="#重定向的实验：" class="headerlink" title="重定向的实验："></a>重定向的实验：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ll a.txt b.txt 将输出一条标准输出和一条标准错误。</span><br><span class="line">如下：</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#ll a.txt</span></span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt    <span class="comment">#这为内容A</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#ll b.txt</span></span><br><span class="line">ls: cannot access b.txt: No such file or directory   <span class="comment">#这为内容B</span></span><br><span class="line"></span><br><span class="line">下面讨论各种变形的输出结果和原因：</span><br><span class="line">1、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 1&gt;file 2&gt;&amp;1</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file</span></span><br><span class="line">ls: cannot access b.txt: No such file or directory</span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt </span><br><span class="line">file内容A和B 屏幕内容无 （因为标准输出定向到文件，标准错误定向到标准输出，所以也定向到文件）</span><br><span class="line"></span><br><span class="line">2、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 2&gt;&amp;1 1&gt;file</span></span><br><span class="line">ls: cannot access b.txt: No such file or directory</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file </span></span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt</span><br><span class="line">file内容A 屏幕输出B （因为标准错误重定向到了标准输出即屏幕上输出，标准输出定向到文件）</span><br><span class="line"></span><br><span class="line">3、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 2&gt;file 1&gt;&amp;2</span></span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file </span></span><br><span class="line">ls: cannot access b.txt: No such file or directory</span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt </span><br><span class="line">file内容A和B 屏幕内容无（因为标准错误定向到文件，标准输出定向到标准错误，所以也定向到文件）</span><br><span class="line"></span><br><span class="line">4、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 1&gt;&amp;2 2&gt;file</span></span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file </span></span><br><span class="line">ls: cannot access b.txt: No such file or directory </span><br><span class="line">file内容A 屏幕输出B（因为标准输出定向到了标准错误即屏幕，标准错误定向到文件）</span><br><span class="line"></span><br><span class="line">5、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 1&gt;file 1&gt;&amp;2</span></span><br><span class="line">ls: cannot access b.txt: No such file or directory</span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># </span></span><br><span class="line">file内容无 屏幕内容A和B （因为标准输出定向到文件，标准输出又定向的标准错误即屏幕，覆盖了1&gt;file，所以file内容无）</span><br><span class="line"></span><br><span class="line">6、[root@CentOS6 ~]<span class="comment">#ll a.txt b.txt 2&gt;file 2&gt;&amp;1</span></span><br><span class="line">ls: cannot access b.txt: No such file or directory</span><br><span class="line">-rw-r--r--. 1 root root 2 Oct 28 09:04 a.txt</span><br><span class="line">[root@CentOS6 ~]<span class="comment">#cat file </span></span><br><span class="line">[root@CentOS6 ~]<span class="comment"># </span></span><br><span class="line">file内容无 屏幕内容A和B （因为标准错误定向到文件，标准错误又定向到标准输出即屏幕，覆盖了2&gt;file，所以file内容无）</span><br></pre></td></tr></table></figure>
<h2 id="输入重定向"><a href="#输入重定向" class="headerlink" title="输入重定向"></a>输入重定向</h2><p>使用 &lt; 来重定向标准输入  </p>
<ul>
<li><p>某些命令能够接受从文件中导入的STDIN  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tr <span class="string">'a-z'</span> <span class="string">'A-Z'</span>&lt; /etc/issue   <span class="comment"># 该命令会把/etc/issue中的小写字符都转换成写写字符</span></span><br><span class="line">tr -d <span class="string">'abc'</span> &lt; /etc/fstab 删除fstab文件中的所有abc中任意字符</span><br></pre></td></tr></table></figure>
</li>
<li><p>键盘输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; file</span><br><span class="line">mage</span><br><span class="line">wangxiaochun</span><br><span class="line">按ctrl+d离开</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用文件来代替键盘的输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cat &gt; filea &lt; fileb     <span class="comment">#把fileb的文件内容重定向输入到filea中</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>把多行发送给STDIN<br>使用“&lt;&lt;终止词”命令从键盘把多行重导向给STDIN,直到 终止词 位置的所有文本都发送给STDIN<br>有时被称为就地文本（heretext）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mail -s <span class="string">"Please Call"</span> &lt;&lt;END</span><br><span class="line">&gt; Hi,</span><br><span class="line">&gt;</span><br><span class="line">&gt; Please give me a call when you get <span class="keyword">in</span>. We may need</span><br><span class="line">&gt; to <span class="keyword">do</span> some maintenance on server1.</span><br><span class="line">&gt;</span><br><span class="line">&gt; Details when you<span class="string">'re on-site</span></span><br><span class="line"><span class="string">&gt; END</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="tr命令"><a href="#tr命令" class="headerlink" title="tr命令"></a>tr命令</h1><p>转换和删除字符</p>
<p>语法： tr [OPTION]… SET1 [SET2]<br>选项：<br>        -c 或 ——complerment：取代所有不属于第一字符集的字符；<br>        -d 或 ——delete：删除所有属于第一字符集的字符；<br>        -s 或 –squeeze-repeats：把连续重复的字符以单独一个字符表示；<br>        -t 或 –truncate-set1：先删除第一字符集较第二字符集多出的字符。  </p>
<p>[:alnum:]：字母和数字<br>[:alpha:]：字母<br>[:cntrl:]：控制（非打印）字符<br>[:digit:]：数字<br>[:graph:]：图形字符<br>[:lower:]：小写字母<br>[:print:]：可打印字符<br>[:punct:]：标点符号<br>[:space:]：空白字符<br>[:upper:]：大写字母<br>[:xdigit:]：十六进制字符</p>
<p>实例：</p>
<pre><code># echo &quot;TANK&quot; |tr A-Z a-z   #大写字母转小写    
# echo &quot;hello 123 world 456&quot; | tr -d &apos;0-9&apos;  #删除字符串中的数字
# cat text | tr &apos;\t&apos; &apos; &apos;      #将制表符转换成空格
# echo &quot;aa.,a 1 b#$bb 2 c*/cc 3 ddd 4&quot; | tr -dc &apos;0-9 \n&apos;  # 删除除数字外的字符
# tr &apos;[:lower:]&apos; &apos;[:upper:]&apos;     #将小写字符转换成大写字符
</code></pre><h1 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h1><p>连接程序，实现将前一个命令的输出直接定向后一个程序当作输入数据流<br>管道左边的命令必须要有标准输出的功能，管道右边的命令一道要有标准输入功能的否者没有意义。  </p>
<p>管道（使用符号“|”表示）用来连接命令<br>命令1 | 命令2 | 命令3 | …  </p>
<blockquote>
<p>将命令1的STDOUT发送给命令2的STDIN，命令2的STDOUT发送到命令3的STDIN<br>STDERR默认不能通过管道转发，可利用2&gt;&amp;1 或 |&amp; 实现<br>最后一个命令会在当前shell进程的子shell进程中执行用来<br>组合多种工具的功能<br>ls | tr ‘a-z’ ‘A-Z<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">less ：一页一页地查看输入  </span><br><span class="line">ls -l /etc | less</span><br><span class="line">mail： 通过电子邮件发送输入  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"test email"</span> | mail -s <span class="string">"test"</span> user@example.com  </span><br><span class="line">lpr：把输入发送给打印机  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"test print"</span> | lpr -P printer_name</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="重定向到多个目标（tee）"><a href="#重定向到多个目标（tee）" class="headerlink" title="重定向到多个目标（tee）"></a>重定向到多个目标（tee）</h1><p>命令1 | tee [-a ] 文件名 | 命令2<br>把命令1的STDOUT保存在文件中，做为命令2的输入<br>-a 追加</p>
<ul>
<li>使用：<blockquote>
<p>保存不同阶段的输出<br>复杂管道的故障排除<br>同时查看和记录输出  </p>
</blockquote>
</li>
</ul>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><ol>
<li><p>将/etc/issue文件中的内容转换为大写后保存至/tmp/issue.out文件中  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue | tr <span class="string">"[a-z]"</span> <span class="string">"[A-Z]"</span> &gt;/tmp/issue.out</span><br></pre></td></tr></table></figure>
</li>
<li><p>将当前系统登录用户的信息转换为大写后保存至/tmp/who.out文件中 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">who | tr <span class="string">"[a-z]"</span> <span class="string">"[A-Z]"</span> &gt;/tmp/who.out</span><br></pre></td></tr></table></figure>
</li>
<li><p>一个linux用户给root发邮件，要求邮件标题为”help”，邮件正文如下：<br>Hello, I am 用户名,The system version is here,pleasehelp me to check it ,thanks! 操作系统版本信息  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mail -s <span class="string">"root"</span> &lt;&lt;EOF</span><br><span class="line">&gt; hello,i am <span class="variable">$user</span></span><br><span class="line">&gt; The system version is here,please <span class="built_in">help</span> me to check it,thanks!</span><br><span class="line">&gt;cat /etc/centos-release</span><br><span class="line">&gt;EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>将/root/下文件列表，显示成一行，并文件名之间用空格隔开  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /root | tr <span class="string">"\n"</span> <span class="string">" "</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>计算1+2+3+..+99+100的总和  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &#123;1..100&#125; | tr -s <span class="string">" "</span> <span class="string">"+"</span> | bc</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除Windows文本文件中的‘^M’字符  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tr -d <span class="string">"\15"</span> win.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>处理字符串“xt.,l 1 jr#!$mn2 c*/fe3 uz4”，只保留其中的数字和空格 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"xt.,l 1 jr#bcmn2 c*/fe3 uz4"</span> | tr -d <span class="string">"[[:alpha:]]"</span> | tr -d <span class="string">"[[:punct:]]"</span> </span><br><span class="line">或者</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"xt.,l 1 jr#bcmn2 c*/fe3 uz4"</span> |tr -dc <span class="string">"[:digit:][:space:]"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将PATH变量每个目录显示在独立的一行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span> |tr -s <span class="string">":"</span> <span class="string">"\n"</span></span><br><span class="line">``` </span><br><span class="line">9. 将指定文件中0-9分别替代成a-j  </span><br><span class="line">```bash</span><br><span class="line">先创建文件touch f1 </span><br><span class="line">给f1 vim 输入0-9 </span><br><span class="line">cat f1 | tr <span class="string">"[0-9]"</span> <span class="string">"[a-j]"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将文件/etc/centos-release中每个单词（由字母组成）显示在独立一行，并无空行  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/centos-release | tr -s <span class="string">" "</span> <span class="string">"\n"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/Linux用户、组和权限管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="谢 佳">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Linux知识库">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/Linux用户、组和权限管理/" itemprop="url">Linux用户、组和权限管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T01:24:16+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Linux-用户和用户组基础概念"><a href="#Linux-用户和用户组基础概念" class="headerlink" title="Linux 用户和用户组基础概念"></a>Linux 用户和用户组基础概念</h1><p>&ensp;&ensp;&ensp;&ensp; Linux系统是一个多用户多任务的分时操作系统，任何一个要使用系统资源的用户，都必须首先向系统管理员申请一个账号，然后以这个账号的身份进入系统。</p>
<h2 id="用户、用户组的类别："><a href="#用户、用户组的类别：" class="headerlink" title="用户、用户组的类别："></a>用户、用户组的类别：</h2><ul>
<li><p>用户user  </p>
<blockquote>
<p>Linux用户： Username/UID  </p>
<blockquote>
<p>管理员： root, 0<br>普通用户： 1-60000 自动分配  </p>
<blockquote>
<p>系统用户： 1-499, 1-999 （CentOS7） 对守护进程获取资源进行权限分配<br>登录用户： 500+, 1000+（CentOS7）通过交互式方式登录  </p>
</blockquote>
</blockquote>
</blockquote>
</li>
<li><p>组group  </p>
<blockquote>
<p>Linux组： Groupname/GID  </p>
<blockquote>
<p>管理员组： root, 0<br>普通组：  </p>
<blockquote>
<p>系统组： 1-499, 1-999（centos7）<br>普通组： 500+, 1000+（centos7）  </p>
</blockquote>
</blockquote>
</blockquote>
</li>
</ul>
<p>对于一个用户而言可以有不同的组，分别称为用户的基本组（主组）和附加组；基本组组名与用户名相同，且仅包含一个用户，也叫私有组。基本组以外的的组属于用户的附加组。  </p>
<p><code>判断用户和组是不是管理员，不是根据名字叫root来判断的，而是根据UID和GID是不是等于0来判断的。等于0则为管理员，否则则不是。</code></p>
<h2 id="用户配置文件"><a href="#用户配置文件" class="headerlink" title="用户配置文件"></a>用户配置文件</h2><ul>
<li><p>用户及其属性信息(名称、 UID、主组ID等）：/etc/passwd</p>
</li>
<li><p>组及其属性信息：/etc/group</p>
</li>
<li><p>用户密码及相关属性：/etc/shadow</p>
</li>
<li><p>组密码及相关属性：/etc/gshadow</p>
</li>
</ul>
<h2 id="etc-passwd"><a href="#etc-passwd" class="headerlink" title="/etc/passwd"></a>/etc/passwd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#cat /etc/passwd</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br></pre></td></tr></table></figure>
<p>/etc/passwd中一行记录对应着一个用户，每行记录又被冒号(:)分隔为7个字段：</p>
<ul>
<li>用户名:口令:UID:GID:注释性描述:主目录:登录Shell类型</li>
</ul>
<p>系统中有一类用户称为系统用户，这些用户在/etc/passwd文件中也占有一条记录，但是不能登录，因为它们的登录Shell为空。它们的存在主要是方便系统管理，满足相应的系统进程对文件属主的要求.<br>系统用户含义:<br>bin 拥有可执行的用户命令文件<br>sys 拥有系统文件<br>adm 拥有帐户文件<br>uucp UUCP使用<br>lp lp或lpd子系统使用<br>nobody NFS使用  </p>
<h2 id="etc-group"><a href="#etc-group" class="headerlink" title="/etc/group"></a>/etc/group</h2><p>当一个用户同时是多个组中的成员时，在/etc/passwd文件中记录的是用户所属的主组，也就是登录时所属的默认组，而其他组称为附加组。</p>
<p>用户要访问属于附加组的文件时，必须首先使用newgrp命令使自己成为所要访问的组中的成员。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#cat /etc/group</span></span><br><span class="line">root:x:0:</span><br><span class="line">bin:x:1:</span><br><span class="line">daemon:x:2:</span><br><span class="line">sys:x:3:</span><br><span class="line">adm:x:4:</span><br><span class="line">tty:x:5:</span><br><span class="line">disk:x:6:</span><br><span class="line">lp:x:7:</span><br></pre></td></tr></table></figure></p>
<p>此文件的格式也类似于/etc/passwd文件，由冒号(:)隔开若干个字段，这些字段有：</p>
<ul>
<li>组名:口令:组标识号:组内用户列表</li>
</ul>
<p>组名:是用户组的名称，由字母或数字构成。与/etc/passwd中的登录名一样，组名不应重复。<br>口令:字段存放的是用户组加密后的口令字。<br>组标识号:与用户标识号类似，也是一个整数，被系统内部用来标识组。<br>组内用户列表:是属于这个组的所有用户的列表，不同用户之间用逗号(,)分隔。这个用户组可能是用户的主组，也可能是附加组</p>
<h2 id="etc-shadow"><a href="#etc-shadow" class="headerlink" title="/etc/shadow"></a>/etc/shadow</h2><p>/etc/shadow文件用于单独存放加密后的口令字，只有超级用户才拥有该文件读权限<br><code>注意：/etc/shadow中的记录行与/etc/passwd中的一一对应，它由pwconv命令根据/etc/passwd中的数据自动产生</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#cat /etc/shadow</span></span><br><span class="line">root:<span class="variable">$6</span><span class="variable">$9T5n</span>/VcnCXrseL/f<span class="variable">$Nqs3zA</span>.hfJPXIrNtuiyUD9Ps6s.aGC.XYPrABjgPPABgvRIyMntuEkw2All7VhDQd5XM3AiN2RqAdwuoUfJ0K1::0:99999:7:::</span><br><span class="line">bin:*:17632:0:99999:7:::</span><br><span class="line">daemon:*:17632:0:99999:7:::</span><br><span class="line">adm:*:17632:0:99999:7:::</span><br><span class="line">lp:*:17632:0:99999:7:::</span><br></pre></td></tr></table></figure></p>
<p>它的文件格式与/etc/passwd类似，由若干个字段组成，字段之间用”:”隔开。这些字段是：</p>
<ul>
<li>登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志<br><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E5%AF%86%E7%A0%81%E6%9C%9F%E9%99%90.jpg?raw=true" alt=""></li>
</ul>
<p>登录名:/etc/passwd文件中的登录名相一致的用户账号<br>口令:字段存放的是加密后的用户口令字，长度为13个字符。如果为空，则对应用户没有口令，登录时不需要口令；<br>最后一次修改时间:表示的是从某个时刻起，到用户最后一次修改口令时的天数<br>最小时间间隔:指的是两次修改口令之间所需的最小天数<br>最大时间间隔:指的是口令保持有效的最大天数<br>警告时间:字段表示的是从系统开始警告用户到用户密码正式失效之间的天数<br>不活动时间:表示的是用户没有登录活动但账号仍能保持有效的最大天数<br>失效时间:字段给出的是一个绝对的天数，如果使用了这个字段，那么就给出相应账号的生存期。期满后，该账号就不再是一个合法的账号，也就不能再用来登录了。  </p>
<h2 id="etc-gshadow"><a href="#etc-gshadow" class="headerlink" title="/etc/gshadow"></a>/etc/gshadow</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#cat /etc/gshadow</span></span><br><span class="line">root:::</span><br><span class="line">bin:::</span><br><span class="line">daemon:::</span><br><span class="line">sys:::</span><br><span class="line">adm:::</span><br><span class="line">tty:::</span><br><span class="line">disk:::</span><br><span class="line">lp:::</span><br></pre></td></tr></table></figure>
<p>它的文件格式与/etc/group类似，由若干个字段组成，字段之间用”:”隔开。这些字段是：<br>群组名称：就是群组名称<br>群组密码：<br>组管理员列表：组管理员的列表，更改组密码和成员<br>以当前组为附加组的用户列表： (分隔符为逗号)</p>
<h1 id="用户和组的管理命令"><a href="#用户和组的管理命令" class="headerlink" title="用户和组的管理命令"></a>用户和组的管理命令</h1><p>用户管理命令  </p>
<blockquote>
<p>useradd(创建用户)<br>usermod(修改用户)<br>userdel(删除用户)</p>
</blockquote>
<p>组管理命令  </p>
<blockquote>
<p>groupadd(创建组)<br>groupmod(修改组)<br>groupdel(删除组)</p>
</blockquote>
<p>密码配置命令  </p>
<blockquote>
<p>passwd(设置用户密码)<br>gpasswd（设置组密码）</p>
</blockquote>
<h2 id="用户创建-useradd"><a href="#用户创建-useradd" class="headerlink" title="用户创建:useradd"></a>用户创建:useradd</h2><ul>
<li>useradd  [options] LOGIN  </li>
</ul>
<p>-u UID:用户ID的数字值。此值必须为唯一的，除非使用了-o选项。此值必须非负，默认使用大于等于UID_MIN，且大于任何其他用户ID最小值<br>-o 配合-u 选项，不检查UID的唯一性<br>-g GID：指明用户所属基本组，可为组名，也可以GID<br>-c “COMMENT”：用户的注释信息<br>-d HOME_DIR: 以指定的路径(不存在)为家目录<br>-s SHELL: 指明用户的默认shell程序，可用列表在/etc/shells文件中<br>-G GROUP1[,GROUP2,…]：为用户指明附加组，组须事先存在<br>-N 不创建私用组做主组，使用users组做主组<br>-r 创建系统用户 CentOS 6: ID&lt;500， CentOS 7: ID&lt;1000<br>-m 创建家目录，用于系统用户<br>-M 不创建家目录，用于非系统用户   </p>
<p>useradd -D：显示创建用户时的默认设置；<br>useradd -D  选项：设置某默认选项；  </p>
<p>例1：创建一个用户sam，为sam指定主目录为/usr/sam<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -d /usr/sam sam</span><br></pre></td></tr></table></figure></p>
<p>例2：创建用户gentoo，附加组为bin和root，默认shell为/bin/csh，注释信息为<br>“Gentoo Distribution”<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -c <span class="string">"Gentoo Distribution"</span> -G bin,root -s /bin/csh gentoo</span><br></pre></td></tr></table></figure></p>
<p>例3:新建用户gem，指定该用户的登录Shell是 /bin/sh，指定它属于group用户组，同时又属于adm和root用户组，其中group用户组是其主组。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd group</span><br><span class="line">groupadd adm</span><br><span class="line">useradd -s /bin/sh -g group –G <span class="string">"adm,root"</span> gem</span><br></pre></td></tr></table></figure></p>
<p>例4:创建下面的用户、组和组成员关系<br>名字为webs 的组<br>用户nginx 使用webs 作为附属组<br>用户varnish，也使用webs 作为附属组<br>用户mysql，不可交互登录系统，且不是webs 的成员， nginx， varnish，mysql密码都是magedu<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">groupadd webs</span><br><span class="line">useradd nginx -G webs</span><br><span class="line">useradd varnish -G webs</span><br><span class="line">useradd mysql -s /sbin/nologin</span><br><span class="line"><span class="built_in">echo</span> magedu | passwd --stdin nginx</span><br><span class="line"><span class="built_in">echo</span> magedu | passwd --stdin varnish</span><br><span class="line"><span class="built_in">echo</span> magedu | passwd --stdin mysql</span><br></pre></td></tr></table></figure></p>
<h2 id="用户属性修改-usermod"><a href="#用户属性修改-usermod" class="headerlink" title="用户属性修改:usermod"></a>用户属性修改:usermod</h2><p><code>注意：usermod不允许改变正在线上的使用者帐号名称。当usermod改变userID,必须确认这名user没在电脑上执行任何程序</code>  </p>
<ul>
<li>usermod [OPTION] login<br>-u UID: 新UID<br>-g GID: 新主组<br>-G GROUP1[,GROUP2,…[,GROUPN]]]：新附加组，原来的附加组将会被覆盖；若保留原有，则要同时使用-a选项<br>-s SHELL：新的默认SHELL<br>-c ‘COMMENT’：新的注释信息<br>-d HOME: 新家目录不会自动创建；若要创建新家目录并移动原家数据，同时使用-m选项<br>-l login_name: 新的名字<br>-L: lock指定用户,在/etc/shadow 密码栏的增加 !<br>-U: unlock指定用户,将 /etc/shadow 密码栏的 ! 拿掉<br>-e YYYY-MM-DD: 指明用户账号过期日期<br>-f INACTIVE: 设定非活动期限  </li>
</ul>
<h2 id="删除用户-userdel"><a href="#删除用户-userdel" class="headerlink" title="删除用户:userdel"></a>删除用户:userdel</h2><ul>
<li>userdel [OPTION]… login<br>-r：用户主目录中的文件将随用户主目录和用户邮箱一起删除</li>
</ul>
<h2 id="创建组-groupadd"><a href="#创建组-groupadd" class="headerlink" title="创建组:groupadd"></a>创建组:groupadd</h2><ul>
<li>groupadd [OPTION]… group_name<br>-g GID :指明GID,默认是上一个组的GID+1<br>-r:创建系统组，默认为1-999数字  </li>
</ul>
<h2 id="修改和删除组"><a href="#修改和删除组" class="headerlink" title="修改和删除组"></a>修改和删除组</h2><blockquote>
<p>组属性修改:groupmod  </p>
<ul>
<li>groupmod [OPTION]… group<br>-n group_name: 新名字<br>-g GID: 新的GID  </li>
</ul>
</blockquote>
<blockquote>
<p>组删除：groupdel<br>groupdel GROUP</p>
</blockquote>
<h2 id="passwd：密码设置常用命令"><a href="#passwd：密码设置常用命令" class="headerlink" title="passwd：密码设置常用命令"></a>passwd：密码设置常用命令</h2><p><code>以下命令只有root才有权限操作</code><br>passwd：修改自己的密码<br>passwd  username：修改其它用户的密码<br>-d：删除指定用户密码<br>-l： 锁定指定用户<br>-e：强制用户下次登录修改密码<br>-f：强制操作<br>-n mindays：指定最短使用期限<br>-x maxdays： 最大使用期限<br>-w warndays：提前多少天开始警告<br>-i inactivedays：非活动期限<br>–stdin：从标准输入接收用户密码<br>echo “PASSWORD” | passwd –stdin USERNAME<br>​                           </p>
<h2 id="更改组密码-gpasswd"><a href="#更改组密码-gpasswd" class="headerlink" title="更改组密码:gpasswd"></a>更改组密码:gpasswd</h2><ul>
<li>gpasswd [OPTION] GROUP<br>-a UserName：把用户添加至组中<br>-d UserName：从此组中移除此用户；</li>
<li>newgrp命令：登录到一个新组   </li>
<li>chage命令：修改用户账号的各种期限；修改账户或口令的期限设定<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 口令最短使用期限7天，最长使用期限30天，警告期3天，非活动期3天。          </span><br><span class="line">[root@localhost ~]<span class="comment"># chage -m7 -M30 -W3 -I3 mageedu          </span></span><br><span class="line">2. 修改口令最近一次修改时间，需转换为设定时间到1970年1月1日的天数          </span><br><span class="line">[root@localhost ~]<span class="comment"># chage -d16860 mageedu          </span></span><br><span class="line">3. 设置账户过期时间，需转换为设定时间到1970年1月1日的天数。          </span><br><span class="line">[root@localhost ~]<span class="comment"># chage -E16920 mageedu</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>chsh：更换登入系统时使用的shell,</p>
<p>chfn：提供使用者更改个人资讯,</p>
<p>finger：使用者查询一些其他使用者的资料,</p>
<p>pwck : 检查密码文件的完整性, </p>
<p>grpck：检查组文件的完整性</p>
<h2 id="su：切换用户"><a href="#su：切换用户" class="headerlink" title="su：切换用户"></a>su：切换用户</h2><ol>
<li>不读取目标用户的配置文件,不改变当前工作目录（非登录式切换，半切换)<br>su  UserName   </li>
<li>读取目标用户的配置文件,切换至家目录（登录式切换，完全切换)<br>su  -  UserName  </li>
<li>仅以指定的用户的身份运行此处指定的命令，而不执行真正的身份切换操作<br>su [-] UserName -c ‘COMMAND’<br><code>注意：root切换至任何其它用户无须认证密码；普通用户切换至其它用户，都需要密码</code>  </li>
</ol>
<h1 id="用户和用户组权限管理"><a href="#用户和用户组权限管理" class="headerlink" title="用户和用户组权限管理"></a>用户和用户组权限管理</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#ll -d /etc       # 显示文件名与相关属性命令</span></span><br><span class="line">drwxr-xr-x. 137 root root 12288 Oct 21 09:57 /etc</span><br></pre></td></tr></table></figure>
<ol>
<li>类型和权限(permission)：</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7.png?raw=true" alt=""><br>显示格式：</p>
<ul>
<li>类型和权限  连接数  所有者   用户组   文件大小  修改日期   文件名</li>
</ul>
<ol start="2">
<li>权限组合机制：(8bites 二进制)</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90.jpg?raw=true" alt=""></p>
<p>第二道十个字符：每三个为一组，均为’rwx’三个参数组合<br>rwxrwxrwx每个位置固定不定，若无则为空，用’-‘符号表示</p>
<p>r：readable, 读；w：writable, 写；x：excutable，执行</p>
<p>r=4    w=2   x=1 -=0</p>
<ol start="3">
<li>文件权限系统主要分为3类用户：</li>
</ol>
<p>属主：owner,u          属组：group,g       其他：other,o</p>
<p>其与之对应的权限:<br>​     rwx                rwx                     rwx</p>
<ol start="4">
<li>文件和目录的权限管理：</li>
</ol>
<p>对于文件的含义:  </p>
<blockquote>
<p>r：可获取文件的数据；可以使用类似于cat命令查看文件内容</p>
</blockquote>
<blockquote>
<p>w: 可修改文件的数据；可以编或者删除此文件</p>
</blockquote>
<blockquote>
<p>x：可将此文件运行为进程；可以在命令提示符下当做命令提交给内核运行</p>
</blockquote>
<p>对于目录的含义:</p>
<blockquote>
<p>r：可使用ls命令获取其下的所有文件列表；</p>
</blockquote>
<blockquote>
<p>w: 可修改此目录下的文件列表；即创建或删除文件；</p>
</blockquote>
<blockquote>
<p>x: 可cd至此目录中，且可使用ls -l来获取所有文件的详细属性信息；</p>
</blockquote>
<blockquote>
<p>X: 只针对目录添加x权限，不对目录下的文件添加x权限；</p>
</blockquote>
<h1 id="权限管理命令"><a href="#权限管理命令" class="headerlink" title="权限管理命令"></a>权限管理命令</h1><h2 id="chmod-更改文件目录权限"><a href="#chmod-更改文件目录权限" class="headerlink" title="chmod:更改文件目录权限"></a>chmod:更改文件目录权限</h2><p>用户类型：u：属主   g：属组   o：其它    a: 所有</p>
<p>chmod [OPTION]…  MODE[,MODE]… FILE…  </p>
<ol>
<li><p>赋权表示法：直接操作一类用户的所有权限位rwx<br>用等号表示：[u|g|o|a]=rwx中的一位或者多位 </p>
</li>
<li><p>授权表示法：直接操作一类用户的一个权限位r,w,x<br>用加减号表示：[u|g|o|a][+|-]rwx  </p>
</li>
</ol>
<p>chmod [OPTION]…  OCTAL-MODE FILE…<br>直接使用三位数字的方式给文件目录增加权限，分别表示所有者、所属组、其他人的权限<br>数字的表示方法同上：8bites 二进制表示权限的组合机制<br>r=4   w=2   x=1  三位相加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 data]<span class="comment">#ll</span></span><br><span class="line">--w-------. 1 root root     0 Oct 21 20:29 f1</span><br><span class="line">[root@CentOS6 data]<span class="comment">#chmod 666 f1    #对 (u g o)添加读写权限</span></span><br><span class="line">[root@CentOS6 data]<span class="comment">#ll</span></span><br><span class="line">-rw-rw-rw-. 1 root root     0 Oct 21 20:29 f1</span><br></pre></td></tr></table></figure></p>
<p>chmod [OPTION]…  –reference=RFILE FILE…   参照某个文件的权限来进行授权操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 data]<span class="comment">#ll</span></span><br><span class="line">--w-------. 1 root root     0 Oct 21 20:29 f1</span><br><span class="line">-rw-r--r--. 1 root root     0 Oct 21 21:20 f2</span><br><span class="line">-rw-r--r--. 1 root root     0 Oct 21 21:20 f3</span><br><span class="line">[root@CentOS6 data]<span class="comment">#chmod --reference=f1 f2 f3</span></span><br><span class="line">[root@CentOS6 data]<span class="comment">#ll</span></span><br><span class="line">--w-------. 1 root root     0 Oct 21 20:29 f1</span><br><span class="line">--w-------. 1 root root     0 Oct 21 21:20 f2</span><br><span class="line">--w-------. 1 root root     0 Oct 21 21:20 f3</span><br></pre></td></tr></table></figure></p>
<p><code>注意：普通用户仅能修改属主为自己的那些文件的权限；root可以更改所有用户</code></p>
<h2 id="chown-更改文件目录的所有者，也可以更改所属组"><a href="#chown-更改文件目录的所有者，也可以更改所属组" class="headerlink" title="chown:更改文件目录的所有者，也可以更改所属组"></a>chown:更改文件目录的所有者，也可以更改所属组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-rw-rw-. 1 root root     0 Oct 21 20:29 f1</span><br><span class="line">[root@CentOS6 data]<span class="comment">#chown xie f1</span></span><br><span class="line">[root@CentOS6 data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-rw-rw-. 1 xie root 0 Oct 21 20:29 f1</span><br></pre></td></tr></table></figure>
<ol>
<li>chgrp [OPTION]… GROUPFILE… 更改所属组<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS6 data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-rw-rw-. 1 xie root 0 Oct 21 20:29 f1</span><br><span class="line">[root@CentOS6 data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-rw-rw-. 1 xie rpc 0 Oct 21 20:29 f1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><code>注意：</code></p>
<ol>
<li>普通用户是不能更改文件的所有者的</li>
<li>作为普通用户，要想更改文件的所属组：  <blockquote>
<p>文件是普通用户它自己的<br>如果要更改的组，普通用户必须在这个组里</p>
</blockquote>
</li>
</ol>
<h2 id="umask-文件的权限反向掩码，遮罩码"><a href="#umask-文件的权限反向掩码，遮罩码" class="headerlink" title="umask:文件的权限反向掩码，遮罩码"></a>umask:文件的权限反向掩码，遮罩码</h2><ol>
<li>umask：查看当前umask<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#umask</span></span><br><span class="line">0022</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>系统默认为：0022 表示特殊权限、所有者权限、所有组权限、其他人权限<br>更改默认设置位置：/etc/bashrc </p>
<ol start="2">
<li>对文件目录的umask操作 <blockquote>
<p>文件：666-umask 文件默认不能拥有执行权限;如果减得的结果中有执行权限，则需要将其加1<br>文件夹：777-umask</p>
</blockquote>
</li>
</ol>
<h1 id="Linux文件系统上的特殊权限"><a href="#Linux文件系统上的特殊权限" class="headerlink" title="Linux文件系统上的特殊权限"></a>Linux文件系统上的特殊权限</h1><h2 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h2><p>功能：继承二进制程序所有者的权限<br>权限设定：<br>chmod u+s file…<br>chmod u-s file…<br>chmod 4### file…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-r--r--. 1 root root 595 Oct 14 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#chmod  u+s f1</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rwSr--r--. 1 root root 595 Oct 14 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#chmod u-s f1</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-r--r--. 1 root root 595 Oct 14 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#chmod 4644 f1</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll f1        </span></span><br><span class="line">-rwSr--r--. 1 root root 595 Oct 14 14:16 f1</span><br></pre></td></tr></table></figure></p>
<p>SUID只对二进制可执行程序有效<br>SUID设置在目录上无意义</p>
<h2 id="SGID"><a href="#SGID" class="headerlink" title="SGID"></a>SGID</h2><ol>
<li><p>可执行文件上SGID权限<br>功能：继承二进制程序所有组的权限<br>权限设定：<br>chmod g+s file…<br>chmod g-s file…<br>chmod 2### file…  </p>
</li>
<li><p>目录上的SGID权限<br>功能：此目录新建的文件继承目录的所属组<br>权限设定：<br>chmod g+s dir…<br>chmod g-s dir…<br>chmod 2### dir…  </p>
</li>
</ol>
<h2 id="Sticky位"><a href="#Sticky位" class="headerlink" title="Sticky位"></a>Sticky位</h2><p>功能：作用于目录，此目录的文件只能被所有者或root删除<br>权限设定:<br>chmod o+t dir…<br>chmod o-t dir…<br>chmod 1### dir…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment">#ll -d /tmp</span></span><br><span class="line">drwxrwxrwt. 15 root root 4096 Oct 23 18:33 /tmp</span><br></pre></td></tr></table></figure></p>
<h2 id="权限位映射"><a href="#权限位映射" class="headerlink" title="权限位映射"></a>权限位映射</h2><p>SUID: user,占据属主的执行权限位<br>s： 属主拥有x权限<br>S：属主没有x权限<br>SGID: group,占据属组的执行权限位<br>s： group拥有x权限<br>S： group没有x权限<br>Sticky: other,占据other的执行权限位<br>t： other拥有x权限<br>T： other没有x权限  </p>
<h1 id="访问控制列表"><a href="#访问控制列表" class="headerlink" title="访问控制列表"></a>访问控制列表</h1><p>ACL： Access Control List，实现灵活的权限管理<br>除了文件的所有者，所属组和其它人，可以对更多的用户设置权限<br>CentOS7 默认创建的xfs和ext4文件系统具有ACL功能<br>CentOS7 之前版本，默认手工创建的ext4文件系统无ACL功能,需手动增加<br>tune2fs –o acl /dev/sdb1<br>mount –o acl /dev/sdb1 /mnt/test<br>ACL生效顺序：所有者，自定义用户，自定义组，其他人</p>
<ol>
<li>常见的一些命令<br>setfacl -m u:username:rwx file  为用户的文件赋予访问权限rwx<br>setfacl -m g:groupname:rw file  为组的文件赋予访问权限rwx<br>getfacl filename  查看设置的acl权限<br>setfacl -b filename 清空acl权限<br>setfacl -k dir 删除默认ACL权限<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-r--r--. 1 root root 595 Oct 14 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#setfacl -m u:xie:rw f1</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-rw-r--+ 1 root root 595 Oct 14 14:16 f1  <span class="comment"># +代表有acl权限</span></span><br><span class="line">[root@localhost data]<span class="comment">#getfacl f1</span></span><br><span class="line"><span class="comment"># file: f1</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rw-</span><br><span class="line">user:xie:rw-</span><br><span class="line">group::r--</span><br><span class="line">mask::rw-</span><br><span class="line">other::r--</span><br><span class="line">[root@localhost data]<span class="comment">#setfacl -b f1</span></span><br><span class="line">[root@localhost data]<span class="comment">#ll f1</span></span><br><span class="line">-rw-r--r--. 1 root root 595 Oct 14 14:16 f1</span><br><span class="line">[root@localhost data]<span class="comment">#getfacl f1</span></span><br><span class="line"><span class="comment"># file: f1</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rw-</span><br><span class="line">group::r--</span><br><span class="line">other::r--</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><ol>
<li><p>当用户docker对/testdir 目录无执行权限时，意味着无法做哪些操作？<br>答:无法cd至此目录中；无法查看目录的详细属性；无法查看文件的内容；</p>
</li>
<li><p>当用户mongodb对/testdir 目录无读权限时，意味着无法做哪些操作？<br>答:可使用ls命令获取其下的所有文件列表</p>
</li>
<li><p>当用户redis 对/testdir 目录无写权限时，该目录下的只读文件file1是否可<br>修改和删除？<br>答:不行，文件能不能删除由目录的权限决定的。（rw）</p>
</li>
<li><p>当用户zabbix对/testdir 目录有写和执行权限时，该目录下的只读文件file1<br>是否可修改和删除？<br>答:可以</p>
</li>
<li><p>复制/etc/fstab文件到/var/tmp下，设置文件所有者为tomcat读写权限，所<br>属组为apps组有读写权限，其他人无权限  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useradd tomcat</span><br><span class="line">groupadd apps</span><br><span class="line">cp /etc/fstab /var/tmp</span><br><span class="line">chown tomcat /var/tmp/fstab</span><br><span class="line">chgrp apps /var/tmp/fstab</span><br><span class="line">chmod 660 /var/tmp/fstab</span><br></pre></td></tr></table></figure>
</li>
<li><p>误删除了用户git的家目录，请重建并恢复该用户家目录及相应的权限属性  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">useradd git</span><br><span class="line">rm -rf /home/git</span><br><span class="line">mkdir /home/git</span><br><span class="line">cp -a /etc/skel/.[^.]* /home/git</span><br><span class="line">chown -R git.git /home/git</span><br><span class="line">chmod 700 /home/git</span><br></pre></td></tr></table></figure>
</li>
<li><p>在/testdir/dir里创建的新文件自动属于webs组，组apps的成员如：<br>tomcat能对这些新文件有读写权限，组dbs的成员如： mysql只能对新文件有读权限，其它用户（不属于webs,apps,dbs）不能访问这个文件夹  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir     -p     /testdir/dir</span><br><span class="line">groupadd webs</span><br><span class="line">chgrp     webs   /testdir/dir</span><br><span class="line">chmod    g+s     /testdir/dir </span><br><span class="line">groupadd apps  </span><br><span class="line">groupadd dbs</span><br><span class="line">useradd -G apps tomcat</span><br><span class="line">useradd -G dbs mysql</span><br><span class="line">setfacl -m g:apps:rw /testdir/dir/</span><br><span class="line">setfacl -m g:dbs:r /testdir/dir/</span><br><span class="line">chmod o= /testdir/dir</span><br></pre></td></tr></table></figure>
</li>
<li><p>备份/testdir/dir里所有文件的ACL权限到/root/acl.txt中，清除/testdir/dir中所有ACL权限，最后还原ACL权限  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getfacl -R /testdir/dir &gt; /root/acl.txt </span><br><span class="line">setfacl -b /testdir/dir</span><br><span class="line">setfacl -R –<span class="built_in">set</span>-file=acl.txt /testdir/dir</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://github.com/xiejia1215225/Pictures/blob/master/Linux%E6%A0%87%E5%BF%97.jpg?raw=true" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">谢 佳</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/auto.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">谢 佳</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
